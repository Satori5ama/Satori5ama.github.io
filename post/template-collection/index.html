<!doctype html><html lang=en data-theme-mode=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>板子合集（自用） | Satori5ama</title><meta name=description content="我们称之为路的，其实不过是彷徨。"><script>window.siteConfig=JSON.parse('{"anchor_icon":null,"base":"https://username.github.io/","clipboard":{"copyright":{"count":50,"enable":false,"license_type":"by-nc-sa"},"fail":{"en":"Copy failed (ﾟ⊿ﾟ)ﾂ","ja":"コピー失敗 (ﾟ⊿ﾟ)ﾂ","pt-br":"Falha ao copiar (ﾟ⊿ﾟ)ﾂ","zh-cn":"复制失败 (ﾟ⊿ﾟ)ﾂ","zh-tw":"複製失敗 (ﾟ⊿ﾟ)ﾂ"},"success":{"en":"Copy successfully (*^▽^*)","ja":"コピー成功 (*^▽^*)","pt-br":"Copiado com sucesso (*^▽^*)","zh-cn":"复制成功 (*^▽^*)","zh-tw":"複製成功 (*^▽^*)"}},"code_block":{"expand":true},"i18n_languages":[{"Lang":"en","LanguageName":"English","LanguageCode":"","Title":"","LanguageDirection":"","Weight":1,"Disabled":false},{"Lang":"zh-cn","LanguageName":"简体中文","LanguageCode":"","Title":"","LanguageDirection":"","Weight":2,"Disabled":false},{"Lang":"zh-tw","LanguageName":"繁體中文","LanguageCode":"","Title":"","LanguageDirection":"","Weight":3,"Disabled":false},{"Lang":"ja","LanguageName":"日本語","LanguageCode":"","Title":"","LanguageDirection":"","Weight":4,"Disabled":false}],"icon_font":"4552607_4k4bc36ef96","outdate":{"daysago":180,"enable":false,"message":{"en":"This article was last updated on {time}. Please note that the content may no longer be applicable.","ja":"この記事は最終更新日：{time}。記載内容が現在有効でない可能性がありますのでご注意ください。","pt-br":"Este artigo foi atualizado pela última vez em {time}. Observe que o conteúdo pode não ser mais aplicável.","zh-cn":"本文最后更新于 {time}，请注意文中内容可能已不适用。","zh-tw":"本文最後更新於 {time}，請注意文中內容可能已不適用。"}}}')</script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap" media=print onload='this.media="all"'><link rel=preload href=//at.alicdn.com/t/c/font_4552607_4k4bc36ef96.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=stylesheet href=/css/loader.min.ac746e154f756f8220326eeb52a719f142ab038be5a8ddf30ea5ef15ef2356ea.css><meta property="og:type" content="website"><meta property="og:title" content="板子合集（自用） | Satori5ama"><meta property="og:description" content="我们称之为路的，其实不过是彷徨。"><meta property="og:url" content="https://username.github.io/post/template-collection/"><meta property="og:site_name" content="终端出口"><meta property="og:image" content="/"><meta property="article:author" content="Satori5ama"><meta property="article:published_time" content="2024-10-25T08:52:25+08:00"><meta property="article:modified_time" content="2024-10-25T19:33:25+08:00"><meta property="article:tag" content="ACM模板"><meta name=twitter:card content="summary"><meta name=twitter:image content="/"><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/main.min.b10b9598adad8f697c02be1a706d7a7dd31bc412d6e3a38d6b6e78ef9220bb2a.css><link rel=preload as=style href=https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css integrity=sha384-IfxC36XL/toUyJ939C73PcgMuRzAZuIzZxE38drsmO5p6jD7ei+Zx/1oA/0l8ysE crossorigin=anonymous onload='this.onload=null,this.rel="stylesheet"'><link rel=preload as=style href=https://npm.webcache.cn/katex@0.16.24/dist/katex.min.css integrity=sha384-tTgKLjMYmJr94v8qu2PE5MUGSMbyN2xiH266JUB3gpm8vnnJywd1dWSOEfrFz+YI crossorigin=anonymous onload='this.onload=null,this.rel="stylesheet"'><script src=https://npm.webcache.cn/pace-js@1.2.4/pace.min.js integrity=sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8 crossorigin=anonymous></script><link rel=stylesheet href=https://npm.webcache.cn/@reimujs/aos@0.1.2/dist/aos.css integrity=sha384-GMRP93c6Hkz9JVKGAuRR3nTS7M07RwPgTFenXiosjq2VbVgvdDNcz1g6Mkj8AONa crossorigin=anonymous></head><body><div id=loader><div class="loading-left-bg loading-bg"></div><div class="loading-right-bg loading-bg"></div><div class=spinner-box><div class="loading-taichi rotate"><svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" shape-rendering="geometricPrecision"><path d="M303.5 432a80 80 0 01-12 160 80 80 0 0112-160z" fill="var(--red-1, #ff5252)"/><path d="M512 65a447 447 0 010 894V929a417 417 0 000-834 417 417 0 000 834v30a447 447 0 010-894zm0 30A417 417 0 01929 512 208.5 208.5.0 01720.5 720.5V592a80 80 0 000-160 80 80 0 000 160V720.5A208.5 208.5.0 01512 512 208.5 208.5.0 00303.5 303.5 208.5 208.5.0 0095 512 417 417 0 01512 95z" fill="var(--red-1, #ff5252)"/></svg></div><div class=loading-word>Loading...</div></div></div></div><script>var time=null,loaderEl=document.getElementById("loader"),startLoading=()=>{time=Date.now(),loaderEl.classList.remove("loading")},hideLoader=()=>{document.body.style.overflow="auto",loader.classList.add("loading")},endLoading=()=>{time?Date.now()-time>500?(time=null,hideLoader()):(setTimeout(endLoading,500-(Date.now()-time)),time=null):hideLoader()};window.addEventListener("DOMContentLoaded",endLoading),loaderEl.addEventListener("click",endLoading)</script><div id=copy-tooltip></div><div id=lang-tooltip>This article does not have a corresponding language version</div><div id=heatmap-tooltip></div><div id=container><div id=wrap><div id=header-nav><nav id=main-nav aria-label="Primary navigation"><a class=main-nav-link-wrap href=/><div class='main-nav-icon icon rotate'>&#xe62b;</div><span class=main-nav-link>Home</span>
</a><a class=main-nav-link-wrap href=/archives><div class='main-nav-icon icon rotate'>&#xe62b;</div><span class=main-nav-link>Archives</span>
</a><a class=main-nav-link-wrap href=/about><div class='main-nav-icon icon rotate'>&#xe62b;</div><span class=main-nav-link>About</span>
</a><a class=main-nav-link-wrap href=/friend><div class='main-nav-icon icon rotate'>&#xe62b;</div><span class=main-nav-link>Friend</span>
</a><a id=main-nav-toggle class=nav-icon aria-label="Toggle navigation" role=button></a></nav><nav id=sub-nav aria-label="Secondary navigation"></nav><nav id=i18n-nav aria-label="Language selection"><div class=custom-dropdown><div class=select-selected id=select-selected role=button aria-haspopup=listbox aria-expanded=false aria-label="Language menu"><span id=nav-language-btn class=nav-icon style="padding:0 20px 0 0"></span>
<span id=selected-lang>English</span></div><ul class=select-items id=select-items role=listbox aria-label=Languages><li data-value=en role=option class=selected arial-selected=true>English</li><li data-value=zh-cn role=option arial-selected=false>简体中文</li><li data-value=zh-tw role=option arial-selected=false>繁體中文</li><li data-value=ja role=option arial-selected=false>日本語</li></ul></div><script>var selectSelected=document.getElementById("select-selected"),selectedLang=document.getElementById("selected-lang"),selectItems=document.getElementById("select-items"),selectOptions=selectItems.querySelectorAll("li");selectSelected.addEventListener("click",()=>{selectItems.classList.toggle("show");var e=selectSelected.getAttribute("aria-expanded")==="true";selectSelected.setAttribute("aria-expanded",(!e).toString())}),selectOptions.forEach(e=>{e.addEventListener("click",()=>{const t={};if(selectedLang.textContent=e.textContent,selectItems.classList.remove("show"),selectOptions.forEach(e=>{e.classList.remove("selected")}),e.classList.add("selected"),e.dataset.value==="en")return;if(!t[e.dataset.value]){_$("#lang-tooltip").style.opacity="1",setTimeout(()=>{_$("#lang-tooltip").style.opacity="0"},1e3);return}window.location=t[e.dataset.value]})}),document.addEventListener("click",e=>{e.target.closest(".custom-dropdown")||(selectItems.classList.remove("show"),selectSelected.setAttribute("aria-expanded","false"))})</script></nav><a href=https://github.com/Satori5ama class=triangle-badge title=github target=_blank rel="noopener nofollow noreferrer"><div class="icon icon-github triangle-badge-icon"></div></a></div><header id=header aria-label="Site header"><picture></picture><img fetchpriority=high src=/images/ST.webp alt=板子合集（自用）><div id=header-outer><div id=header-title><span id=logo><h1 data-aos=slide-up>板子合集（自用）</h1></span><h2 id=subtitle-wrap data-aos=slide-down></h2></div></div></header><div id=content aria-label="Page content" class=sidebar-right><aside id=sidebar aria-label=Sidebar><div class="sidebar-wrapper-container sticky"><div class=sidebar-wrapper><div class=sidebar-wrap data-aos=fade-up><div class=sidebar-toc-sidebar><h3 class=toc-title>Contents</h3><div class="sidebar-toc-wrapper toc-div-class"><nav id=TableOfContents><ul><li><a href=#计算几何>计算几何</a><ul><li><a href=#线段平行>线段平行</a></li><li><a href=#线段共线>线段共线</a></li><li><a href=#判断一个点在线段的哪边>判断一个点在线段的哪边</a></li><li><a href=#线段相交>线段相交</a></li><li><a href=#线段交点>线段交点</a></li><li><a href=#向量旋转>向量旋转</a></li><li><a href=#三角剖分求面积>三角剖分求面积</a></li><li><a href=#凸包>凸包</a></li><li><a href=#eps误差处理>eps误差处理</a></li><li><a href=#旋转卡壳>旋转卡壳</a></li><li><a href=#自适应辛普森法>自适应辛普森法</a></li></ul></li><li><a href=#图论>图论</a><ul><li><a href=#最大流>最大流</a></li><li><a href=#费用流>费用流</a></li><li><a href=#二分图匹配>二分图匹配</a></li><li><a href=#2-sat>2-SAT</a></li><li><a href=#缩点>缩点</a></li><li><a href=#普通环计数>普通环计数</a></li><li><a href=#三元环计数>三元环计数</a></li><li><a href=#四元环计数>四元环计数</a></li><li><a href=#lca>LCA</a></li><li><a href=#树的直径>树的直径</a></li><li><a href=#树的中心>树的中心</a></li><li><a href=#树的重心>树的重心</a></li><li><a href=#树链剖分>树链剖分</a></li><li><a href=#dsu-on-tree>dsu on tree</a></li></ul></li><li><a href=#数论>数论</a><ul><li><a href=#线性筛>线性筛</a></li><li><a href=#数论分块>数论分块</a></li><li><a href=#extgcd>extgcd</a></li><li><a href=#crt>CRT</a></li><li><a href=#miller-rabin>Miller Rabin</a></li><li><a href=#pollard_rho>Pollard_Rho</a></li><li><a href=#威尔逊定理>威尔逊定理</a></li><li><a href=#lucas定理>Lucas定理</a></li><li><a href=#exbsgs>exBSGS</a></li><li><a href=#线性基>线性基</a></li><li><a href=#高斯消元>高斯消元</a></li><li><a href=#博弈论>博弈论</a></li></ul></li><li><a href=#字符串>字符串</a><ul><li><a href=#双值hash>双值hash</a></li><li><a href=#kmp>KMP</a></li><li><a href=#ac自动机>AC自动机</a></li><li><a href=#最小表示法>最小表示法</a></li><li><a href=#manacher>Manacher</a></li></ul></li><li><a href=#misc>Misc</a><ul><li><a href=#线段树分治>线段树分治</a></li><li><a href=#莫队>莫队</a></li><li><a href=#lct>LCT</a></li><li><a href=#珂朵莉树>珂朵莉树</a></li><li><a href=#三维偏序>三维偏序</a></li><li><a href=#cdq>CDQ</a></li><li><a href=#整体二分>整体二分</a></li></ul></li><li><a href=#附录>附录</a><ul><li><a href=#at1219>AT1219</a></li><li><a href=#luogu_1903>luogu_1903</a></li><li><a href=#luogu_sp10707>luogu_sp10707</a></li><li><a href=#莫队基础板子>莫队基础板子</a></li></ul></li></ul></nav></div></div><div class="sidebar-common-sidebar hidden"><div class=sidebar-author><img data-src=/avatar/avatar.webp data-sizes=auto alt=Satori5ama class=lazyload><div class=sidebar-author-name>Satori5ama</div><div class=sidebar-description>我们称之为路的，其实不过是彷徨。</div></div><div class=sidebar-state><div class=sidebar-state-article><div>Posts</div><div class=sidebar-state-number>80</div></div><a class=sidebar-state-category href=/categories/ aria-label=sidebar-state-category-link><div>Categories</div><div class=sidebar-state-number>7</div></a><a class=sidebar-state-tag href=/tags/ aria-label=sidebar-state-tag-link><div>Tags</div><div class=sidebar-state-number>26</div></a></div><div class=sidebar-social><div class="icon-github sidebar-social-icon"><a href=https://github.com/Satori5ama itemprop=url target=_blank aria-label=github rel="noopener nofollow noreferrer"></a></div></div><div class=sidebar-menu><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/ aria-label=Home></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>Home</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/archives aria-label=Archives></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>Archives</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/about aria-label=About></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>About</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/friend aria-label=Friend></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>Friend</div></div></div></div><div class=sidebar-btn-wrapper style=position:static><div class="sidebar-toc-btn current"></div><div class=sidebar-common-btn></div></div></div></div><div class=sidebar-widget></div></div></aside><section id=main aria-label="Main content"><article class="h-entry article" itemscope itemtype=https://schema.org/BlogPosting><div class=article-inner data-aos=fade-up><div class=article-meta><div class=article-date><span class="article-date-link icon-calendar" data-aos=zoom-in><time datetime="2024-10-25 08:52:25 +0800 CST" itemprop=datePublished>2024-10-25</time>
<time style=display:none id=post-update-time>2024-10-25</time></span></div><div class=article-category><a class=article-category-link href=/categories/%e7%ac%94%e8%ae%b0 data-aos=zoom-in>笔记</a></div></div><div class=hr-line></div><div class="e-content article-entry" itemprop=articleBody><h2 id=计算几何><a class=header-anchor href=#%e8%ae%a1%e7%ae%97%e5%87%a0%e4%bd%95></a>计算几何</h2><h3 id=线段平行><a class=header-anchor href=#%e7%ba%bf%e6%ae%b5%e5%b9%b3%e8%a1%8c></a>线段平行</h3><p>设线段端点分别为$P_1,P_2$和$P_3,P_4$</p><p>则</p>$$\overrightarrow{P_1 P_2} \times \overrightarrow{P_3 P_4} = 0$$<h3 id=线段共线><a class=header-anchor href=#%e7%ba%bf%e6%ae%b5%e5%85%b1%e7%ba%bf></a>线段共线</h3><p>设线段端点分别为$P_1,P_2$和$P_3,P_4$</p><p>则</p>$$\overrightarrow{P_1 P_2} \times \overrightarrow{P_2 P_3} = 0$$<p></p>$$\overrightarrow{P_1 P_2} \times \overrightarrow{P_2 P_4} = 0$$<h3 id=判断一个点在线段的哪边><a class=header-anchor href=#%e5%88%a4%e6%96%ad%e4%b8%80%e4%b8%aa%e7%82%b9%e5%9c%a8%e7%ba%bf%e6%ae%b5%e7%9a%84%e5%93%aa%e8%be%b9></a>判断一个点在线段的哪边</h3><p>假设有向线段为$\overrightarrow{AB}$ ，点为$C$，首先计算外积$\overrightarrow{AC} × \overrightarrow{AB}=( \overrightarrow{AC}_{x} ⋅\overrightarrow{AB}_{y}-\overrightarrow{AC}_{y} ⋅\overrightarrow{AB}_{x})\overrightarrow{k}$（因为有$\overrightarrow{AB}_{z}=0$，$\overrightarrow{AB}_{z}=0$）。根据右手螺旋定则，如果$\overrightarrow{k}$的系数为正数，说明点$C$在线段$AB$的右侧；如果为负数，说明点$C$在线段$AB$的左侧；如果为0，说明点$C$在线段$AB$所在的直线上。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//*************************************************************************  
</span></span></span><span class=line><span class=cl><span class=c1>// \brief: 计算两个向量的外积（叉乘）。可以根据结果的符号判断三个点的位置关系。  
</span></span></span><span class=line><span class=cl><span class=c1>// \Param: Point A 两个向量的公共起点。  
</span></span></span><span class=line><span class=cl><span class=c1>// \Param: Point B 第一个向量的终点。  
</span></span></span><span class=line><span class=cl><span class=c1>// \Param: Point C 第二个向量的终点。  
</span></span></span><span class=line><span class=cl><span class=c1>// \Returns: double 向量AC与向量AB的外积。
</span></span></span><span class=line><span class=cl><span class=c1>//如果结果为正数，表明点C在直线AB（直线方向为从A到B）的右侧；  
</span></span></span><span class=line><span class=cl><span class=c1>//如果结果为负数，表明点C在直线AB（直线方向为从A到B）的左侧；
</span></span></span><span class=line><span class=cl><span class=c1>//如果结果为0，表明点C在直线AB上。  
</span></span></span><span class=line><span class=cl><span class=c1>//*************************************************************************
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>double</span> <span class=nf>cross</span><span class=p>(</span><span class=n>Point</span> <span class=n>A</span><span class=p>,</span> <span class=n>Point</span> <span class=n>B</span><span class=p>,</span> <span class=n>Point</span> <span class=n>C</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>	<span class=kt>double</span> <span class=n>cross1</span> <span class=o>=</span> <span class=p>(</span><span class=n>C</span><span class=p>.</span><span class=n>x</span> <span class=o>-</span> <span class=n>A</span><span class=p>.</span><span class=n>x</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>B</span><span class=p>.</span><span class=n>y</span> <span class=o>-</span> <span class=n>A</span><span class=p>.</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>cross2</span> <span class=o>=</span> <span class=p>(</span><span class=n>C</span><span class=p>.</span><span class=n>y</span> <span class=o>-</span> <span class=n>A</span><span class=p>.</span><span class=n>y</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>B</span><span class=p>.</span><span class=n>x</span> <span class=o>-</span> <span class=n>A</span><span class=p>.</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>cross1</span> <span class=o>-</span> <span class=n>cross2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=线段相交><a class=header-anchor href=#%e7%ba%bf%e6%ae%b5%e7%9b%b8%e4%ba%a4></a>线段相交</h3><h4 id=跨立实验><a class=header-anchor href=#%e8%b7%a8%e7%ab%8b%e5%ae%9e%e9%aa%8c></a>跨立实验</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>T1</span> <span class=o>=</span> <span class=n>cross</span><span class=p>(</span><span class=n>A1</span><span class=p>,</span> <span class=n>A2</span><span class=p>,</span> <span class=n>B1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>T2</span> <span class=o>=</span> <span class=n>cross</span><span class=p>(</span><span class=n>A1</span><span class=p>,</span> <span class=n>A2</span><span class=p>,</span> <span class=n>B2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>T3</span> <span class=o>=</span> <span class=n>cross</span><span class=p>(</span><span class=n>B1</span><span class=p>,</span> <span class=n>B2</span><span class=p>,</span> <span class=n>A1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>T4</span> <span class=o>=</span> <span class=n>cross</span><span class=p>(</span><span class=n>B1</span><span class=p>,</span> <span class=n>B2</span><span class=p>,</span> <span class=n>A2</span><span class=p>);</span>
</span></span></code></pre></div><h4 id=快速排斥实验><a class=header-anchor href=#%e5%bf%ab%e9%80%9f%e6%8e%92%e6%96%a5%e5%ae%9e%e9%aa%8c></a>快速排斥实验</h4><p>(1). 如果$(T1 * T2) > 0$ || $(T3 * T4) > 0$，说明一条线段的两个端点在另一条线段的同侧，这两条线段肯定不相交。</p><p>(2). 如果$T1 == 0$ && $T2 == 0$，说明两条线段共线，是否相交还需要进一步判断。这时可以通过判断两条线段张成的矩形是否相交来判断，而两个矩形是否相交可以通过快速排斥实验来判断。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//*************************************************************************
</span></span></span><span class=line><span class=cl><span class=c1>// \brief: 	快速排斥实验，判断两个线段张成的矩形区域是否相交。
</span></span></span><span class=line><span class=cl><span class=c1>// \Param: 	Point S1 第一条线段的起点。
</span></span></span><span class=line><span class=cl><span class=c1>// \Param: 	Point E1 第一条线段的终点。
</span></span></span><span class=line><span class=cl><span class=c1>// \Param: 	Point S2 第二条线段的起点。
</span></span></span><span class=line><span class=cl><span class=c1>// \Param: 	Point E2 第二条线段的终点。
</span></span></span><span class=line><span class=cl><span class=c1>// \Returns: 	bool 两个线段张成的矩形区域是否相交。
</span></span></span><span class=line><span class=cl><span class=c1>//具有对称性，即交换两条线段（参数S1与S2交换、E1与E2交换），结果不变。
</span></span></span><span class=line><span class=cl><span class=c1>//*************************************************************************  
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>bool</span> <span class=nf>rectsIntersect</span><span class=p>(</span><span class=n>Point</span> <span class=n>S1</span><span class=p>,</span> <span class=n>Point</span> <span class=n>E1</span><span class=p>,</span> <span class=n>Point</span> <span class=n>S2</span><span class=p>,</span> <span class=n>Point</span> <span class=n>E2</span><span class=p>)</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>　　<span class=k>if</span> <span class=p>(</span> <span class=n>min</span><span class=p>(</span><span class=n>S1</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=n>E1</span><span class=p>.</span><span class=n>y</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>max</span><span class=p>(</span><span class=n>S2</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=n>E2</span><span class=p>.</span><span class=n>y</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>max</span><span class=p>(</span><span class=n>S1</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=n>E1</span><span class=p>.</span><span class=n>y</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>min</span><span class=p>(</span><span class=n>S2</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=n>E2</span><span class=p>.</span><span class=n>y</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>	<span class=o>&amp;&amp;</span> <span class=n>min</span><span class=p>(</span><span class=n>S1</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>E1</span><span class=p>.</span><span class=n>x</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>max</span><span class=p>(</span><span class=n>S2</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>E2</span><span class=p>.</span><span class=n>x</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>max</span><span class=p>(</span><span class=n>S1</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>E1</span><span class=p>.</span><span class=n>x</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>min</span><span class=p>(</span><span class=n>S2</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>E2</span><span class=p>.</span><span class=n>x</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>true</span><span class=p>;</span> <span class=p>}</span> <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>(3). 其他情况，两个线段一定相交。</p><p>代码实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>segmentsIntersect</span><span class=p>(</span><span class=n>Point</span> <span class=n>A1</span><span class=p>,</span> <span class=n>Point</span> <span class=n>A2</span><span class=p>,</span> <span class=n>Point</span> <span class=n>B1</span><span class=p>,</span> <span class=n>Point</span> <span class=n>B2</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>T1</span> <span class=o>=</span> <span class=n>cross</span><span class=p>(</span><span class=n>A1</span><span class=p>,</span> <span class=n>A2</span><span class=p>,</span> <span class=n>B1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>T2</span> <span class=o>=</span> <span class=n>cross</span><span class=p>(</span><span class=n>A1</span><span class=p>,</span> <span class=n>A2</span><span class=p>,</span> <span class=n>B2</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>T3</span> <span class=o>=</span> <span class=n>cross</span><span class=p>(</span><span class=n>B1</span><span class=p>,</span> <span class=n>B2</span><span class=p>,</span> <span class=n>A1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>T4</span> <span class=o>=</span> <span class=n>cross</span><span class=p>(</span><span class=n>B1</span><span class=p>,</span> <span class=n>B2</span><span class=p>,</span> <span class=n>A2</span><span class=p>);</span>　　
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(((</span><span class=n>T1</span> <span class=o>*</span> <span class=n>T2</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> <span class=p>((</span><span class=n>T3</span> <span class=o>*</span> <span class=n>T4</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span>    
</span></span><span class=line><span class=cl>    <span class=c1>// 一条线段的两个端点在另一条线段的同侧，不相交。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//（可能需要额外处理以防止乘法溢出，视具体情况而定。）
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=n>T1</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>T2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>             
</span></span><span class=line><span class=cl>    <span class=c1>// 两条线段共线，利用快速排斥实验进一步判断。此时必有 T3 == 0 &amp;&amp; T4 == 0。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>rectsIntersect</span><span class=p>(</span><span class=n>A1</span><span class=p>,</span> <span class=n>A2</span><span class=p>,</span> <span class=n>B1</span><span class=p>,</span> <span class=n>B2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>                                    <span class=c1>// 其它情况，两条线段相交。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>  
</span></span><span class=line><span class=cl> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以看到，这种方法不需要对线段的起终点重合（线段退化为一个点）做特殊判断，也不需要对线段平行（除了共线的情况）做特殊判断。纯几何方法，逻辑更简洁。</p><h3 id=线段交点><a class=header-anchor href=#%e7%ba%bf%e6%ae%b5%e4%ba%a4%e7%82%b9></a>线段交点</h3><p>参考文献：<a href=https://www.cnblogs.com/huntto/p/17492406.html>计算几何之两条线段的交点 - Huntto - 博客园 (cnblogs.com)</a></p><p>设线段端点分别为$P_1,P_2$和$P_3,P_4$，交点为$P_0$，</p>$$P_0 = P_1+t * \overrightarrow{P_1 P_2} $$<p></p>$$P_0 = P_3+s * \overrightarrow{P_3 P_4} $$<p>将点坐标代入公式</p>$$\begin{cases}x_1+(x_2-x_1)t=x_3+(x_4-x_3)s
\\
\\ y_1+(y_2-y_1)t=y_3+(y_4-y_3)s
\end{cases}$$<p>解方程得</p>$$\begin{cases}t=\frac{(x_3-x_1)(y_4-y_3)-(y_3-y_1)(x_4-x_3)}{(x_2-x_1)(y_4-y_3)-(y_2-y_1)(x_4-x_3)}
\\
\\ s=\frac{(x_3-x_1)(y_2-y_1)-(y_3-y_1)(x_2-x_1)}{(x_2-x_1)(y_4-y_3)-(y_2-y_1)(x_4-x_3)}
\end{cases}$$<p>写作向量形式为</p>$$\begin{align*}t=\frac{\overrightarrow{P_3 P_1} \times \overrightarrow{P_4 P_3}}{\overrightarrow{P_2 P_1} \times \overrightarrow{P_4 P_3}}
\\s=\frac{\overrightarrow{P_3 P_1} \times \overrightarrow{P_2 P_1}}{\overrightarrow{P_2 P_1} \times \overrightarrow{P_4 P_3}}
\end{align*}$$<p>因此$P_0$的坐标为</p>$$\begin{cases}x_0 = x_1+t * (x_2-x_1)
\\y_0 = y_1+t * (y_2-y_1)
\end{cases}$$<p>或</p>$$\begin{cases}x_0 = x_3+s * (x_4-x_3)
\\y_0 = y_3+s * (y_4-y_3)
\end{cases}$$<h3 id=向量旋转><a class=header-anchor href=#%e5%90%91%e9%87%8f%e6%97%8b%e8%bd%ac></a>向量旋转</h3><p>设$\overrightarrow{a} = (x,y)$，逆时针旋转$\alpha$角得到</p>$$\overrightarrow{b} =(x\cos\alpha −y\sin\alpha ,y\cos\alpha+x\sin\alpha )$$<p>可以用复数的乘法证明。</p><h3 id=三角剖分求面积><a class=header-anchor href=#%e4%b8%89%e8%a7%92%e5%89%96%e5%88%86%e6%b1%82%e9%9d%a2%e7%a7%af></a>三角剖分求面积</h3><p>把相邻<strong>每两个顶点与原点构成的向量的叉积</strong>的数值的一半依次累加起来，就能得到多边形的面积。</p>$$ S_{ABCDEF} = \frac{\overrightarrow{OA} × \overrightarrow{OB} + \overrightarrow{OB} × \overrightarrow{OC} +⋯+ \overrightarrow{OF} × \overrightarrow{OA}}{2} $$<h3 id=凸包><a class=header-anchor href=#%e5%87%b8%e5%8c%85></a>凸包</h3><p>首先把所有点以横坐标为第一关键字，纵坐标为第二关键字排序。</p><p>显然排序后最小的元素和最大的元素一定在凸包上。而且因为是凸多边形，我们如果从一个点出发逆时针走，轨迹总是 “左拐” 的，一旦出现右拐，就说明这一段不在凸包上。因此我们可以用一个单调栈来维护上下凸壳。</p><p>因为从左向右看，上下凸壳所旋转的方向不同，为了让单调栈起作用，我们首先<strong>升序枚举</strong>求出下凸壳，然后<strong>降序</strong>求出上凸壳。</p><p>求凸壳时，一旦发现即将进栈的点（$P$）和栈顶的两个点（$S1​,S2$，其中 $S1$ 为栈顶 ）行进的方向向右旋转，即叉积小于 00：$\overrightarrow{S_{2}​S_{1}}​​×\overrightarrow{S_{1}P}​<0$，则弹出栈顶，回到上一步，继续检测，直到 $\overrightarrow{S_{2}​S_{1}}​​×\overrightarrow{S_{1}P}​\ge 0$​或者栈内仅剩一个元素为止。</p><p>通常情况下不需要保留位于凸包边上的点，因此上面一段中 $\overrightarrow{S_{2}​S_{1}}​​×\overrightarrow{S_{1}P}​<0$ 这个条件中的 “$<$” 可以视情况改为 $\le$，同时后面一个条件应改为 $>$。</p><p>最后不要忘了把最小的元素与栈顶进行比较，以保证最后一段也是凸壳。</p><p>时间复杂度 $O(n\log_{}{n} )$。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>sort</span><span class=p>(</span><span class=n>p</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=n>p</span><span class=o>+</span><span class=mi>1</span><span class=o>+</span><span class=n>n</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=n>stk</span><span class=p>[</span><span class=o>++</span><span class=n>tp</span><span class=p>]</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>n</span><span class=p>;</span><span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>	<span class=k>while</span><span class=p>(</span><span class=n>tp</span><span class=o>&gt;</span><span class=mi>1</span><span class=o>&amp;&amp;</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>stk</span><span class=p>[</span><span class=n>tp</span><span class=p>]]</span><span class=o>-</span><span class=n>p</span><span class=p>[</span><span class=n>stk</span><span class=p>[</span><span class=n>tp</span><span class=o>-</span><span class=mi>1</span><span class=p>]])</span><span class=o>*</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-</span><span class=n>p</span><span class=p>[</span><span class=n>stk</span><span class=p>[</span><span class=n>tp</span><span class=p>]])</span><span class=o>&lt;=</span><span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>		<span class=p>[</span><span class=n>stk</span><span class=p>[</span><span class=n>tp</span><span class=o>--</span><span class=p>]]</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>	<span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>	<span class=n>stk</span><span class=p>[</span><span class=o>++</span><span class=n>tp</span><span class=p>]</span><span class=o>=</span><span class=n>i</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>qaq</span><span class=o>=</span><span class=n>tp</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&gt;</span><span class=mi>0</span><span class=p>;</span><span class=o>--</span><span class=n>i</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>	<span class=k>while</span><span class=p>(</span><span class=n>tp</span><span class=o>&gt;</span><span class=n>qaq</span><span class=o>&amp;&amp;</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>stk</span><span class=p>[</span><span class=n>tp</span><span class=p>]]</span><span class=o>-</span><span class=n>p</span><span class=p>[</span><span class=n>stk</span><span class=p>[</span><span class=n>tp</span><span class=o>-</span><span class=mi>1</span><span class=p>]])</span><span class=o>*</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-</span><span class=n>p</span><span class=p>[</span><span class=n>stk</span><span class=p>[</span><span class=n>tp</span><span class=p>]])</span><span class=o>&lt;=</span><span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>		<span class=n>used</span><span class=p>[</span><span class=n>stk</span><span class=p>[</span><span class=n>tp</span><span class=o>--</span><span class=p>]]</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>	<span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>	<span class=n>stk</span><span class=p>[</span><span class=o>++</span><span class=n>tp</span><span class=p>]</span><span class=o>=</span><span class=n>i</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=p>}</span> 
</span></span><span class=line><span class=cl><span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>tp</span><span class=p>;</span><span class=o>++</span><span class=n>i</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>	<span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>p</span><span class=p>[</span><span class=n>stk</span><span class=p>[</span><span class=n>i</span><span class=p>]];</span>
</span></span></code></pre></div><h3 id=eps误差处理><a class=header-anchor href=#eps%e8%af%af%e5%b7%ae%e5%a4%84%e7%90%86></a>eps误差处理</h3>$$a==0 : fabs(a)<eps$$<p></p>$$a<0 : a<−eps$$<p></p>$$a>0 : a>eps$$<p></p>$$a<=0 : a<eps$$<p></p>$$a>=0 : a>-eps$$<p>在一些卡精度的题（如UVA10173），允许的情况下建议使用<code>long double</code></p><p>注意<code>long double</code> 对应 <code>%Lf</code></p><h3 id=旋转卡壳><a class=header-anchor href=#%e6%97%8b%e8%bd%ac%e5%8d%a1%e5%a3%b3></a>旋转卡壳</h3><p>旋转卡壳是用来求凸包直径的算法。</p><h4 id=对踵点><a class=header-anchor href=#%e5%af%b9%e8%b8%b5%e7%82%b9></a>对踵点</h4><p>如果过凸多边形上两点作一对平行线，使得整个多边形都在这两条线之间，那么这两个点被称为一对对踵点。</p><h4 id=凸多边形的直径><a class=header-anchor href=#%e5%87%b8%e5%a4%9a%e8%be%b9%e5%bd%a2%e7%9a%84%e7%9b%b4%e5%be%84></a>凸多边形的直径</h4><p>即凸多边形上任意两个点之间距离的最大值。<strong>直径一定会在对踵点中产生</strong>。</p><h4 id=算法思路><a class=header-anchor href=#%e7%ae%97%e6%b3%95%e6%80%9d%e8%b7%af></a>算法思路</h4><p>我们以凸包上的每条边为对象考虑，求出每一条边的对踵点。</p><p><img src=https://www.wjyyy.top/wp-content/uploads/2018/12/201812192155.png alt=边的对踵点示意图></p><p>点到边的距离可以用三角形面积*2除以底边长度来得到，而三角形面积可以通过叉积求解，又注意到对踵点在逆时针枚举边的过程中也逆时针移动，所以对于所有边的对踵点，我们使用双指针法求解。</p><p>难点在于编码细节极其多。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>vec</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=n>vec</span> <span class=k>operator</span> <span class=o>-</span><span class=p>(</span><span class=k>const</span> <span class=n>vec</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>,</span> <span class=k>const</span> <span class=n>vec</span> <span class=o>&amp;</span><span class=n>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>vec</span><span class=p>{</span><span class=n>a</span><span class=p>.</span><span class=n>x</span> <span class=o>-</span> <span class=n>b</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>a</span><span class=p>.</span><span class=n>y</span> <span class=o>-</span> <span class=n>b</span><span class=p>.</span><span class=n>y</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=n>ll</span> <span class=k>operator</span> <span class=o>*</span><span class=p>(</span><span class=k>const</span> <span class=n>vec</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>,</span> <span class=k>const</span> <span class=n>vec</span> <span class=o>&amp;</span><span class=n>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=n>x</span> <span class=o>*</span> <span class=n>b</span><span class=p>.</span><span class=n>y</span> <span class=o>-</span> <span class=n>a</span><span class=p>.</span><span class=n>y</span> <span class=o>*</span> <span class=n>b</span><span class=p>.</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=nf>dis_</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span> <span class=o>*</span> <span class=n>x</span> <span class=o>+</span> <span class=n>y</span> <span class=o>*</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=n>ll</span> <span class=nf>dis</span><span class=p>(</span><span class=k>const</span> <span class=n>vec</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>,</span> <span class=k>const</span> <span class=n>vec</span> <span class=o>&amp;</span><span class=n>b</span><span class=p>,</span> <span class=k>const</span> <span class=n>vec</span> <span class=o>&amp;</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>abs</span><span class=p>((</span><span class=n>x</span> <span class=o>-</span> <span class=n>a</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=n>b</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=kt>bool</span> <span class=k>operator</span> <span class=o>&lt;</span><span class=p>(</span><span class=k>const</span> <span class=n>vec</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>,</span> <span class=k>const</span> <span class=n>vec</span> <span class=o>&amp;</span><span class=n>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=n>x</span> <span class=o>&lt;</span> <span class=n>b</span><span class=p>.</span><span class=n>x</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=n>x</span> <span class=o>==</span> <span class=n>b</span><span class=p>.</span><span class=n>x</span> <span class=o>&amp;&amp;</span> <span class=n>a</span><span class=p>.</span><span class=n>y</span> <span class=o>&lt;</span> <span class=n>b</span><span class=p>.</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>p</span><span class=p>[</span><span class=mi>100005</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>st</span><span class=p>[</span><span class=mi>100005</span><span class=p>],</span> <span class=n>top</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>used</span><span class=p>[</span><span class=mi>100005</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>convexhull</span><span class=p>()</span> <span class=p>{</span>  <span class=c1>// 求凸包 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>sort</span><span class=p>(</span><span class=n>p</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>p</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>+</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>top</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=p>]]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]])</span> <span class=o>*</span> 
</span></span><span class=line><span class=cl>               <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=p>]])</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>used</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=o>--</span><span class=p>]]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>st</span><span class=p>[</span><span class=o>++</span><span class=n>top</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>qaq</span> <span class=o>=</span> <span class=n>top</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=p>(</span><span class=n>top</span> <span class=o>&gt;</span> <span class=n>qaq</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=p>]]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]])</span> <span class=o>*</span> 
</span></span><span class=line><span class=cl>                   <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=p>]])</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>used</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=o>--</span><span class=p>]]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>st</span><span class=p>[</span><span class=o>++</span><span class=n>top</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>   
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>top</span> <span class=o>&gt;</span> <span class=n>qaq</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=p>]]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]])</span> <span class=o>*</span> 
</span></span><span class=line><span class=cl>           <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=p>]])</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>used</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=o>--</span><span class=p>]]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>st</span><span class=p>[</span><span class=o>++</span><span class=n>top</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=n>ll</span> <span class=nf>rotating</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>top</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>)</span>  <span class=c1>// 注意点1会在开头和结尾各自入栈一次
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=mi>1</span><span class=p>]]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=mi>2</span><span class=p>]]).</span><span class=n>dis_</span><span class=p>();</span>  <span class=c1>// 如果凸包只有两个点直接输出两点距离 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>t</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>mx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>top</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>dis</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>i</span><span class=p>]],</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]],</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>t</span><span class=p>]])</span> <span class=o>&lt;=</span> 
</span></span><span class=line><span class=cl>               <span class=n>dis</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>i</span><span class=p>]],</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]],</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>t</span> <span class=o>%</span> <span class=n>top</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]]))</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span> <span class=o>=</span> <span class=n>t</span> <span class=o>%</span> <span class=n>top</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mx</span> <span class=o>=</span> <span class=n>max</span><span class=p>(</span><span class=n>mx</span><span class=p>,</span> <span class=n>max</span><span class=p>((</span><span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>t</span><span class=p>]]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>i</span><span class=p>]]).</span><span class=n>dis_</span><span class=p>(),</span> 
</span></span><span class=line><span class=cl>                         <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>t</span><span class=p>]]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]]).</span><span class=n>dis_</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mx</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=例题smallest-bounding-rectangle---uva-10173><a class=header-anchor href=#%e4%be%8b%e9%a2%98smallest-bounding-rectangle---uva-10173></a>例题：<a href=https://vjudge.net/problem/UVA-10173>Smallest Bounding Rectangle - UVA 10173</a></h4><p>给出平面上的一堆点，找出一个能够覆盖所有点的面积最小的矩形，输出面积及四个顶点的坐标。</p><p>首先有结论：这样的矩形一定有一条边与凸包重合。</p><p><img src=https://s2.ax1x.com/2019/05/31/VlElb8.png alt=最小矩形覆盖></p><p>那么我们对于每一条边，只需要求出对踵点，最左点和最右点。</p><p>最左点和最右点的求法和对踵点类似，我们只需要改用点积来判断即可。</p><p>求出这三点后，我们先求出底边的垂线，就可以结合左右两点坐标求出水平长度，再结合边到对踵点的高度求出面积。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#define double long double
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>typedef</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>ll</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>int</span> <span class=n>MAXN</span> <span class=o>=</span> <span class=mi>100001</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>double</span> <span class=n>eps</span> <span class=o>=</span> <span class=mf>1e-8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>vec</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=n>vec</span> <span class=k>operator</span> <span class=o>+</span><span class=p>(</span><span class=n>vec</span> <span class=n>x</span><span class=p>,</span> <span class=n>vec</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>vec</span><span class=p>{</span><span class=n>x</span><span class=p>.</span><span class=n>x</span> <span class=o>+</span> <span class=n>y</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>.</span><span class=n>y</span> <span class=o>+</span> <span class=n>y</span><span class=p>.</span><span class=n>y</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=n>vec</span> <span class=k>operator</span> <span class=o>-</span><span class=p>(</span><span class=n>vec</span> <span class=n>x</span><span class=p>,</span> <span class=n>vec</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>vec</span><span class=p>{</span><span class=n>x</span><span class=p>.</span><span class=n>x</span> <span class=o>-</span> <span class=n>y</span><span class=p>.</span><span class=n>x</span><span class=p>,</span> <span class=n>x</span><span class=p>.</span><span class=n>y</span> <span class=o>-</span> <span class=n>y</span><span class=p>.</span><span class=n>y</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=kt>double</span> <span class=k>operator</span> <span class=o>*</span><span class=p>(</span><span class=n>vec</span> <span class=n>x</span><span class=p>,</span> <span class=n>vec</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>x</span> <span class=o>*</span> <span class=n>y</span><span class=p>.</span><span class=n>y</span> <span class=o>-</span> <span class=n>x</span><span class=p>.</span><span class=n>y</span> <span class=o>*</span> <span class=n>y</span><span class=p>.</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=kt>double</span> <span class=k>operator</span> <span class=o>^</span><span class=p>(</span><span class=n>vec</span> <span class=n>x</span><span class=p>,</span> <span class=n>vec</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>x</span> <span class=o>*</span> <span class=n>y</span><span class=p>.</span><span class=n>x</span> <span class=o>+</span> <span class=n>x</span><span class=p>.</span><span class=n>y</span> <span class=o>*</span> <span class=n>y</span><span class=p>.</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>friend</span> <span class=kt>bool</span> <span class=k>operator</span> <span class=o>&lt;</span><span class=p>(</span><span class=n>vec</span> <span class=n>x</span><span class=p>,</span> <span class=n>vec</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>x</span> <span class=o>-</span> <span class=n>y</span><span class=p>.</span><span class=n>x</span> <span class=o>&lt;</span> <span class=n>eps</span><span class=p>)</span> <span class=o>||</span> 
</span></span><span class=line><span class=cl>               <span class=p>(</span><span class=n>fabs</span><span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>x</span> <span class=o>-</span> <span class=n>y</span><span class=p>.</span><span class=n>x</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>eps</span> <span class=o>&amp;&amp;</span> <span class=n>x</span><span class=p>.</span><span class=n>y</span> <span class=o>-</span> <span class=n>y</span><span class=p>.</span><span class=n>y</span> <span class=o>&lt;</span> <span class=n>eps</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=nf>dis</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sqrt</span><span class=p>(</span><span class=n>x</span> <span class=o>*</span> <span class=n>x</span> <span class=o>+</span> <span class=n>y</span> <span class=o>*</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>p</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>st</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span> <span class=n>top</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>used</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>convexhull</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>top</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>memset</span><span class=p>(</span><span class=n>used</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>n</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>sort</span><span class=p>(</span><span class=n>p</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>p</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>+</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>st</span><span class=p>[</span><span class=o>++</span><span class=n>top</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>top</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=p>]]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]])</span> <span class=o>*</span> 
</span></span><span class=line><span class=cl>               <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=p>]])</span> <span class=o>&lt;</span> <span class=n>eps</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=n>used</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=o>--</span><span class=p>]]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>st</span><span class=p>[</span><span class=o>++</span><span class=n>top</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=p>(</span><span class=n>top</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=p>]]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]])</span> <span class=o>*</span> 
</span></span><span class=line><span class=cl>                   <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=p>]])</span> <span class=o>&lt;</span> <span class=n>eps</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>                <span class=n>used</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>top</span><span class=o>--</span><span class=p>]]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>st</span><span class=p>[</span><span class=o>++</span><span class=n>top</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>used</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>top</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span><span class=p>[</span><span class=n>st</span><span class=p>[</span><span class=n>i</span><span class=p>]];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>double</span> <span class=nf>sqr</span><span class=p>(</span><span class=n>vec</span> <span class=n>a</span><span class=p>,</span> <span class=n>vec</span> <span class=n>b</span><span class=p>,</span> <span class=n>vec</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>a</span> <span class=o>-</span> <span class=n>x</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>b</span> <span class=o>-</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>double</span> <span class=nf>solve</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>top</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>t</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>sqr</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=n>t</span><span class=p>])</span> <span class=o>-</span> 
</span></span><span class=line><span class=cl>           <span class=n>sqr</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=n>t</span> <span class=o>%</span> <span class=n>top</span> <span class=o>+</span> <span class=mi>1</span><span class=p>])</span> <span class=o>&lt;</span> <span class=n>eps</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=n>t</span> <span class=o>=</span> <span class=n>t</span> <span class=o>%</span> <span class=n>top</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>t2</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>t3</span> <span class=o>=</span> <span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>double</span> <span class=n>ans</span> <span class=o>=</span> <span class=mf>1e18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>top</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>sqr</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=n>t</span><span class=p>])</span> <span class=o>-</span> 
</span></span><span class=line><span class=cl>               <span class=n>sqr</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=n>t</span> <span class=o>%</span> <span class=n>top</span> <span class=o>+</span> <span class=mi>1</span><span class=p>])</span> <span class=o>&lt;</span> <span class=n>eps</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=n>t</span> <span class=o>=</span> <span class=n>t</span> <span class=o>%</span> <span class=n>top</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(((</span><span class=n>h</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>^</span> <span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=n>t2</span> <span class=o>%</span> <span class=n>top</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>h</span><span class=p>[</span><span class=n>t2</span><span class=p>]))</span> <span class=o>&gt;</span> <span class=o>-</span><span class=n>eps</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=n>t2</span> <span class=o>=</span> <span class=n>t2</span> <span class=o>%</span> <span class=n>top</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// 记得都要%top再+1 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>while</span> <span class=p>(((</span><span class=n>h</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>^</span> <span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=n>t3</span> <span class=o>%</span> <span class=n>top</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=n>h</span><span class=p>[</span><span class=n>t3</span><span class=p>]))</span> <span class=o>&lt;</span> <span class=n>eps</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=n>t3</span> <span class=o>=</span> <span class=n>t3</span> <span class=o>%</span> <span class=n>top</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>vec</span> <span class=n>vert</span> <span class=o>=</span> <span class=p>{</span><span class=o>-</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=n>y</span> <span class=o>-</span> <span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>y</span><span class=p>),</span> <span class=n>h</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=n>x</span> <span class=o>-</span> <span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>x</span><span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=kt>double</span> <span class=n>ar</span> <span class=o>=</span> <span class=p>(</span><span class=n>sqr</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=n>t</span><span class=p>])</span> <span class=o>/</span> 
</span></span><span class=line><span class=cl>                     <span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=n>h</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]).</span><span class=n>dis</span><span class=p>())</span> <span class=o>*</span> 
</span></span><span class=line><span class=cl>                     <span class=p>(</span><span class=n>sqr</span><span class=p>(</span><span class=n>h</span><span class=p>[</span><span class=n>t2</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=n>t2</span><span class=p>]</span> <span class=o>+</span> <span class=n>vert</span><span class=p>,</span> <span class=n>h</span><span class=p>[</span><span class=n>t3</span><span class=p>])</span> <span class=o>/</span> 
</span></span><span class=line><span class=cl>                     <span class=p>(</span><span class=n>vert</span><span class=p>).</span><span class=n>dis</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>=</span> <span class=n>min</span><span class=p>(</span><span class=n>ans</span><span class=p>,</span> <span class=n>ar</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ans</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ios</span><span class=o>::</span><span class=n>sync_with_stdio</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span><span class=p>.</span><span class=n>tie</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>n</span><span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>x</span> <span class=o>&gt;&gt;</span> <span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>convexhull</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%.4Lf</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>solve</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=自适应辛普森法><a class=header-anchor href=#%e8%87%aa%e9%80%82%e5%ba%94%e8%be%9b%e6%99%ae%e6%a3%ae%e6%b3%95></a>自适应辛普森法</h3><p><strong>Simpson公式</strong>：用抛物线来拟合原函数。</p>$$\int\limits_{a}^{b}f(x)dx=\frac{1}{6}(b-a)[f(a)+f(b)+4f(\frac{a+b}{2})]$$<p>通过不断将区间二分直到满足需要的精度。</p><h4 id=例题bzoj-2178-圆的面积并><a class=header-anchor href=#%e4%be%8b%e9%a2%98bzoj-2178-%e5%9c%86%e7%9a%84%e9%9d%a2%e7%a7%af%e5%b9%b6></a>例题：<a href=https://bzoj.net/p/2178>BZOJ-2178 圆的面积并</a></h4><p>用自适应辛普森法求解，$f(x_{0})$即直线$x=x_{0}$与所有圆的相交的$y$坐标区间的长度。</p><p><strong>trick</strong>：注意这道题看似对精度要求不高，实则测试点13会卡精度，所以为了避免被特意构造的数据卡掉，我们<strong>将坐标系旋转一个随机角度</strong>。这是一个常用技巧，在旋转卡壳中也可以使用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#define double long double
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>double</span> <span class=n>x</span><span class=p>[</span><span class=mi>1005</span><span class=p>],</span><span class=n>y</span><span class=p>[</span><span class=mi>1005</span><span class=p>],</span><span class=n>r</span><span class=p>[</span><span class=mi>1005</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=n>pair</span><span class=o>&lt;</span><span class=kt>double</span><span class=p>,</span><span class=kt>double</span><span class=o>&gt;</span> <span class=n>P</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>P</span> <span class=n>q</span><span class=p>[</span><span class=mi>1005</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>double</span> <span class=nf>f</span><span class=p>(</span><span class=kt>double</span> <span class=n>v</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>tot</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>n</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=kt>double</span> <span class=n>dx</span><span class=o>=</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-</span><span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>r</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>*</span><span class=n>r</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-</span><span class=n>dx</span><span class=o>*</span><span class=n>dx</span><span class=o>&gt;</span><span class=mf>1e-8</span><span class=p>){</span>
</span></span><span class=line><span class=cl>			<span class=kt>double</span> <span class=n>dy</span><span class=o>=</span><span class=n>sqrt</span><span class=p>(</span><span class=n>r</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>*</span><span class=n>r</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-</span><span class=n>dx</span><span class=o>*</span><span class=n>dx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>q</span><span class=p>[</span><span class=o>++</span><span class=n>tot</span><span class=p>]</span><span class=o>=</span><span class=n>P</span><span class=p>(</span><span class=n>y</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-</span><span class=n>dy</span><span class=p>,</span><span class=n>y</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>+</span><span class=n>dy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=n>tot</span><span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>sort</span><span class=p>(</span><span class=n>q</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=n>q</span><span class=o>+</span><span class=mi>1</span><span class=o>+</span><span class=n>tot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=c1>//以下将x=v穿过的所有y区间进行合并 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kt>double</span> <span class=n>ans</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span><span class=n>st</span><span class=o>=</span><span class=n>q</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>first</span><span class=p>,</span><span class=n>ed</span><span class=o>=</span><span class=n>q</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=n>second</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>tot</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>first</span><span class=o>&lt;=</span><span class=n>ed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>ed</span><span class=o>=</span><span class=n>max</span><span class=p>(</span><span class=n>ed</span><span class=p>,</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>second</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>ans</span><span class=o>+=</span><span class=n>ed</span><span class=o>-</span><span class=n>st</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>st</span><span class=o>=</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>first</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>ed</span><span class=o>=</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>second</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>ans</span><span class=o>+</span><span class=n>ed</span><span class=o>-</span><span class=n>st</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>double</span> <span class=nf>simpson</span><span class=p>(</span><span class=kt>double</span> <span class=n>l</span><span class=p>,</span><span class=kt>double</span> <span class=n>r</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>(</span><span class=n>f</span><span class=p>(</span><span class=n>l</span><span class=p>)</span><span class=o>+</span><span class=n>f</span><span class=p>(</span><span class=n>r</span><span class=p>)</span><span class=o>+</span><span class=mi>4</span><span class=o>*</span><span class=n>f</span><span class=p>((</span><span class=n>l</span><span class=o>+</span><span class=n>r</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>))</span><span class=o>*</span><span class=p>(</span><span class=n>r</span><span class=o>-</span><span class=n>l</span><span class=p>)</span><span class=o>/</span><span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>double</span> <span class=nf>asr</span><span class=p>(</span><span class=kt>double</span> <span class=n>l</span><span class=p>,</span><span class=kt>double</span> <span class=n>r</span><span class=p>,</span><span class=kt>double</span> <span class=n>eps</span><span class=p>,</span><span class=kt>double</span> <span class=n>ans</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=kt>double</span> <span class=n>mid</span><span class=o>=</span><span class=p>(</span><span class=n>l</span><span class=o>+</span><span class=n>r</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>double</span> <span class=n>ansl</span><span class=o>=</span><span class=n>simpson</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=n>mid</span><span class=p>),</span><span class=n>ansr</span><span class=o>=</span><span class=n>simpson</span><span class=p>(</span><span class=n>mid</span><span class=p>,</span><span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>fabs</span><span class=p>(</span><span class=n>ansl</span><span class=o>+</span><span class=n>ansr</span><span class=o>-</span><span class=n>ans</span><span class=p>)</span><span class=o>&lt;</span><span class=mi>15</span><span class=o>*</span><span class=n>eps</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>ansl</span><span class=o>+</span><span class=n>ansr</span><span class=o>+</span><span class=p>(</span><span class=n>ansl</span><span class=o>+</span><span class=n>ansr</span><span class=o>-</span><span class=n>ans</span><span class=p>)</span><span class=o>/</span><span class=mi>15</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>asr</span><span class=p>(</span><span class=n>l</span><span class=p>,</span><span class=n>mid</span><span class=p>,</span><span class=n>eps</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span><span class=n>ansl</span><span class=p>)</span><span class=o>+</span>
</span></span><span class=line><span class=cl>	<span class=n>asr</span><span class=p>(</span><span class=n>mid</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>eps</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span><span class=n>ansr</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>_rotate</span><span class=p>(</span><span class=kt>double</span> <span class=o>&amp;</span><span class=n>x</span><span class=p>,</span> <span class=kt>double</span> <span class=o>&amp;</span><span class=n>y</span><span class=p>,</span><span class=kt>double</span> <span class=n>angle</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>double</span> <span class=n>x_</span><span class=o>=</span><span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>double</span> <span class=n>y_</span><span class=o>=</span><span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>x</span><span class=o>=</span><span class=n>x_</span> <span class=o>*</span> <span class=n>cos</span><span class=p>(</span><span class=n>angle</span><span class=p>)</span> <span class=o>+</span> <span class=n>y_</span> <span class=o>*</span> <span class=n>sin</span><span class=p>(</span><span class=n>angle</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>y</span><span class=o>=-</span><span class=n>x_</span> <span class=o>*</span> <span class=n>sin</span><span class=p>(</span><span class=n>angle</span><span class=p>)</span> <span class=o>+</span> <span class=n>y_</span> <span class=o>*</span> <span class=n>cos</span><span class=p>(</span><span class=n>angle</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>	<span class=n>ios</span><span class=o>::</span><span class=n>sync_with_stdio</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=n>cin</span><span class=p>.</span><span class=n>tie</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>cin</span><span class=o>&gt;&gt;</span><span class=n>n</span><span class=o>&gt;&gt;</span><span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=n>y</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=n>r</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>rot</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>	<span class=c1>//坐标系旋转一个随机角度 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=n>_rotate</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>y</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>rot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>double</span> <span class=n>lf</span><span class=o>=</span><span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-</span><span class=n>r</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>rf</span><span class=o>=</span><span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>+</span><span class=n>r</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>n</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=cl>		<span class=n>cin</span><span class=o>&gt;&gt;</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=n>y</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=n>r</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>_rotate</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=n>y</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=n>rot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>lf</span><span class=o>=</span><span class=n>min</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-</span><span class=n>r</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=n>lf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>rf</span><span class=o>=</span><span class=n>max</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>+</span><span class=n>r</span><span class=p>[</span><span class=n>i</span><span class=p>],</span><span class=n>rf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%.3Lf&#34;</span><span class=p>,</span><span class=n>asr</span><span class=p>(</span><span class=n>lf</span><span class=o>-</span><span class=mi>10</span><span class=p>,</span><span class=n>rf</span><span class=o>+</span><span class=mi>10</span><span class=p>,</span><span class=mf>1e-5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>simpson</span><span class=p>(</span><span class=n>lf</span><span class=o>-</span><span class=mi>10</span><span class=p>,</span><span class=n>rf</span><span class=o>+</span><span class=mi>10</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=图论><a class=header-anchor href=#%e5%9b%be%e8%ae%ba></a>图论</h2><h3 id=最大流><a class=header-anchor href=#%e6%9c%80%e5%a4%a7%e6%b5%81></a>最大流</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl> <span class=k>struct</span> <span class=nc>MF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=nc>edge</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>v</span><span class=p>,</span> <span class=n>nxt</span><span class=p>,</span> <span class=n>cap</span><span class=p>,</span> <span class=n>flow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>e</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fir</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>cnt</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>S</span><span class=p>,</span> <span class=n>T</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>maxflow</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>dep</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>cur</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>memset</span><span class=p>(</span><span class=n>fir</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=k>sizeof</span> <span class=n>fir</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>cnt</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>addedge</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v</span><span class=p>,</span> <span class=kt>int</span> <span class=n>w</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=p>[</span><span class=n>cnt</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span><span class=p>,</span> <span class=n>fir</span><span class=p>[</span><span class=n>u</span><span class=p>],</span> <span class=n>w</span><span class=p>,</span> <span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=n>fir</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=n>cnt</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>e</span><span class=p>[</span><span class=n>cnt</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=n>u</span><span class=p>,</span> <span class=n>fir</span><span class=p>[</span><span class=n>v</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=n>fir</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>=</span> <span class=n>cnt</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=nf>bfs</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>queue</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>q</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>memset</span><span class=p>(</span><span class=n>dep</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>dep</span><span class=p>[</span><span class=n>S</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>S</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>q</span><span class=p>.</span><span class=n>size</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>u</span> <span class=o>=</span> <span class=n>q</span><span class=p>.</span><span class=n>front</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>fir</span><span class=p>[</span><span class=n>u</span><span class=p>];</span> <span class=o>~</span><span class=n>i</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>nxt</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>int</span> <span class=n>v</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>((</span><span class=o>!</span><span class=n>dep</span><span class=p>[</span><span class=n>v</span><span class=p>])</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cap</span> <span class=o>&gt;</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>flow</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>dep</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>=</span> <span class=n>dep</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>q</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>dep</span><span class=p>[</span><span class=n>T</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=nf>dfs</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flow</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>u</span> <span class=o>==</span> <span class=n>T</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=o>!</span><span class=n>flow</span><span class=p>))</span> <span class=k>return</span> <span class=n>flow</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span><span class=o>&amp;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>cur</span><span class=p>[</span><span class=n>u</span><span class=p>];</span> <span class=o>~</span><span class=n>i</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>nxt</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>v</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>v</span><span class=p>,</span> <span class=n>d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>((</span><span class=n>dep</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>==</span> <span class=n>dep</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>d</span> <span class=o>=</span> <span class=n>dfs</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>min</span><span class=p>(</span><span class=n>flow</span> <span class=o>-</span> <span class=n>ret</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cap</span> <span class=o>-</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>flow</span><span class=p>))))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ret</span> <span class=o>+=</span> <span class=n>d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>flow</span> <span class=o>+=</span> <span class=n>d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>e</span><span class=p>[</span><span class=n>i</span> <span class=o>^</span> <span class=mi>1</span><span class=p>].</span><span class=n>flow</span> <span class=o>-=</span> <span class=n>d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=n>flow</span><span class=p>)</span> <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>dinic</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>bfs</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>memcpy</span><span class=p>(</span><span class=n>cur</span><span class=p>,</span> <span class=n>fir</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=o>*</span> 
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>maxflow</span> <span class=o>+=</span> <span class=n>dfs</span><span class=p>(</span><span class=n>S</span><span class=p>,</span> <span class=n>INF</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>mf</span><span class=p>;</span>
</span></span></code></pre></div><h3 id=费用流><a class=header-anchor href=#%e8%b4%b9%e7%94%a8%e6%b5%81></a>费用流</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>int</span> <span class=n>INF</span> <span class=o>=</span> <span class=mh>0x3f3f3f3f</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>edge</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>v</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>e</span><span class=p>[</span><span class=mi>100005</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>v</span><span class=p>,</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>p</span><span class=p>[</span><span class=mi>10005</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>mypair</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>dis</span><span class=p>,</span> <span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=k>operator</span><span class=o>&lt;</span><span class=p>(</span><span class=k>const</span> <span class=n>mypair</span><span class=o>&amp;</span> <span class=n>a</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=p>{</span> <span class=k>return</span> <span class=n>dis</span> <span class=o>&gt;</span> <span class=n>a</span><span class=p>.</span><span class=n>dis</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>mypair</span><span class=p>(</span><span class=kt>int</span> <span class=n>d</span><span class=p>,</span> <span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span> <span class=n>dis</span> <span class=o>=</span> <span class=n>d</span><span class=p>,</span> <span class=n>id</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>head</span><span class=p>[</span><span class=mi>5005</span><span class=p>],</span> <span class=n>dis</span><span class=p>[</span><span class=mi>5005</span><span class=p>],</span> <span class=n>vis</span><span class=p>[</span><span class=mi>5005</span><span class=p>],</span> <span class=n>h</span><span class=p>[</span><span class=mi>5005</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>t</span><span class=p>,</span> <span class=n>cnt</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>maxf</span><span class=p>,</span> <span class=n>minc</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addedge</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v</span><span class=p>,</span> <span class=kt>int</span> <span class=n>f</span><span class=p>,</span> <span class=kt>int</span> <span class=n>c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=p>[</span><span class=o>++</span><span class=n>cnt</span><span class=p>].</span><span class=n>v</span> <span class=o>=</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=p>[</span><span class=n>cnt</span><span class=p>].</span><span class=n>f</span> <span class=o>=</span> <span class=n>f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=p>[</span><span class=n>cnt</span><span class=p>].</span><span class=n>c</span> <span class=o>=</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>e</span><span class=p>[</span><span class=n>cnt</span><span class=p>].</span><span class=n>next</span> <span class=o>=</span> <span class=n>head</span><span class=p>[</span><span class=n>u</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>head</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>dijkstra</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>priority_queue</span><span class=o>&lt;</span><span class=n>mypair</span><span class=o>&gt;</span> <span class=n>q</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=n>dis</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>INF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>memset</span><span class=p>(</span><span class=n>vis</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>vis</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>dis</span><span class=p>[</span><span class=n>s</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>mypair</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>s</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>q</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>u</span> <span class=o>=</span> <span class=n>q</span><span class=p>.</span><span class=n>top</span><span class=p>().</span><span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>vis</span><span class=p>[</span><span class=n>u</span><span class=p>])</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>vis</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>head</span><span class=p>[</span><span class=n>u</span><span class=p>];</span> <span class=n>i</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>v</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>v</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>	        <span class=n>nc</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>c</span> <span class=o>+</span> <span class=n>h</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>-</span> <span class=n>h</span><span class=p>[</span><span class=n>v</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>f</span> <span class=o>&amp;&amp;</span> <span class=n>dis</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>dis</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>+</span> <span class=n>nc</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>dis</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>=</span> <span class=n>dis</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>+</span> <span class=n>nc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>[</span><span class=n>v</span><span class=p>].</span><span class=n>v</span> <span class=o>=</span> <span class=n>u</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=p>[</span><span class=n>v</span><span class=p>].</span><span class=n>e</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>vis</span><span class=p>[</span><span class=n>v</span><span class=p>])</span> 
</span></span><span class=line><span class=cl>	                <span class=n>q</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>mypair</span><span class=p>(</span><span class=n>dis</span><span class=p>[</span><span class=n>v</span><span class=p>],</span> <span class=n>v</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>dis</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>!=</span> <span class=n>INF</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>spfa</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>queue</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>q</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>memset</span><span class=p>(</span><span class=n>h</span><span class=p>,</span> <span class=mi>63</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>h</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=p>[</span><span class=n>s</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>vis</span><span class=p>[</span><span class=n>s</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>q</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>u</span> <span class=o>=</span> <span class=n>q</span><span class=p>.</span><span class=n>front</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>vis</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>head</span><span class=p>[</span><span class=n>u</span><span class=p>];</span> <span class=n>i</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>v</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>f</span> <span class=o>&amp;&amp;</span> <span class=n>h</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>h</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>+</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>h</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>=</span> <span class=n>h</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>+</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>vis</span><span class=p>[</span><span class=n>v</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>vis</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>q</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d%d%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>m</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>s</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>t</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d%d%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>u</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>f</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>addedge</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>addedge</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>u</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=n>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>spfa</span><span class=p>();</span>  <span class=c1>// 先求出初始势能
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=p>(</span><span class=n>dijkstra</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>minf</span> <span class=o>=</span> <span class=n>INF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>	        <span class=n>h</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>+=</span> <span class=n>dis</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>t</span><span class=p>;</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>s</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>v</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>	        <span class=n>minf</span> <span class=o>=</span> <span class=n>min</span><span class=p>(</span><span class=n>minf</span><span class=p>,</span> <span class=n>e</span><span class=p>[</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>e</span><span class=p>].</span><span class=n>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>t</span><span class=p>;</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>s</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=p>[</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>e</span><span class=p>].</span><span class=n>f</span> <span class=o>-=</span> <span class=n>minf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=p>[</span><span class=n>p</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>e</span> <span class=o>^</span> <span class=mi>1</span><span class=p>].</span><span class=n>f</span> <span class=o>+=</span> <span class=n>minf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>maxf</span> <span class=o>+=</span> <span class=n>minf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>minc</span> <span class=o>+=</span> <span class=n>minf</span> <span class=o>*</span> <span class=n>h</span><span class=p>[</span><span class=n>t</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>maxf</span><span class=p>,</span> <span class=n>minc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=二分图匹配><a class=header-anchor href=#%e4%ba%8c%e5%88%86%e5%9b%be%e5%8c%b9%e9%85%8d></a>二分图匹配</h3><p>最小点覆盖：选最少的点，满足每条边至少有一个端点被选。</p><p>最大独立集：选最多的点，满足两两之间没有边相连。</p><p>二分图最小点覆盖 = 最大匹配，最大独立集 = n - 最小点覆盖。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>augment_path</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;&gt;</span> <span class=n>g</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>pa</span><span class=p>;</span>  <span class=c1>// 匹配
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>pb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>vis</span><span class=p>;</span>  <span class=c1>// 访问
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>;</span>         <span class=c1>// 两个点集中的顶点数量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>dfn</span><span class=p>;</span>          <span class=c1>// 时间戳记
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>res</span><span class=p>;</span>          <span class=c1>// 匹配数
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>augment_path</span><span class=p>(</span><span class=kt>int</span> <span class=n>_n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>_m</span><span class=p>)</span> <span class=o>:</span> <span class=n>n</span><span class=p>(</span><span class=n>_n</span><span class=p>),</span> <span class=n>m</span><span class=p>(</span><span class=n>_m</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>assert</span><span class=p>(</span><span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>n</span> <span class=o>&amp;&amp;</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pa</span> <span class=o>=</span> <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>pb</span> <span class=o>=</span> <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>vis</span> <span class=o>=</span> <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>g</span><span class=p>.</span><span class=n>resize</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>dfn</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>add</span><span class=p>(</span><span class=kt>int</span> <span class=n>from</span><span class=p>,</span> <span class=kt>int</span> <span class=n>to</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>assert</span><span class=p>(</span><span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>from</span> <span class=o>&amp;&amp;</span> <span class=n>from</span> <span class=o>&lt;</span> <span class=n>n</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>         <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>to</span> <span class=o>&amp;&amp;</span> <span class=n>to</span> <span class=o>&lt;</span> <span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>g</span><span class=p>[</span><span class=n>from</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>to</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=nf>dfs</span><span class=p>(</span><span class=kt>int</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>vis</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>=</span> <span class=n>dfn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>u</span> <span class=p>:</span> <span class=n>g</span><span class=p>[</span><span class=n>v</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>pb</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>pb</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>pa</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>=</span> <span class=n>u</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>u</span> <span class=p>:</span> <span class=n>g</span><span class=p>[</span><span class=n>v</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>vis</span><span class=p>[</span><span class=n>pb</span><span class=p>[</span><span class=n>u</span><span class=p>]]</span> <span class=o>!=</span> <span class=n>dfn</span> 
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=n>dfs</span><span class=p>(</span><span class=n>pb</span><span class=p>[</span><span class=n>u</span><span class=p>]))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>pa</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>=</span> <span class=n>u</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>pb</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=nf>solve</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=nb>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>dfn</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>cnt</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>pa</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=n>dfs</span><span class=p>(</span><span class=n>i</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>cnt</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>cnt</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>+=</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><h3 id=2-sat><a class=header-anchor href=#2-sat></a>2-SAT</h3><p>假设有 a1,a2 和 b1,b2 两对，已知 a1和 b2 间有矛盾，于是为了方案自治，由于两者中必须选个，所以我们就要拉两条有向边(a1,61)和(b2,a2)表示选了 a1则必须选 b1，选了 b2 则必须选a2才能够自治。
然后通过这样子建边我们跑一遍 Tarian Scc判断是否有一个集合中的两个元素在同一个 SCC中若有则输出不可能，否则输出方案。构造方案只需要把几个不矛盾的 SCC拼起来就好了。
输出方案时可以通过变量在图中的拓扑序确定该变量的取值。如果变量x的拓扑序在 -x 之后，那么取x值为真。应用到 Tarian 算法的缩点，即:所在 SCC编号在 -x 之前时，取x为真。因为Tarjan 算法求强连通分量时使用了栈，所以 Tarian 求得的 SCC编号相当于反拓扑序。
显然地，时间复杂度为 O(n + m)。</p><h3 id=缩点><a class=header-anchor href=#%e7%bc%a9%e7%82%b9></a>缩点</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>dfn</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>low</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>dfncnt</span><span class=p>,</span> 
</span></span><span class=line><span class=cl><span class=n>s</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>in_stack</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>tp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>scc</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>sc</span><span class=p>;</span>  <span class=c1>// 结点 i 所在 SCC 的编号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>sz</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>       <span class=c1>// 强连通 i 的大小
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>tarjan</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=n>dfn</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=o>++</span><span class=n>dfncnt</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>[</span><span class=o>++</span><span class=n>tp</span><span class=p>]</span> <span class=o>=</span> <span class=n>u</span><span class=p>,</span> <span class=n>in_stack</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>h</span><span class=p>[</span><span class=n>u</span><span class=p>];</span> <span class=n>i</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>nex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=kt>int</span> <span class=o>&amp;</span><span class=n>v</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dfn</span><span class=p>[</span><span class=n>v</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>tarjan</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=nf>min</span><span class=p>(</span><span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>],</span> <span class=n>low</span><span class=p>[</span><span class=n>v</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>in_stack</span><span class=p>[</span><span class=n>v</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=nf>min</span><span class=p>(</span><span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>],</span> <span class=n>dfn</span><span class=p>[</span><span class=n>v</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>dfn</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>==</span> <span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>++</span><span class=n>sc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>tp</span><span class=p>]</span> <span class=o>!=</span> <span class=n>u</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>scc</span><span class=p>[</span><span class=n>s</span><span class=p>[</span><span class=n>tp</span><span class=p>]]</span> <span class=o>=</span> <span class=n>sc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>sz</span><span class=p>[</span><span class=n>sc</span><span class=p>]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>in_stack</span><span class=p>[</span><span class=n>s</span><span class=p>[</span><span class=n>tp</span><span class=p>]]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=o>--</span><span class=n>tp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>scc</span><span class=p>[</span><span class=n>s</span><span class=p>[</span><span class=n>tp</span><span class=p>]]</span> <span class=o>=</span> <span class=n>sc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>sz</span><span class=p>[</span><span class=n>sc</span><span class=p>]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>in_stack</span><span class=p>[</span><span class=n>s</span><span class=p>[</span><span class=n>tp</span><span class=p>]]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>--</span><span class=n>tp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;algorithm&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstdio&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>int</span> <span class=n>MN</span> <span class=o>=</span> <span class=mi>100005</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>N</span><span class=p>,</span> <span class=n>M</span><span class=p>,</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>G</span><span class=p>[</span><span class=n>MN</span><span class=p>],</span> <span class=n>T</span><span class=p>[</span><span class=n>MN</span> <span class=o>*</span> <span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>dfn</span><span class=p>[</span><span class=n>MN</span><span class=p>],</span> <span class=n>low</span><span class=p>[</span><span class=n>MN</span><span class=p>],</span> <span class=n>dfc</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>stk</span><span class=p>[</span><span class=n>MN</span><span class=p>],</span> <span class=n>tp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Tarjan</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;  Enter : #%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=n>dfn</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=o>++</span><span class=n>dfc</span><span class=p>;</span>                <span class=c1>// low 初始化为当前节点 dfn
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>stk</span><span class=p>[</span><span class=o>++</span><span class=n>tp</span><span class=p>]</span> <span class=o>=</span> <span class=n>u</span><span class=p>;</span>                          <span class=c1>// 加入栈中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>v</span> <span class=p>:</span> <span class=n>G</span><span class=p>[</span><span class=n>u</span><span class=p>])</span> <span class=p>{</span>                    <span class=c1>// 遍历 u 的相邻节点
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dfn</span><span class=p>[</span><span class=n>v</span><span class=p>])</span> <span class=p>{</span>                       <span class=c1>// 如果未访问过
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>Tarjan</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>                       <span class=c1>// 递归
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>],</span> <span class=n>low</span><span class=p>[</span><span class=n>v</span><span class=p>]);</span>  <span class=c1>// 未访问的和 low 取 min
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>low</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>==</span> <span class=n>dfn</span><span class=p>[</span><span class=n>u</span><span class=p>])</span> <span class=p>{</span>          <span class=c1>// 找到一个以 u 为根的 BCC
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>++</span><span class=n>cnt</span><span class=p>;</span>                       <span class=c1>// 增加方点个数
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;  Found a New BCC #%d.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>cnt</span> <span class=o>-</span> <span class=n>N</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 将点双中除了 u 的点退栈，并在圆方树中连边
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>x</span> <span class=o>!=</span> <span class=n>v</span><span class=p>;</span> <span class=o>--</span><span class=n>tp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>x</span> <span class=o>=</span> <span class=n>stk</span><span class=p>[</span><span class=n>tp</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                    <span class=n>T</span><span class=p>[</span><span class=n>cnt</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>T</span><span class=p>[</span><span class=n>x</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>cnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;    BCC #%d has vertex #%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>cnt</span> <span class=o>-</span> <span class=n>N</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 注意 u 自身也要连边（但不退栈）
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>T</span><span class=p>[</span><span class=n>cnt</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>T</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>cnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>printf</span><span class=p>(</span><span class=s>&#34;    BCC #%d has vertex #%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>cnt</span> <span class=o>-</span> <span class=n>N</span><span class=p>,</span> <span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>min</span><span class=p>(</span><span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>],</span> <span class=n>dfn</span><span class=p>[</span><span class=n>v</span><span class=p>]);</span>  <span class=c1>// 已访问的和 dfn 取 min
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;  Exit : #%d : low = %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>u</span><span class=p>,</span> <span class=n>low</span><span class=p>[</span><span class=n>u</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;  Stack:</span><span class=se>\n</span><span class=s>    &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>tp</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d, &#34;</span><span class=p>,</span> <span class=n>stk</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>N</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>M</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>cnt</span> <span class=o>=</span> <span class=n>N</span><span class=p>;</span>  <span class=c1>// 点双 / 方点标号从 N 开始
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>M</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>u</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>G</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>  <span class=c1>// 加双向边
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>G</span><span class=p>[</span><span class=n>v</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 处理非连通图
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>u</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>u</span> <span class=o>&lt;=</span> <span class=n>N</span><span class=p>;</span> <span class=o>++</span><span class=n>u</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dfn</span><span class=p>[</span><span class=n>u</span><span class=p>])</span> <span class=n>Tarjan</span><span class=p>(</span><span class=n>u</span><span class=p>),</span> <span class=o>--</span><span class=n>tp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 注意到退出 Tarjan 时栈中还有一个元素即根，将其退栈
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=普通环计数><a class=header-anchor href=#%e6%99%ae%e9%80%9a%e7%8e%af%e8%ae%a1%e6%95%b0></a>普通环计数</h3><p>状压</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Edge</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>to</span><span class=p>,</span> <span class=n>nxt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>edge</span><span class=p>[</span><span class=mi>500</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>cntEdge</span><span class=p>,</span> <span class=n>head</span><span class=p>[</span><span class=mi>20</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addEdge</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>edge</span><span class=p>[</span><span class=o>++</span><span class=n>cntEdge</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span><span class=p>,</span> <span class=n>head</span><span class=p>[</span><span class=n>u</span><span class=p>]},</span> <span class=n>head</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=n>cntEdge</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>long</span> <span class=kt>long</span> <span class=n>answer</span><span class=p>,</span> <span class=n>dp</span><span class=p>[</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=mi>19</span><span class=p>][</span><span class=mi>20</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span><span class=p>.</span><span class=n>tie</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>sync_with_stdio</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>u</span> <span class=o>&gt;&gt;</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>addEdge</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>addEdge</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=n>dp</span><span class=p>[</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)][</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>s</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>s</span> <span class=o>&lt;</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>n</span><span class=p>);</span> <span class=n>s</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dp</span><span class=p>[</span><span class=n>s</span><span class=p>][</span><span class=n>i</span><span class=p>])</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>head</span><span class=p>[</span><span class=n>i</span><span class=p>];</span> <span class=n>j</span><span class=p>;</span> <span class=n>j</span> <span class=o>=</span> <span class=n>edge</span><span class=p>[</span><span class=n>j</span><span class=p>].</span><span class=n>nxt</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>int</span> <span class=n>u</span> <span class=o>=</span> <span class=n>i</span><span class=p>,</span> <span class=n>v</span> <span class=o>=</span> <span class=n>edge</span><span class=p>[</span><span class=n>j</span><span class=p>].</span><span class=n>to</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>((</span><span class=n>s</span> <span class=o>&amp;</span> <span class=o>-</span><span class=n>s</span><span class=p>)</span> <span class=o>&gt;</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>v</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)))</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>s</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>v</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>((</span><span class=n>s</span> <span class=o>&amp;</span> <span class=o>-</span><span class=n>s</span><span class=p>)</span> <span class=o>==</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>v</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)))</span> 
</span></span><span class=line><span class=cl>                        <span class=n>answer</span> <span class=o>+=</span> <span class=n>dp</span><span class=p>[</span><span class=n>s</span><span class=p>][</span><span class=n>u</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=n>dp</span><span class=p>[</span><span class=n>s</span> <span class=o>|</span> <span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>v</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))][</span><span class=n>v</span><span class=p>]</span> <span class=o>+=</span> <span class=n>dp</span><span class=p>[</span><span class=n>s</span><span class=p>][</span><span class=n>u</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>answer</span> <span class=o>-</span> <span class=n>m</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span> <span class=o>&lt;&lt;</span> <span class=sc>&#39;\n&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=三元环计数><a class=header-anchor href=#%e4%b8%89%e5%85%83%e7%8e%af%e8%ae%a1%e6%95%b0></a>三元环计数</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>total</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>deg</span><span class=p>[</span><span class=mi>200001</span><span class=p>],</span> <span class=n>u</span><span class=p>[</span><span class=mi>200001</span><span class=p>],</span> <span class=n>v</span><span class=p>[</span><span class=mi>200001</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=n>vis</span><span class=p>[</span><span class=mi>200001</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Edge</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>to</span><span class=p>,</span> <span class=n>nxt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>edge</span><span class=p>[</span><span class=mi>200001</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>cntEdge</span><span class=p>,</span> <span class=n>head</span><span class=p>[</span><span class=mi>100001</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>addEdge</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>edge</span><span class=p>[</span><span class=o>++</span><span class=n>cntEdge</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span><span class=p>,</span> <span class=n>head</span><span class=p>[</span><span class=n>u</span><span class=p>]},</span> <span class=n>head</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>=</span> <span class=n>cntEdge</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span><span class=p>.</span><span class=n>tie</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>sync_with_stdio</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>u</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>deg</span><span class=p>[</span><span class=n>u</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span><span class=o>++</span><span class=p>,</span> <span class=n>deg</span><span class=p>[</span><span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>deg</span><span class=p>[</span><span class=n>u</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span> <span class=o>==</span> <span class=n>deg</span><span class=p>[</span><span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span> <span class=o>&amp;&amp;</span> <span class=n>u</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>||</span> 
</span></span><span class=line><span class=cl>            <span class=n>deg</span><span class=p>[</span><span class=n>u</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span> <span class=o>&lt;</span> <span class=n>deg</span><span class=p>[</span><span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>            <span class=n>swap</span><span class=p>(</span><span class=n>u</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>addEdge</span><span class=p>(</span><span class=n>u</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>u</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>u</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>u</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>head</span><span class=p>[</span><span class=n>u</span><span class=p>];</span> <span class=n>i</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>edge</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>nxt</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=n>vis</span><span class=p>[</span><span class=n>edge</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>to</span><span class=p>]</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>head</span><span class=p>[</span><span class=n>u</span><span class=p>];</span> <span class=n>i</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>edge</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>nxt</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>v</span> <span class=o>=</span> <span class=n>edge</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>to</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>head</span><span class=p>[</span><span class=n>v</span><span class=p>];</span> <span class=n>j</span><span class=p>;</span> <span class=n>j</span> <span class=o>=</span> <span class=n>edge</span><span class=p>[</span><span class=n>j</span><span class=p>].</span><span class=n>nxt</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>int</span> <span class=n>w</span> <span class=o>=</span> <span class=n>edge</span><span class=p>[</span><span class=n>j</span><span class=p>].</span><span class=n>to</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>vis</span><span class=p>[</span><span class=n>w</span><span class=p>])</span> <span class=n>total</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>head</span><span class=p>[</span><span class=n>u</span><span class=p>];</span> <span class=n>i</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>edge</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>nxt</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=n>vis</span><span class=p>[</span><span class=n>edge</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>to</span><span class=p>]</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>total</span> <span class=o>&lt;&lt;</span> <span class=sc>&#39;\n&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=四元环计数><a class=header-anchor href=#%e5%9b%9b%e5%85%83%e7%8e%af%e8%ae%a1%e6%95%b0></a>四元环计数</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;vector&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>deg</span><span class=p>[</span><span class=mi>100001</span><span class=p>],</span> <span class=n>cnt</span><span class=p>[</span><span class=mi>100001</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>E</span><span class=p>[</span><span class=mi>100001</span><span class=p>],</span> <span class=n>E1</span><span class=p>[</span><span class=mi>100001</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>long</span> <span class=kt>long</span> <span class=n>total</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span><span class=p>.</span><span class=n>tie</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>sync_with_stdio</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>u</span> <span class=o>&gt;&gt;</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>E</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>E</span><span class=p>[</span><span class=n>v</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>deg</span><span class=p>[</span><span class=n>u</span><span class=p>]</span><span class=o>++</span><span class=p>,</span> <span class=n>deg</span><span class=p>[</span><span class=n>v</span><span class=p>]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>u</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>u</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>u</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>v</span> <span class=p>:</span> <span class=n>E</span><span class=p>[</span><span class=n>u</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>deg</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>deg</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>||</span> <span class=p>(</span><span class=n>deg</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>==</span> <span class=n>deg</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=n>u</span> <span class=o>&gt;</span> <span class=n>v</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>                <span class=n>E1</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>a</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>a</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>b</span> <span class=p>:</span> <span class=n>E1</span><span class=p>[</span><span class=n>a</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>c</span> <span class=p>:</span> <span class=n>E</span><span class=p>[</span><span class=n>b</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>deg</span><span class=p>[</span><span class=n>a</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>deg</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>||</span> <span class=p>(</span><span class=n>deg</span><span class=p>[</span><span class=n>a</span><span class=p>]</span> <span class=o>==</span> <span class=n>deg</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=n>a</span> <span class=o>&lt;=</span> <span class=n>c</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>                    <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>total</span> <span class=o>+=</span> <span class=n>cnt</span><span class=p>[</span><span class=n>c</span><span class=p>]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>b</span> <span class=p>:</span> <span class=n>E1</span><span class=p>[</span><span class=n>a</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>c</span> <span class=p>:</span> <span class=n>E</span><span class=p>[</span><span class=n>b</span><span class=p>])</span> 
</span></span><span class=line><span class=cl>                <span class=n>cnt</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>total</span> <span class=o>&lt;&lt;</span> <span class=sc>&#39;\n&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=lca><a class=header-anchor href=#lca></a>LCA</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>int</span> <span class=n>MXN</span> <span class=o>=</span> <span class=mi>40005</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>v</span><span class=p>[</span><span class=n>MXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>w</span><span class=p>[</span><span class=n>MXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>fa</span><span class=p>[</span><span class=n>MXN</span><span class=p>][</span><span class=mi>31</span><span class=p>],</span> <span class=n>cost</span><span class=p>[</span><span class=n>MXN</span><span class=p>][</span><span class=mi>31</span><span class=p>],</span> <span class=n>dep</span><span class=p>[</span><span class=n>MXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dfs</span><span class=p>(</span><span class=kt>int</span> <span class=n>root</span><span class=p>,</span> <span class=kt>int</span> <span class=n>fno</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>fa</span><span class=p>[</span><span class=n>root</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>fno</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>dep</span><span class=p>[</span><span class=n>root</span><span class=p>]</span> <span class=o>=</span> <span class=n>dep</span><span class=p>[</span><span class=n>fa</span><span class=p>[</span><span class=n>root</span><span class=p>][</span><span class=mi>0</span><span class=p>]]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>31</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>fa</span><span class=p>[</span><span class=n>root</span><span class=p>][</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>fa</span><span class=p>[</span><span class=n>fa</span><span class=p>[</span><span class=n>root</span><span class=p>][</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]][</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>cost</span><span class=p>[</span><span class=n>root</span><span class=p>][</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>cost</span><span class=p>[</span><span class=n>fa</span><span class=p>[</span><span class=n>root</span><span class=p>][</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]][</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>cost</span><span class=p>[</span><span class=n>root</span><span class=p>][</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sz</span> <span class=o>=</span> <span class=n>v</span><span class=p>[</span><span class=n>root</span><span class=p>].</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sz</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>v</span><span class=p>[</span><span class=n>root</span><span class=p>][</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>fno</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>cost</span><span class=p>[</span><span class=n>v</span><span class=p>[</span><span class=n>root</span><span class=p>][</span><span class=n>i</span><span class=p>]][</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>w</span><span class=p>[</span><span class=n>root</span><span class=p>][</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>dfs</span><span class=p>(</span><span class=n>v</span><span class=p>[</span><span class=n>root</span><span class=p>][</span><span class=n>i</span><span class=p>],</span> <span class=n>root</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>lca</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>dep</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>dep</span><span class=p>[</span><span class=n>y</span><span class=p>])</span> <span class=n>swap</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>tmp</span> <span class=o>=</span> <span class=n>dep</span><span class=p>[</span><span class=n>y</span><span class=p>]</span> <span class=o>-</span> <span class=n>dep</span><span class=p>[</span><span class=n>x</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>tmp</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>,</span> <span class=n>tmp</span> <span class=o>&gt;&gt;=</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>tmp</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span> <span class=o>=</span> <span class=n>fa</span><span class=p>[</span><span class=n>y</span><span class=p>][</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>y</span> <span class=o>==</span> <span class=n>x</span><span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>30</span><span class=p>;</span> <span class=n>j</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>y</span> <span class=o>!=</span> <span class=n>x</span><span class=p>;</span> <span class=o>--</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>fa</span><span class=p>[</span><span class=n>x</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>!=</span> <span class=n>fa</span><span class=p>[</span><span class=n>y</span><span class=p>][</span><span class=n>j</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>=</span> <span class=n>fa</span><span class=p>[</span><span class=n>x</span><span class=p>][</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span> <span class=o>=</span> <span class=n>fa</span><span class=p>[</span><span class=n>y</span><span class=p>][</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>cost</span><span class=p>[</span><span class=n>x</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>cost</span><span class=p>[</span><span class=n>y</span><span class=p>][</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=树的直径><a class=header-anchor href=#%e6%a0%91%e7%9a%84%e7%9b%b4%e5%be%84></a>树的直径</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>int</span> <span class=n>N</span> <span class=o>=</span> <span class=mi>10000</span> <span class=o>+</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>d</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>E</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dfs</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=kt>int</span> <span class=n>fa</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>v</span> <span class=p>:</span> <span class=n>E</span><span class=p>[</span><span class=n>u</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>v</span> <span class=o>==</span> <span class=n>fa</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>d</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>=</span> <span class=n>d</span><span class=p>[</span><span class=n>u</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>d</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>d</span><span class=p>[</span><span class=n>c</span><span class=p>])</span> <span class=n>c</span> <span class=o>=</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>dfs</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d %d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>u</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>E</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>v</span><span class=p>),</span> <span class=n>E</span><span class=p>[</span><span class=n>v</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>dfs</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span><span class=p>[</span><span class=n>c</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>dfs</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>d</span><span class=p>[</span><span class=n>c</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=树的中心><a class=header-anchor href=#%e6%a0%91%e7%9a%84%e4%b8%ad%e5%bf%83></a>树的中心</h3><p>在树中，如果节点 x作为根节点时，从 x 出发的最长链最短，那么称 x 为这棵树的中心。</p><ol><li>维护 <code>len1x</code>，表示节点x子树内的最长链。</li><li>维护 <code>len2x</code>，表示不与 <code>len1x</code> 重叠的最长链。</li><li>维护 <code>upx</code>，表示节点x子树外的最长链，该链必定经过x的父节点。</li><li>找到点x使得 <code>max(len1x, upx)</code> 最小，那么x即为树的中心。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// 这份代码默认节点编号从 1 开始，即 i ∈ [1,n]，使用vector存图
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>d1</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>d2</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>up</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>mini</span> <span class=o>=</span> <span class=mf>1e9</span><span class=p>;</span>  <span class=c1>// d1,d2对应上文中的len1,len2
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>to</span><span class=p>,</span> <span class=n>val</span><span class=p>;</span>  <span class=c1>// to为边指向的节点，val为边权
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=n>node</span><span class=o>&gt;</span> <span class=n>nbr</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dfsd</span><span class=p>(</span><span class=kt>int</span> <span class=n>cur</span><span class=p>,</span> <span class=kt>int</span> <span class=n>fa</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// 求取len1和len2
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=n>node</span> <span class=nl>nxtn</span> <span class=p>:</span> <span class=n>nbr</span><span class=p>[</span><span class=n>cur</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>nxt</span> <span class=o>=</span> <span class=n>nxtn</span><span class=p>.</span><span class=n>to</span><span class=p>,</span> <span class=n>w</span> <span class=o>=</span> <span class=n>nxtn</span><span class=p>.</span><span class=n>val</span><span class=p>;</span>  <span class=c1>// nxt为这条边通向的节点，val为边权
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>nxt</span> <span class=o>==</span> <span class=n>fa</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>dfsd</span><span class=p>(</span><span class=n>nxt</span><span class=p>,</span> <span class=n>cur</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>d1</span><span class=p>[</span><span class=n>nxt</span><span class=p>]</span> <span class=o>+</span> <span class=n>w</span> <span class=o>&gt;</span> <span class=n>d1</span><span class=p>[</span><span class=n>cur</span><span class=p>])</span> <span class=p>{</span>  <span class=c1>// 可以更新最长链
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>d2</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>=</span> <span class=n>d1</span><span class=p>[</span><span class=n>cur</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=n>d1</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>=</span> <span class=n>d1</span><span class=p>[</span><span class=n>nxt</span><span class=p>]</span> <span class=o>+</span> <span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>d1</span><span class=p>[</span><span class=n>nxt</span><span class=p>]</span> <span class=o>+</span> <span class=n>w</span> <span class=o>&gt;</span> <span class=n>d2</span><span class=p>[</span><span class=n>cur</span><span class=p>])</span> <span class=p>{</span>  <span class=c1>// 不能更新最长链，但可更新次长链
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>d2</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>=</span> <span class=n>d1</span><span class=p>[</span><span class=n>nxt</span><span class=p>]</span> <span class=o>+</span> <span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dfsu</span><span class=p>(</span><span class=kt>int</span> <span class=n>cur</span><span class=p>,</span> <span class=kt>int</span> <span class=n>fa</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>node</span> <span class=nl>nxtn</span> <span class=p>:</span> <span class=n>nbr</span><span class=p>[</span><span class=n>cur</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>nxt</span> <span class=o>=</span> <span class=n>nxtn</span><span class=p>.</span><span class=n>to</span><span class=p>,</span> <span class=n>w</span> <span class=o>=</span> <span class=n>nxtn</span><span class=p>.</span><span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>nxt</span> <span class=o>==</span> <span class=n>fa</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>up</span><span class=p>[</span><span class=n>nxt</span><span class=p>]</span> <span class=o>=</span> <span class=n>up</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>+</span> <span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>d1</span><span class=p>[</span><span class=n>nxt</span><span class=p>]</span> <span class=o>+</span> <span class=n>w</span> <span class=o>!=</span> <span class=n>d1</span><span class=p>[</span><span class=n>cur</span><span class=p>])</span> <span class=p>{</span>  <span class=c1>// 如果自己子树里的最长链不在nxt子树里
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>up</span><span class=p>[</span><span class=n>nxt</span><span class=p>]</span> <span class=o>=</span> <span class=n>max</span><span class=p>(</span><span class=n>up</span><span class=p>[</span><span class=n>nxt</span><span class=p>],</span> <span class=n>d1</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>+</span> <span class=n>w</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>  <span class=c1>// 自己子树里的最长链在nxt子树里，只能使用次长链
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>up</span><span class=p>[</span><span class=n>nxt</span><span class=p>]</span> <span class=o>=</span> <span class=n>max</span><span class=p>(</span><span class=n>up</span><span class=p>[</span><span class=n>nxt</span><span class=p>],</span> <span class=n>d2</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>+</span> <span class=n>w</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>dfsu</span><span class=p>(</span><span class=n>nxt</span><span class=p>,</span> <span class=n>cur</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>GetTreeCenter</span><span class=p>()</span> <span class=p>{</span>  <span class=c1>// 统计树的中心，记为x和y（若存在）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>dfsd</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>dfsu</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>max</span><span class=p>(</span><span class=n>d1</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>up</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>&lt;</span> <span class=n>mini</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// 找到了当前max(len1[x],up[x])最小点
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>mini</span> <span class=o>=</span> <span class=n>max</span><span class=p>(</span><span class=n>d1</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>up</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>      <span class=n>x</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>max</span><span class=p>(</span><span class=n>d1</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>up</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>==</span> <span class=n>mini</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// 另一个中心
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>y</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=树的重心><a class=header-anchor href=#%e6%a0%91%e7%9a%84%e9%87%8d%e5%bf%83></a>树的重心</h3><p>如果在树中选择某个节点并删除，这棵树将分为若干棵子树，统计子树节点数并记录最大值。取遍树上所有节点，使此最大值取到最小的节点被称为整个树的重心。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// 这份代码默认节点编号从 1 开始，即 i ∈ [1,n]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>size</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span>  <span class=c1>// 这个节点的「大小」（所有子树上节点数 + 该节点）
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>weight</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span>  <span class=c1>// 这个节点的「重量」，即所有子树「大小」的最大值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>centroid</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>  <span class=c1>// 用于记录树的重心（存的是节点编号）
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>GetCentroid</span><span class=p>(</span><span class=kt>int</span> <span class=n>cur</span><span class=p>,</span> <span class=kt>int</span> <span class=n>fa</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>weight</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>head</span><span class=p>[</span><span class=n>cur</span><span class=p>];</span> <span class=n>i</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>nxt</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>to</span> <span class=o>!=</span> <span class=n>fa</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>GetCentroid</span><span class=p>(</span><span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>to</span><span class=p>,</span> <span class=n>cur</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>size</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>+=</span> <span class=n>size</span><span class=p>[</span><span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>to</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=n>weight</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>=</span> <span class=n>max</span><span class=p>(</span><span class=n>weight</span><span class=p>[</span><span class=n>cur</span><span class=p>],</span> <span class=n>size</span><span class=p>[</span><span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>to</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>weight</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>=</span> <span class=n>max</span><span class=p>(</span><span class=n>weight</span><span class=p>[</span><span class=n>cur</span><span class=p>],</span> <span class=n>n</span> <span class=o>-</span> <span class=n>size</span><span class=p>[</span><span class=n>cur</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>weight</span><span class=p>[</span><span class=n>cur</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>n</span> <span class=o>/</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>centroid</span><span class=p>[</span><span class=n>centroid</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>cur</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=树链剖分><a class=header-anchor href=#%e6%a0%91%e9%93%be%e5%89%96%e5%88%86></a>树链剖分</h3><p>定义 <strong>重子节点</strong> 表示其子节点中子树最大的子结点。如果有多个子树最大的子结点，取其一。如果没有子节点，就无重子节点。</p><p>定义 <strong>轻子节点</strong> 表示剩余的所有子结点。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dfs1</span><span class=p>(</span><span class=kt>int</span> <span class=n>o</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>son</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>siz</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>h</span><span class=p>[</span><span class=n>o</span><span class=p>];</span> <span class=n>j</span><span class=p>;</span> <span class=n>j</span> <span class=o>=</span> <span class=n>nxt</span><span class=p>[</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dep</span><span class=p>[</span><span class=n>p</span><span class=p>[</span><span class=n>j</span><span class=p>]])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>dep</span><span class=p>[</span><span class=n>p</span><span class=p>[</span><span class=n>j</span><span class=p>]]</span> <span class=o>=</span> <span class=n>dep</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>fa</span><span class=p>[</span><span class=n>p</span><span class=p>[</span><span class=n>j</span><span class=p>]]</span> <span class=o>=</span> <span class=n>o</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>dfs1</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=n>siz</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>+=</span> <span class=n>siz</span><span class=p>[</span><span class=n>p</span><span class=p>[</span><span class=n>j</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>son</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=o>||</span> <span class=n>siz</span><span class=p>[</span><span class=n>p</span><span class=p>[</span><span class=n>j</span><span class=p>]]</span> <span class=o>&gt;</span> <span class=n>siz</span><span class=p>[</span><span class=n>son</span><span class=p>[</span><span class=n>o</span><span class=p>]])</span> <span class=n>son</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>=</span> <span class=n>p</span><span class=p>[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dfs2</span><span class=p>(</span><span class=kt>int</span> <span class=n>o</span><span class=p>,</span> <span class=kt>int</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>top</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>=</span> <span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>cnt</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>dfn</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>=</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>rnk</span><span class=p>[</span><span class=n>cnt</span><span class=p>]</span> <span class=o>=</span> <span class=n>o</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>son</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>dfs2</span><span class=p>(</span><span class=n>son</span><span class=p>[</span><span class=n>o</span><span class=p>],</span> <span class=n>t</span><span class=p>);</span>  <span class=c1>// 优先对重儿子进行 DFS，可以保证同一条重链上的点 DFS 序连续
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>h</span><span class=p>[</span><span class=n>o</span><span class=p>];</span> <span class=n>j</span><span class=p>;</span> <span class=n>j</span> <span class=o>=</span> <span class=n>nxt</span><span class=p>[</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>!=</span> <span class=n>son</span><span class=p>[</span><span class=n>o</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=n>p</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>!=</span> <span class=n>fa</span><span class=p>[</span><span class=n>o</span><span class=p>])</span> <span class=n>dfs2</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>j</span><span class=p>],</span> <span class=n>p</span><span class=p>[</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=路径查询><a class=header-anchor href=#%e8%b7%af%e5%be%84%e6%9f%a5%e8%af%a2></a>路径查询</h4><p>用树链剖分求树上两点路径权值和，伪代码如下:</p><p><strong>TREE-PATH-SUM(u,v)</strong></p><ol><li>tot ← 0</li><li>while u.top is not v.top</li><li>if u.top.deep &lt; v.top.deep</li><li>SWAP(u,v)</li><li>tot ← tot + sum of values between u and u.top</li><li>u ← u.top father</li><li>tot ← tot + sum of values between u and v</li><li>return tot</li></ol><p>链上的DFS序是连续的，可以使用线段树、树状数组维护。</p><p>每次选择深度较大的链往上跳，直到两点在同一条链上。</p><p>同样的跳链结构适用于维护、统计路径上的其他信息。</p><h4 id=子树维护><a class=header-anchor href=#%e5%ad%90%e6%a0%91%e7%bb%b4%e6%8a%a4></a>子树维护</h4><p>有时会要求，维护子树上的信息，譬如将以x为根的子树的所有结点的权值增加v。</p><p>在DFS搜索的时候，子树中的结点的DFS序是连续的。</p><p>每一个结点记录bottom表示所在子树连续区间末端的结点。</p><p>这样就把子树信息转化为连续的一段区间信息。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// st 是线段树结构体
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>querymax</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=o>-</span><span class=n>inf</span><span class=p>,</span> <span class=n>fx</span> <span class=o>=</span> <span class=n>top</span><span class=p>[</span><span class=n>x</span><span class=p>],</span> <span class=n>fy</span> <span class=o>=</span> <span class=n>top</span><span class=p>[</span><span class=n>y</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>fx</span> <span class=o>!=</span> <span class=n>fy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>dep</span><span class=p>[</span><span class=n>fx</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>dep</span><span class=p>[</span><span class=n>fy</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=n>max</span><span class=p>(</span><span class=n>ret</span><span class=p>,</span> <span class=n>st</span><span class=p>.</span><span class=n>query1</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>dfn</span><span class=p>[</span><span class=n>fx</span><span class=p>],</span> <span class=n>dfn</span><span class=p>[</span><span class=n>x</span><span class=p>])),</span> <span class=n>x</span> <span class=o>=</span> <span class=n>fa</span><span class=p>[</span><span class=n>fx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span> <span class=o>=</span> <span class=n>max</span><span class=p>(</span><span class=n>ret</span><span class=p>,</span> <span class=n>st</span><span class=p>.</span><span class=n>query1</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>dfn</span><span class=p>[</span><span class=n>fy</span><span class=p>],</span> <span class=n>dfn</span><span class=p>[</span><span class=n>y</span><span class=p>])),</span> <span class=n>y</span> <span class=o>=</span> <span class=n>fa</span><span class=p>[</span><span class=n>fy</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>fx</span> <span class=o>=</span> <span class=n>top</span><span class=p>[</span><span class=n>x</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>fy</span> <span class=o>=</span> <span class=n>top</span><span class=p>[</span><span class=n>y</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>dfn</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>dfn</span><span class=p>[</span><span class=n>y</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=n>max</span><span class=p>(</span><span class=n>ret</span><span class=p>,</span> <span class=n>st</span><span class=p>.</span><span class=n>query1</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>dfn</span><span class=p>[</span><span class=n>x</span><span class=p>],</span> <span class=n>dfn</span><span class=p>[</span><span class=n>y</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>ret</span> <span class=o>=</span> <span class=n>max</span><span class=p>(</span><span class=n>ret</span><span class=p>,</span> <span class=n>st</span><span class=p>.</span><span class=n>query1</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>dfn</span><span class=p>[</span><span class=n>y</span><span class=p>],</span> <span class=n>dfn</span><span class=p>[</span><span class=n>x</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=dsu-on-tree><a class=header-anchor href=#dsu-on-tree></a>dsu on tree</h3><p>例：给出一棵 n 个节点以 1 为根的树，节点 u 的颜色为 $c_u$，现在对于每个结点 u 询问以 u 为根的子树里一共出现了多少种不同的颜色。</p><p>既然支持离线，考虑预处理后 $O(1)$ 输出答案。</p><p>我们用 $cnt_i$ 表示颜色 i 的出现次数，$ans_u$ 表示结点 u 的答案。</p><p>遍历一个节点 u，我们按以下的步骤进行遍历：</p><ol><li>先遍历 u 的轻（非重）儿子，并计算答案，但不保留遍历后它对 cnt 数组的影响；</li><li>遍历它的重儿子，保留它对 cnt 数组的影响；</li><li>再次遍历 u 的轻儿子的子树结点，加入这些结点的贡献，以得到 u 的答案。</li></ol><h2 id=数论><a class=header-anchor href=#%e6%95%b0%e8%ae%ba></a>数论</h2><h3 id=线性筛><a class=header-anchor href=#%e7%ba%bf%e6%80%a7%e7%ad%9b></a>线性筛</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>pri</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=n>not_prime</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=c1>// int  phi[N]; 欧拉函数
</span></span></span><span class=line><span class=cl><span class=c1>// int  mu[N]; 莫比乌斯函数
</span></span></span><span class=line><span class=cl><span class=c1>// int  d[N]; i的约数个数
</span></span></span><span class=line><span class=cl><span class=c1>// int num[N]; i的最小质因子出现次数
</span></span></span><span class=line><span class=cl><span class=c1>// int  g[N],  f[N]; i的约束和，i的最小质因子0~k幂次和
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>pre</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// phi[1]  =  1;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// mu[1]  =  1;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// d[1]  =  1;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// g[1]  =  f[1]  =  1;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>not_prime</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>pri</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// phi[i]  =  i  -  1;
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// mu[i]  =  -1;
</span></span></span><span class=line><span class=cl><span class=c1></span>	        <span class=c1>// d[i]  =  2;  
</span></span></span><span class=line><span class=cl><span class=c1></span>	        <span class=c1>// num[i]  =  1;
</span></span></span><span class=line><span class=cl><span class=c1></span>	        <span class=c1>// g[i]  =  i  +  1;  
</span></span></span><span class=line><span class=cl><span class=c1></span>	        <span class=c1>// f[i]  =  i  +  1;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>pri_j</span> <span class=p>:</span> <span class=n>pri</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>*</span> <span class=n>pri_j</span> <span class=o>&gt;</span> <span class=n>n</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>not_prime</span><span class=p>[</span><span class=n>i</span> <span class=o>*</span> <span class=n>pri_j</span><span class=p>]</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>%</span> <span class=n>pri_j</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	            <span class=c1>// phi[i  *  pri_j]  =  phi[i]  *  pri_j;
</span></span></span><span class=line><span class=cl><span class=c1></span>	            <span class=c1>// mu[i  *  pri_j]  =  0;
</span></span></span><span class=line><span class=cl><span class=c1></span>	            <span class=c1>// num[i  *  pri_j]  =  num[i]  +  1;  
</span></span></span><span class=line><span class=cl><span class=c1></span>	            <span class=c1>// d[i  *  pri_j]  =  d[i]  /  num[i  *  pri_j]  
</span></span></span><span class=line><span class=cl><span class=c1></span>	            <span class=c1>// *  (num[i  *  pri_j]  +  1);
</span></span></span><span class=line><span class=cl><span class=c1></span>	            <span class=c1>// g[i  *  pri_j]  =  g[i]  *  pri_j  +  1;  
</span></span></span><span class=line><span class=cl><span class=c1></span>	            <span class=c1>// f[i  *  pri_j]  =  f[i]  /  g[i]  
</span></span></span><span class=line><span class=cl><span class=c1></span>	            <span class=c1>// *  g[i  *  pri_j];
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// phi[i  *  pri_j]  =  phi[i]  *  phi[pri_j];&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// mu[i  *  pri_j]  =  -mu[i];
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// num[i  *  pri_j]  =  1;  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// d[i  *  pri_j]  =  d[i]  *  2;
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// f[i  *  pri_j]  =  f[i]  *  f[pri_j];  
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// g[i  *  pri_j]  =  1  +  pri_j;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>莫比乌斯函数 $μ(n)$的定义如下：</p><ol><li><strong>如果 n=1</strong>，则 $μ(1)=1$ 。</li><li><strong>如果 n 是一个正整数，且其质因数分解中没有重复的质因数</strong>（即 nn 是一个平方自由数），则 $μ(n)$ 的值为：<ul><li>$μ(n)=(−1)^k$，其中 k 是 n 的不同质因数的个数。</li></ul></li><li><strong>如果 n 不是平方自由数</strong>（即 n 的质因数分解中有某个质因数的指数大于1），则 $μ(n)=0$。</li></ol><h3 id=数论分块><a class=header-anchor href=#%e6%95%b0%e8%ae%ba%e5%88%86%e5%9d%97></a>数论分块</h3><p>数论分块可以快速计算一些含有除法向下取整的和式（即形如 $\sum_{i=1}^{n} f(i) g(\left\lfloor \frac{n}{i} \right\rfloor)$ 的和式）。当可以在 O(1) 内计算 $f(r) - f(l)$ 或已经预处理出 f 的前缀和时，数论分块就可以在 $O(\sqrt{n})$ 的时间内计算上述和式的值。</p><p>它主要利用了富比尼定理（Fubini&rsquo;s theorem），将 n 相同的数打包同时计算。</p><h4 id=数论分块结论><a class=header-anchor href=#%e6%95%b0%e8%ae%ba%e5%88%86%e5%9d%97%e7%bb%93%e8%ae%ba></a>数论分块结论</h4><p>对于常数 n，使得式子$\lfloor \frac{n}{i} \rfloor = \lfloor \frac{n}{j} \rfloor$成立且满足 $i \leq j \leq n$ 的 j 值最大为：$\left\lfloor \frac{n}{\left\lfloor \frac{n}{i} \right\rfloor} \right\rfloor$</p><p>即值$\lfloor \frac{n}{i} \rfloor$所在块的右端点为 $\left\lfloor \frac{n}{\left\lfloor \frac{n}{i} \right\rfloor} \right\rfloor$。</p><h4 id=数论分块的过程><a class=header-anchor href=#%e6%95%b0%e8%ae%ba%e5%88%86%e5%9d%97%e7%9a%84%e8%bf%87%e7%a8%8b></a>数论分块的过程</h4><p>大概如下：考虑和式</p>$$
\sum_{i=1}^n f(i) \left\lfloor \frac{n}{i} \right\rfloor
$$<p>那么由于我们可以知道 $\left\lfloor \frac{n}{i} \right\rfloor$ 的值成一个块状分布（就是同样的值都聚集在连续的块中），那么就可以用数论分块加速计算，降低时间复杂度。</p><p>利用上述结论，我们先求出 f(i) 的前缀和（记作 $s(i) = \sum_{j=1}^i f(j)$），然后每次以 $[l, r] = \left[l, \left\lfloor \frac{n}{\left\lfloor \frac{n}{i} \right\rfloor} \right\rfloor\right]$ 为一块，分块求出贡献累加到结果中即可。</p><p>伪代码如下：</p><ol><li>Calculate s(i), the prefix sum of f(i).</li><li>$l \leftarrow 1$</li><li>$r \leftarrow 0$</li><li>result $\leftarrow 0$</li><li>while $l \leq n$ do:<ul><li><ol start=6><li>$r \leftarrow \left\lfloor \frac{n}{l} \right\rfloor$</li></ol></li><li><ol start=7><li>result $\leftarrow$ result $+ [s(r) - s(l - 1)] \times \left\lfloor \frac{n}{l} \right\rfloor$</li></ol></li><li><ol start=8><li>$l \leftarrow r + 1$</li></ol></li></ul></li><li>end while</li></ol><p>最终得到的 result 即为所求的和式。</p><p>例：$\sum_{i=1}^n \left\lfloor \frac{n}{i} \right\rfloor$</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>long</span> <span class=kt>long</span> <span class=nf>H</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=kt>long</span> <span class=n>res</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>l</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=n>l</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>r</span> <span class=o>=</span> <span class=n>n</span> <span class=o>/</span> <span class=p>(</span><span class=n>n</span> <span class=o>/</span> <span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>+=</span> <span class=mi>1LL</span> <span class=o>*</span> <span class=p>(</span><span class=n>r</span> <span class=o>-</span> <span class=n>l</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>n</span> <span class=o>/</span> <span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>l</span> <span class=o>=</span> <span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=向上取整数论分块><a class=header-anchor href=#%e5%90%91%e4%b8%8a%e5%8f%96%e6%95%b4%e6%95%b0%e8%ae%ba%e5%88%86%e5%9d%97></a>向上取整数论分块</h4><p>对于常数 n，使得式子$\lceil \frac{n}{i} \rceil = \lceil \frac{n}{j} \rceil$成立且满足 $i \leq j \leq n$ 的 j 值最大为：$\left\lfloor \frac{n-1}{\left\lfloor \frac{n-1}{i} \right\rfloor} \right\rfloor$</p><p>即值$\lceil \frac{n}{i} \rceil = \lceil \frac{n}{j} \rceil$所在块的右端点为 $\left\lfloor \frac{n-1}{\left\lfloor \frac{n-1}{i} \right\rfloor} \right\rfloor$。</p><h4 id=n-维数论分块><a class=header-anchor href=#n-%e7%bb%b4%e6%95%b0%e8%ae%ba%e5%88%86%e5%9d%97></a>N 维数论分块</h4><p>一般我们用的较多的是二维形式，式子中含有$\lfloor \frac{n}{i} \rfloor{和} \lfloor \frac{m}{i} \rfloor$，此时可将代码中 <code>r = n / (n / i)</code> 替换成 <code>r = min(n / (n / i), m / (m / i))</code>。</p><h3 id=extgcd><a class=header-anchor href=#extgcd></a>extgcd</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>exgcd</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>b</span><span class=p>,</span> <span class=kt>int</span><span class=o>&amp;</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span><span class=o>&amp;</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>b</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>exgcd</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=n>a</span> <span class=o>%</span> <span class=n>b</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>-=</span> <span class=n>a</span> <span class=o>/</span> <span class=n>b</span> <span class=o>*</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=crt><a class=header-anchor href=#crt></a>CRT</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>LL</span> <span class=nf>CRT</span><span class=p>(</span><span class=kt>int</span> <span class=n>k</span><span class=p>,</span> <span class=n>LL</span><span class=o>*</span> <span class=n>a</span><span class=p>,</span> <span class=n>LL</span><span class=o>*</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>LL</span> <span class=n>n</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>ans</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>k</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>=</span> <span class=n>n</span> <span class=o>*</span> <span class=n>r</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>k</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>LL</span> <span class=n>m</span> <span class=o>=</span> <span class=n>n</span> <span class=o>/</span> <span class=n>r</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>b</span><span class=p>,</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>exgcd</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=n>r</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>b</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>  <span class=c1>// b * m mod r[i] = 1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ans</span> <span class=o>=</span> <span class=p>(</span><span class=n>ans</span> <span class=o>+</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>m</span> <span class=o>*</span> <span class=n>b</span> <span class=o>%</span> <span class=n>n</span><span class=p>)</span> <span class=o>%</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>ans</span> <span class=o>%</span> <span class=n>n</span> <span class=o>+</span> <span class=n>n</span><span class=p>)</span> <span class=o>%</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=miller-rabin><a class=header-anchor href=#miller-rabin></a>Miller Rabin</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>millerRabin</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=mi>3</span> <span class=o>||</span> <span class=n>n</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=n>n</span> <span class=o>==</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>%</span> <span class=mi>3</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=k>return</span> <span class=n>n</span> <span class=o>==</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>u</span> <span class=o>=</span> <span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>t</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>u</span> <span class=o>%</span> <span class=mi>2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=n>u</span> <span class=o>/=</span> <span class=mi>2</span><span class=p>,</span> <span class=o>++</span><span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// test_time 为测试次数，建议设为不小于 8
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 的整数以保证正确率，但也不宜过大，否则会影响效率
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>test_time</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 0, 1, n-1 可以直接通过测试, a 取值范围 [2, n-2]
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=n>rand</span><span class=p>()</span> <span class=o>%</span> <span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=mi>3</span><span class=p>)</span> <span class=o>+</span> <span class=mi>2</span><span class=p>,</span> <span class=n>v</span> <span class=o>=</span> <span class=n>quickPow</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>u</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>v</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>s</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>s</span> <span class=o>&lt;</span> <span class=n>t</span><span class=p>;</span> <span class=o>++</span><span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>v</span> <span class=o>==</span> <span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>  <span class=c1>// 得到平凡平方根 n-1，通过此轮测试
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>v</span> <span class=o>=</span> <span class=p>(</span><span class=kt>long</span> <span class=kt>long</span><span class=p>)</span><span class=n>v</span> <span class=o>*</span> <span class=n>v</span> <span class=o>%</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果找到了非平凡平方根，则会由于无法提前 break; 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 而运行到 s == t
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 如果 Fermat 素性测试无法通过，则一直运行到 s == t 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 前 v 都不会等于 -1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>s</span> <span class=o>==</span> <span class=n>t</span><span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=pollard_rho><a class=header-anchor href=#pollard_rho></a>Pollard_Rho</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>ll</span> <span class=nf>Pollard_Rho</span><span class=p>(</span><span class=n>ll</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>t</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>c</span> <span class=o>=</span> <span class=n>rand</span><span class=p>()</span> <span class=o>%</span> <span class=p>(</span><span class=n>x</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>  <span class=c1>// 随机常数 c
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ll</span> <span class=n>s</span> <span class=o>=</span> <span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>step</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>goal</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>val</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>goal</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;;</span> <span class=n>goal</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>s</span> <span class=o>=</span> <span class=n>t</span><span class=p>,</span> <span class=n>val</span> <span class=o>=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>step</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>step</span> <span class=o>&lt;=</span> <span class=n>goal</span><span class=p>;</span> <span class=o>++</span><span class=n>step</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span> <span class=o>=</span> <span class=n>f</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=n>c</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>  <span class=c1>// 迭代函数 f
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>val</span> <span class=o>=</span> <span class=n>val</span> <span class=o>*</span> <span class=n>abs</span><span class=p>(</span><span class=n>t</span> <span class=o>-</span> <span class=n>s</span><span class=p>)</span> <span class=o>%</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 如果 val 为 0，退出重新分解
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>val</span><span class=p>)</span> <span class=k>return</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>step</span> <span class=o>%</span> <span class=mi>127</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ll</span> <span class=n>d</span> <span class=o>=</span> <span class=n>gcd</span><span class=p>(</span><span class=n>val</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>  <span class=c1>// 计算当前 val 和 x 的最大公约数
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=n>d</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=n>d</span><span class=p>;</span>  <span class=c1>// 找到因子
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>ll</span> <span class=n>d</span> <span class=o>=</span> <span class=n>gcd</span><span class=p>(</span><span class=n>val</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>d</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=n>d</span><span class=p>;</span>  <span class=c1>// 找到因子
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=威尔逊定理><a class=header-anchor href=#%e5%a8%81%e5%b0%94%e9%80%8a%e5%ae%9a%e7%90%86></a>威尔逊定理</h3>$$ (p-1)! \equiv -1 \mod p $$<div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// n! mod p
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>factmod</span><span class=p>(</span><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>f</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>p</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>f</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=n>i</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>res</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>n</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>n</span> <span class=o>/</span> <span class=n>p</span><span class=p>)</span> <span class=o>%</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>=</span> <span class=n>p</span> <span class=o>-</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=n>res</span> <span class=o>*</span> <span class=n>f</span><span class=p>[</span><span class=n>n</span> <span class=o>%</span> <span class=n>p</span><span class=p>]</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>/=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=lucas定理><a class=header-anchor href=#lucas%e5%ae%9a%e7%90%86></a>Lucas定理</h3><p>Lucas定理内容如下：对于质数 <strong>p</strong>，有</p>$$
\binom{n}{m} \mod p = \binom{\lfloor n/p \rfloor}{\lfloor m/p \rfloor} \cdot \binom{n \mod p}{m \mod p} \mod p
$$<p>观察上述表达式，可知 <strong>n mod p</strong> 和 <strong>m mod p</strong> 一定是小于 <strong>p</strong> 的数，可以直接求解，$\binom{\lfloor n/p \rfloor}{\lfloor m/p \rfloor}$ 可以继续用Lucas定理求解。这也就要求 <strong>p</strong> 的范围不能够太大，一般在 $10^5$ 左右。边界条件：当 <strong>m=0</strong> 的时候，返回1。</p><p>时间复杂度为 $O(f(p) + g(n)\log n)$，其中 <strong>f(n)</strong> 为预处理组合数的复杂度，<strong>g(n)</strong> 为单次求组合数的复杂度。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>long</span> <span class=kt>long</span> <span class=nf>Lucas</span><span class=p>(</span><span class=kt>long</span> <span class=kt>long</span> <span class=n>n</span><span class=p>,</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>m</span><span class=p>,</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>m</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>C</span><span class=p>(</span><span class=n>n</span> <span class=o>%</span> <span class=n>p</span><span class=p>,</span> <span class=n>m</span> <span class=o>%</span> <span class=n>p</span><span class=p>,</span> <span class=n>p</span><span class=p>)</span> <span class=o>*</span> <span class=n>Lucas</span><span class=p>(</span><span class=n>n</span> <span class=o>/</span> <span class=n>p</span><span class=p>,</span> <span class=n>m</span> <span class=o>/</span> <span class=n>p</span><span class=p>,</span> <span class=n>p</span><span class=p>))</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=exbsgs><a class=header-anchor href=#exbsgs></a>exBSGS</h3><p>给定 $a,p,b$，求满足$a^x \equiv b \mod p$的最小自然数x</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#define reg register
</span></span></span><span class=line><span class=cl><span class=cp>#define EN std::puts(&#34;&#34;)
</span></span></span><span class=line><span class=cl><span class=cp>#define LL long long
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kr>inline</span> <span class=kt>int</span> <span class=nf>read</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>reg</span> <span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>reg</span> <span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>reg</span> <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>c</span> <span class=o>&lt;</span> <span class=sc>&#39;0&#39;</span> <span class=o>||</span> <span class=n>c</span> <span class=o>&gt;</span> <span class=sc>&#39;9&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>==</span> <span class=sc>&#39;-&#39;</span><span class=p>)</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>c</span> <span class=o>&gt;=</span> <span class=sc>&#39;0&#39;</span> <span class=o>&amp;&amp;</span> <span class=n>c</span> <span class=o>&lt;=</span> <span class=sc>&#39;9&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>x</span> <span class=o>*</span> <span class=mi>10</span> <span class=o>+</span> <span class=p>(</span><span class=n>c</span> <span class=o>^</span> <span class=mi>48</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>y</span> <span class=o>?</span> <span class=nl>x</span> <span class=p>:</span> <span class=o>-</span><span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=kt>int</span><span class=p>,</span> <span class=kt>int</span><span class=o>&gt;</span> <span class=n>map</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>gcd</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>b</span> <span class=o>?</span> <span class=n>gcd</span><span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=n>a</span> <span class=o>%</span> <span class=n>b</span><span class=p>)</span> <span class=o>:</span> <span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>int</span> <span class=nf>BSGS</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>p</span><span class=p>,</span> <span class=kt>int</span> <span class=n>ad</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>map</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>reg</span> <span class=kt>int</span> <span class=n>m</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>ceil</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>sqrt</span><span class=p>(</span><span class=n>p</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>reg</span> <span class=kt>int</span> <span class=n>s</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>reg</span> <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>,</span> <span class=n>s</span> <span class=o>=</span> <span class=mi>1ll</span> <span class=o>*</span> <span class=n>s</span> <span class=o>*</span> <span class=n>a</span> <span class=o>%</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>map</span><span class=p>[</span><span class=mi>1ll</span> <span class=o>*</span> <span class=n>s</span> <span class=o>*</span> <span class=n>n</span> <span class=o>%</span> <span class=n>p</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>reg</span> <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>tmp</span> <span class=o>=</span> <span class=n>s</span><span class=p>,</span> <span class=n>s</span> <span class=o>=</span> <span class=n>ad</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>,</span> <span class=n>s</span> <span class=o>=</span> <span class=mi>1ll</span> <span class=o>*</span> <span class=n>s</span> <span class=o>*</span> <span class=n>tmp</span> <span class=o>%</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>map</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>!=</span> <span class=n>map</span><span class=p>.</span><span class=n>end</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=mi>1ll</span> <span class=o>*</span> <span class=n>i</span> <span class=o>*</span> <span class=n>m</span> <span class=o>-</span> <span class=n>map</span><span class=p>[</span><span class=n>s</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=mi>1ll</span> <span class=o>*</span> <span class=n>i</span> <span class=o>*</span> <span class=n>m</span> <span class=o>-</span> <span class=n>map</span><span class=p>[</span><span class=n>s</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>int</span> <span class=nf>exBSGS</span><span class=p>(</span><span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=kt>int</span> <span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>%=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>n</span> <span class=o>%=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>||</span> <span class=n>p</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>reg</span> <span class=kt>int</span> <span class=n>cnt</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>reg</span> <span class=kt>int</span> <span class=n>d</span><span class=p>,</span> <span class=n>ad</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>((</span><span class=n>d</span> <span class=o>=</span> <span class=n>gcd</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>p</span><span class=p>))</span> <span class=o>^</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>%</span> <span class=n>d</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>cnt</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>/=</span> <span class=n>d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>/=</span> <span class=n>d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ad</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1ll</span> <span class=o>*</span> <span class=n>ad</span> <span class=o>*</span> <span class=n>a</span> <span class=o>/</span> <span class=n>d</span><span class=p>)</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ad</span> <span class=o>==</span> <span class=n>n</span><span class=p>)</span> <span class=k>return</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>LL</span> <span class=n>ans</span> <span class=o>=</span> <span class=n>BSGS</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>ad</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ans</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ans</span> <span class=o>+</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>signed</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=n>read</span><span class=p>(),</span> <span class=n>p</span> <span class=o>=</span> <span class=n>read</span><span class=p>(),</span> <span class=n>n</span> <span class=o>=</span> <span class=n>read</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>a</span> <span class=o>||</span> <span class=n>p</span> <span class=o>||</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>ans</span> <span class=o>=</span> <span class=n>exBSGS</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>~</span><span class=n>ans</span><span class=p>)</span> <span class=n>std</span><span class=o>::</span><span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>ans</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=n>std</span><span class=o>::</span><span class=n>puts</span><span class=p>(</span><span class=s>&#34;No Solution&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span> <span class=o>=</span> <span class=n>read</span><span class=p>();</span> <span class=n>p</span> <span class=o>=</span> <span class=n>read</span><span class=p>();</span> <span class=n>n</span> <span class=o>=</span> <span class=n>read</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=线性基><a class=header-anchor href=#%e7%ba%bf%e6%80%a7%e5%9f%ba></a>线性基</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// 给定 n 个整数（数字可能重复），
</span></span></span><span class=line><span class=cl><span class=c1>// 求在这些数中选取任意个，使得他们的异或和最大。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>using</span> <span class=n>ull</span> <span class=o>=</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>int</span> <span class=n>MAXN</span> <span class=o>=</span> <span class=mf>1e5</span> <span class=o>+</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ull</span> <span class=nf>deg</span><span class=p>(</span><span class=n>ull</span> <span class=n>num</span><span class=p>,</span> <span class=kt>int</span> <span class=n>deg</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>num</span> <span class=o>&amp;</span> <span class=p>(</span><span class=mi>1ull</span> <span class=o>&lt;&lt;</span> <span class=n>deg</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ull</span> <span class=n>a</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=n>std</span><span class=o>::</span><span class=n>cin</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span><span class=p>.</span><span class=n>tie</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>sync_with_stdio</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>row</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>col</span> <span class=o>=</span> <span class=mi>63</span><span class=p>;</span> <span class=o>~</span><span class=n>col</span> <span class=o>&amp;&amp;</span> <span class=n>row</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=o>--</span><span class=n>col</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>row</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>deg</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>col</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>std</span><span class=o>::</span><span class=n>swap</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>row</span><span class=p>],</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>deg</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>row</span><span class=p>],</span> <span class=n>col</span><span class=p>))</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>row</span><span class=p>)</span> <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>deg</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>col</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^=</span> <span class=n>a</span><span class=p>[</span><span class=n>row</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>++</span><span class=n>row</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ull</span> <span class=n>ans</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>row</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>^=</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>ans</span> <span class=o>&lt;&lt;</span> <span class=sc>&#39;\n&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=高斯消元><a class=header-anchor href=#%e9%ab%98%e6%96%af%e6%b6%88%e5%85%83></a>高斯消元</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>double</span> <span class=n>EPS</span> <span class=o>=</span> <span class=mf>1E-9</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;&gt;</span> <span class=n>a</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=p>(</span><span class=n>n</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>double</span> <span class=n>det</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>abs</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>j</span><span class=p>][</span><span class=n>i</span><span class=p>])</span> <span class=o>&gt;</span> <span class=n>abs</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=p>]))</span> <span class=n>k</span> <span class=o>=</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>abs</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=n>i</span><span class=p>])</span> <span class=o>&lt;</span> <span class=n>EPS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>det</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>swap</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>a</span><span class=p>[</span><span class=n>k</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>!=</span> <span class=n>k</span><span class=p>)</span> <span class=n>det</span> <span class=o>=</span> <span class=o>-</span><span class=n>det</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>det</span> <span class=o>*=</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>/=</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>j</span> <span class=o>!=</span> <span class=n>i</span> <span class=o>&amp;&amp;</span> <span class=n>abs</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>j</span><span class=p>][</span><span class=n>i</span><span class=p>])</span> <span class=o>&gt;</span> <span class=n>EPS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>k</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>                <span class=n>a</span><span class=p>[</span><span class=n>j</span><span class=p>][</span><span class=n>k</span><span class=p>]</span> <span class=o>-=</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>k</span><span class=p>]</span> <span class=o>*</span> <span class=n>a</span><span class=p>[</span><span class=n>j</span><span class=p>][</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>det</span><span class=p>;</span>
</span></span></code></pre></div><h3 id=博弈论><a class=header-anchor href=#%e5%8d%9a%e5%bc%88%e8%ae%ba></a>博弈论</h3><p>Sprague-Grundy 定理 (SG定理)</p><p>定义 <strong>mex</strong> 函数的值为不属于集合 <strong>S</strong> 中的最小非负整数，即：</p>$$\text{mex}(S) = \min\{x\} \quad (x \notin S, x \in N)$$<p>例如：</p>$$\operatorname{mex}(\{0,2,4\}) = 1, \quad \operatorname{mex}(\{1,2\}) = 0$$<p>对于状态 <strong>x</strong> 和它的所有 <strong>k</strong> 个后继状态 <strong>$y_1, y_2, \ldots, y_k$</strong>，定义 <strong>SG</strong> 函数：</p>$$\text{SG}(x) = \text{mex}\{\text{SG}(y_1), \text{SG}(y_2), \ldots, \text{SG}(y_k)\}$$<p>而对于由 <strong>n</strong> 个有向图游戏组成的组合游戏，设它们的起点分别为 <strong>$s_1, s_2, \ldots, s_n$</strong>，则有定理：当且仅当：</p>$$SG(s_1) \oplus SG(s_2) \oplus \ldots \oplus SG(s_n) \neq 0$$<p>时，这个游戏是先手必胜的。同时，这是这一个组合游戏的游戏状态 <strong>x</strong> 的 <strong>SG</strong> 值。</p><h2 id=字符串><a class=header-anchor href=#%e5%ad%97%e7%ac%a6%e4%b8%b2></a>字符串</h2><h3 id=双值hash><a class=header-anchor href=#%e5%8f%8c%e5%80%bchash></a>双值hash</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>using</span> <span class=n>ull</span> <span class=o>=</span> <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>ull</span> <span class=n>base</span> <span class=o>=</span> <span class=mi>131</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>ull</span> <span class=n>mod1</span> <span class=o>=</span> <span class=mi>212370440130137957</span><span class=p>,</span> <span class=n>mod2</span> <span class=o>=</span> <span class=mf>1e9</span> <span class=o>+</span> <span class=mi>7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ull</span> <span class=nf>get_hash1</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>s</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ull</span> <span class=n>ans</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>=</span> <span class=p>(</span><span class=n>ans</span> <span class=o>*</span> <span class=n>base</span> <span class=o>+</span> <span class=p>(</span><span class=n>ull</span><span class=p>)</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>%</span> <span class=n>mod1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ans</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ull</span> <span class=nf>get_hash2</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>len</span> <span class=o>=</span> <span class=n>s</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ull</span> <span class=n>ans</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>=</span> <span class=p>(</span><span class=n>ans</span> <span class=o>*</span> <span class=n>base</span> <span class=o>+</span> <span class=p>(</span><span class=n>ull</span><span class=p>)</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>%</span> <span class=n>mod2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ans</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>cmp</span><span class=p>(</span><span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>s</span><span class=p>,</span> <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>string</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>f1</span> <span class=o>=</span> <span class=n>get_hash1</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>!=</span> <span class=n>get_hash1</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>f2</span> <span class=o>=</span> <span class=n>get_hash2</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>!=</span> <span class=n>get_hash2</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>f1</span> <span class=o>||</span> <span class=n>f2</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=kmp><a class=header-anchor href=#kmp></a>KMP</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>prefix_function</span><span class=p>(</span><span class=n>string</span> <span class=n>s</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>s</span><span class=p>.</span><span class=n>length</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>pi</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>pi</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>j</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=n>s</span><span class=p>[</span><span class=n>j</span><span class=p>])</span> <span class=n>j</span> <span class=o>=</span> <span class=n>pi</span><span class=p>[</span><span class=n>j</span> <span class=o>-</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>s</span><span class=p>[</span><span class=n>j</span><span class=p>])</span> <span class=n>j</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>pi</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pi</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>find_occurrences</span><span class=p>(</span><span class=n>string</span> <span class=n>text</span><span class=p>,</span> <span class=n>string</span> <span class=n>pattern</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>string</span> <span class=n>cur</span> <span class=o>=</span> <span class=n>pattern</span> <span class=o>+</span> <span class=sc>&#39;#&#39;</span> <span class=o>+</span> <span class=n>text</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sz1</span> <span class=o>=</span> <span class=n>text</span><span class=p>.</span><span class=n>size</span><span class=p>(),</span> <span class=n>sz2</span> <span class=o>=</span> <span class=n>pattern</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>lps</span> <span class=o>=</span> <span class=n>prefix_function</span><span class=p>(</span><span class=n>cur</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>sz2</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>sz1</span> <span class=o>+</span> <span class=n>sz2</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>lps</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>==</span> <span class=n>sz2</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=n>v</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>i</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>sz2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 统计每个前缀的出现次数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>ans</span><span class=p>(</span><span class=n>n</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=n>ans</span><span class=p>[</span><span class=n>pi</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>--</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=n>ans</span><span class=p>[</span><span class=n>pi</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]]</span> <span class=o>+=</span> <span class=n>ans</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=n>ans</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>++</span><span class=p>;</span>
</span></span></code></pre></div><h3 id=ac自动机><a class=header-anchor href=#ac%e8%87%aa%e5%8a%a8%e6%9c%ba></a>AC自动机</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>int</span> <span class=n>N</span> <span class=o>=</span> <span class=mf>2e5</span> <span class=o>+</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>int</span> <span class=n>LEN</span> <span class=o>=</span> <span class=mf>2e6</span> <span class=o>+</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>int</span> <span class=n>SIZE</span> <span class=o>=</span> <span class=mf>2e5</span> <span class=o>+</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=n>AC</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>son</span><span class=p>[</span><span class=mi>26</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>ans</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fail</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>memset</span><span class=p>(</span><span class=n>son</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>son</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>tr</span><span class=p>[</span><span class=n>SIZE</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>tot</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>ans</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>pidx</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>g</span><span class=p>[</span><span class=n>SIZE</span><span class=p>];</span>  <span class=c1>// fail 树
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>tot</span> <span class=o>=</span> <span class=n>pidx</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>tr</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>init</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>insert</span><span class=p>(</span><span class=kt>char</span> <span class=n>s</span><span class=p>[],</span> <span class=kt>int</span> <span class=o>&amp;</span><span class=n>idx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>u</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>];</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=o>&amp;</span><span class=n>son</span> <span class=o>=</span> <span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>s</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=sc>&#39;a&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>son</span><span class=p>)</span> <span class=n>son</span> <span class=o>=</span> <span class=o>++</span><span class=n>tot</span><span class=p>,</span> <span class=n>tr</span><span class=p>[</span><span class=n>son</span><span class=p>].</span><span class=n>init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span> <span class=o>=</span> <span class=n>son</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 由于有可能出现相同的模式串，需要将相同的映射到同一个编号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>idx</span><span class=p>)</span> <span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>idx</span> <span class=o>=</span> <span class=o>++</span><span class=n>pidx</span><span class=p>;</span>  <span class=c1>// 第一次出现，新增编号
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>idx</span> <span class=o>=</span> <span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>idx</span><span class=p>;</span>  <span class=c1>// 这个模式串的编号对应这个结点的编号
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>build</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>queue</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>q</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>26</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>tr</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>q</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>tr</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=n>g</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>tr</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>  <span class=c1>// 不要忘记这里的 fail
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>q</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>u</span> <span class=o>=</span> <span class=n>q</span><span class=p>.</span><span class=n>front</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>26</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>tr</span><span class=p>[</span><span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>i</span><span class=p>]].</span><span class=n>fail</span> <span class=o>=</span> <span class=n>tr</span><span class=p>[</span><span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>fail</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>                <span class=n>g</span><span class=p>[</span><span class=n>tr</span><span class=p>[</span><span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>fail</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>i</span><span class=p>]].</span><span class=n>push_back</span><span class=p>(</span><span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>  
</span></span><span class=line><span class=cl>                <span class=n>q</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>tr</span><span class=p>[</span><span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>fail</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>query</span><span class=p>(</span><span class=kt>char</span> <span class=n>t</span><span class=p>[])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>u</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>t</span><span class=p>[</span><span class=n>i</span><span class=p>];</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>u</span> <span class=o>=</span> <span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>son</span><span class=p>[</span><span class=n>t</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>-</span> <span class=sc>&#39;a&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>ans</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>dfs</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>v</span> <span class=p>:</span> <span class=n>g</span><span class=p>[</span><span class=n>u</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>dfs</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>ans</span> <span class=o>+=</span> <span class=n>tr</span><span class=p>[</span><span class=n>v</span><span class=p>].</span><span class=n>ans</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>ans</span><span class=p>[</span><span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>tr</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>ans</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>  <span class=c1>// namespace AC
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=n>s</span><span class=p>[</span><span class=n>LEN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>idx</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>AC</span><span class=o>::</span><span class=n>init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=n>s</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>AC</span><span class=o>::</span><span class=n>insert</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>idx</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>AC</span><span class=o>::</span><span class=n>ans</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>AC</span><span class=o>::</span><span class=n>build</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=n>s</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>AC</span><span class=o>::</span><span class=n>query</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>AC</span><span class=o>::</span><span class=n>dfs</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>AC</span><span class=o>::</span><span class=n>ans</span><span class=p>[</span><span class=n>idx</span><span class=p>[</span><span class=n>i</span><span class=p>]]);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=最小表示法><a class=header-anchor href=#%e6%9c%80%e5%b0%8f%e8%a1%a8%e7%a4%ba%e6%b3%95></a>最小表示法</h3><p>字符串S的最小表示为与S循环同构的所有字符串中字典序最小的字符串。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=p>(</span><span class=n>k</span> <span class=o>&lt;</span> <span class=n>n</span> <span class=o>&amp;&amp;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span> <span class=o>&amp;&amp;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>sec</span><span class=p>[(</span><span class=n>i</span> <span class=o>+</span> <span class=n>k</span><span class=p>)</span> <span class=o>%</span> <span class=n>n</span><span class=p>]</span> <span class=o>==</span> <span class=n>sec</span><span class=p>[(</span><span class=n>j</span> <span class=o>+</span> <span class=n>k</span><span class=p>)</span> <span class=o>%</span> <span class=n>n</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sec</span><span class=p>[(</span><span class=n>i</span> <span class=o>+</span> <span class=n>k</span><span class=p>)</span> <span class=o>%</span> <span class=n>n</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>sec</span><span class=p>[(</span><span class=n>j</span> <span class=o>+</span> <span class=n>k</span><span class=p>)</span> <span class=o>%</span> <span class=n>n</span><span class=p>]</span> <span class=o>?</span> <span class=n>i</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=n>k</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>:</span> <span class=n>j</span> <span class=o>=</span> <span class=n>j</span> <span class=o>+</span> <span class=n>k</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>j</span><span class=p>)</span> <span class=n>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>i</span> <span class=o>=</span> <span class=n>min</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>);</span>
</span></span></code></pre></div><h3 id=manacher><a class=header-anchor href=#manacher></a>Manacher</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>d1</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>  <span class=c1>// 存储奇数长度回文的半径
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>l</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=p>(</span><span class=n>i</span> <span class=o>&gt;</span> <span class=n>r</span><span class=p>)</span> <span class=o>?</span> <span class=mi>1</span> <span class=o>:</span> <span class=n>min</span><span class=p>(</span><span class=n>d1</span><span class=p>[</span><span class=n>l</span> <span class=o>+</span> <span class=n>r</span> <span class=o>-</span> <span class=n>i</span><span class=p>],</span> <span class=n>r</span> <span class=o>-</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>i</span> <span class=o>-</span> <span class=n>k</span> <span class=o>&amp;&amp;</span> <span class=n>i</span> <span class=o>+</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>n</span> <span class=o>&amp;&amp;</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=n>k</span><span class=p>]</span> <span class=o>==</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=n>k</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>d1</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>k</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>+</span> <span class=n>k</span> <span class=o>&gt;</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>l</span> <span class=o>=</span> <span class=n>i</span> <span class=o>-</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>d2</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>  <span class=c1>// 存储偶数长度回文的半径
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>l</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=p>(</span><span class=n>i</span> <span class=o>&gt;</span> <span class=n>r</span><span class=p>)</span> <span class=o>?</span> <span class=mi>0</span> <span class=o>:</span> <span class=n>min</span><span class=p>(</span><span class=n>d2</span><span class=p>[</span><span class=n>l</span> <span class=o>+</span> <span class=n>r</span> <span class=o>-</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>],</span> <span class=n>r</span> <span class=o>-</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>i</span> <span class=o>-</span> <span class=n>k</span> <span class=o>-</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=n>i</span> <span class=o>+</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>n</span> <span class=o>&amp;&amp;</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span> <span class=o>-</span> <span class=n>k</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>s</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=n>k</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>d2</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>k</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>+</span> <span class=n>k</span> <span class=o>&gt;</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>l</span> <span class=o>=</span> <span class=n>i</span> <span class=o>-</span> <span class=n>k</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=misc><a class=header-anchor href=#misc></a>Misc</h2><h3 id=线段树分治><a class=header-anchor href=#%e7%ba%bf%e6%ae%b5%e6%a0%91%e5%88%86%e6%b2%bb></a>线段树分治</h3><p>例：你需要维护一个 n 个点 m 条边的无向图。第 i 条边为 (x_i,y_i)，出现的时刻为 [l_i,r_i)，其余时刻消失。对于每一个时刻，若此时该图为二分图，输出 <code>Yes</code>，否则输出 <code>No</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#define ls (i &lt;&lt; 1)
</span></span></span><span class=line><span class=cl><span class=cp>#define rs (i &lt;&lt; 1 | 1)
</span></span></span><span class=line><span class=cl><span class=cp>#define mid ((l + r) &gt;&gt; 1)
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>int</span> <span class=n>N</span> <span class=o>=</span> <span class=mf>2e5</span> <span class=o>+</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>fa</span><span class=p>[</span><span class=n>N</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>],</span> <span class=n>siz</span><span class=p>[</span><span class=n>N</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>UndoObject</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>pos</span><span class=p>,</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>UndoObject</span><span class=p>(</span><span class=kt>int</span> <span class=n>p</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v</span><span class=p>)</span> <span class=o>:</span> <span class=n>pos</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=n>val</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>stack</span><span class=o>&lt;</span><span class=n>UndoObject</span><span class=o>&gt;</span> <span class=n>undo_sz</span><span class=p>,</span> <span class=n>undo_fa</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>find</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fa</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=o>==</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>find</span><span class=p>(</span><span class=n>fa</span><span class=p>[</span><span class=n>x</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>merge</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>x</span> <span class=o>=</span> <span class=n>find</span><span class=p>(</span><span class=n>u</span><span class=p>),</span> <span class=n>y</span> <span class=o>=</span> <span class=n>find</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>x</span> <span class=o>==</span> <span class=n>y</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>siz</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>siz</span><span class=p>[</span><span class=n>y</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>swap</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>undo_sz</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>UndoObject</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>siz</span><span class=p>[</span><span class=n>x</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>    <span class=n>siz</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=o>+=</span> <span class=n>siz</span><span class=p>[</span><span class=n>y</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>undo_fa</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>UndoObject</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=n>fa</span><span class=p>[</span><span class=n>y</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>    <span class=n>fa</span><span class=p>[</span><span class=n>y</span><span class=p>]</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>undo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>fa</span><span class=p>[</span><span class=n>undo_fa</span><span class=p>.</span><span class=n>top</span><span class=p>().</span><span class=n>pos</span><span class=p>]</span> <span class=o>=</span> <span class=n>undo_fa</span><span class=p>.</span><span class=n>top</span><span class=p>().</span><span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>undo_fa</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>siz</span><span class=p>[</span><span class=n>undo_sz</span><span class=p>.</span><span class=n>top</span><span class=p>().</span><span class=n>pos</span><span class=p>]</span> <span class=o>=</span> <span class=n>undo_sz</span><span class=p>.</span><span class=n>top</span><span class=p>().</span><span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>undo_sz</span><span class=p>.</span><span class=n>pop</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>tree</span><span class=p>[</span><span class=n>N</span> <span class=o>&lt;&lt;</span> <span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>update</span><span class=p>(</span><span class=kt>int</span> <span class=n>ql</span><span class=p>,</span> <span class=kt>int</span> <span class=n>qr</span><span class=p>,</span> <span class=kt>int</span> <span class=n>v</span><span class=p>,</span> <span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=kt>int</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ql</span> <span class=o>&lt;=</span> <span class=n>l</span> <span class=o>&amp;&amp;</span> <span class=n>r</span> <span class=o>&lt;=</span> <span class=n>qr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>tree</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>push_back</span><span class=p>(</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ql</span> <span class=o>&lt;=</span> <span class=n>mid</span><span class=p>)</span> <span class=n>update</span><span class=p>(</span><span class=n>ql</span><span class=p>,</span> <span class=n>qr</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>ls</span><span class=p>,</span> <span class=n>l</span><span class=p>,</span> <span class=n>mid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>qr</span> <span class=o>&gt;</span> <span class=n>mid</span><span class=p>)</span> <span class=n>update</span><span class=p>(</span><span class=n>ql</span><span class=p>,</span> <span class=n>qr</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>rs</span><span class=p>,</span> <span class=n>mid</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>edge</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>g</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>bool</span><span class=o>&gt;</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>solve</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>,</span> <span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=kt>int</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>level</span> <span class=o>=</span> <span class=n>undo_fa</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>ans</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=nl>u</span> <span class=p>:</span> <span class=n>tree</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=n>find</span><span class=p>(</span><span class=n>g</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>b</span> <span class=o>=</span> <span class=n>find</span><span class=p>(</span><span class=n>g</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>==</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=n>l</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;=</span> <span class=n>r</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ret</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>ans</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>merge</span><span class=p>(</span><span class=n>g</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>u</span><span class=p>,</span> <span class=n>g</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>v</span> <span class=o>+</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>merge</span><span class=p>(</span><span class=n>g</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>v</span><span class=p>,</span> <span class=n>g</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>u</span> <span class=o>+</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>ans</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>l</span> <span class=o>==</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ret</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=nb>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>solve</span><span class=p>(</span><span class=n>ls</span><span class=p>,</span> <span class=n>l</span><span class=p>,</span> <span class=n>mid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>solve</span><span class=p>(</span><span class=n>rs</span><span class=p>,</span> <span class=n>mid</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>undo_fa</span><span class=p>.</span><span class=n>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=n>level</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>undo</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>signed</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=n>m</span> <span class=o>&gt;&gt;</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=p>(</span><span class=n>n</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>fa</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>siz</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>g</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>u</span> <span class=o>&gt;&gt;</span> <span class=n>g</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>v</span> <span class=o>&gt;&gt;</span> <span class=n>l</span> <span class=o>&gt;&gt;</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>update</span><span class=p>(</span><span class=n>l</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>k</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>solve</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>k</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>bool</span> <span class=nl>i</span> <span class=p>:</span> <span class=n>ret</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>i</span> <span class=o>?</span> <span class=s>&#34;Yes&#34;</span> <span class=o>:</span> <span class=s>&#34;No&#34;</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=sc>&#39;\n&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=莫队><a class=header-anchor href=#%e8%8e%ab%e9%98%9f></a>莫队</h3><p>将大小为n的序列分为$\sqrt n$个块，从1到$\sqrt n$编号，然后根据这个对查询区间进行排序。把查询区间按照<strong>左端点所在块的序号</strong>排个序，如果左端点所在块相同，再按<strong>右端点</strong>排序</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=nf>cmp</span><span class=p>(</span><span class=n>query</span> <span class=n>a</span><span class=p>,</span> <span class=n>query</span> <span class=n>b</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>{</span> 
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>==</span> <span class=n>belong</span><span class=p>[</span><span class=n>b</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>?</span>
</span></span><span class=line><span class=cl>	<span class=n>a</span><span class=p>.</span><span class=n>r</span> <span class=o>&lt;</span> <span class=n>b</span><span class=p>.</span><span class=nl>r</span> <span class=p>:</span> <span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>belong</span><span class=p>[</span><span class=n>b</span><span class=p>.</span><span class=n>l</span><span class=p>];</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 奇偶性排序
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>cmp</span><span class=p>(</span><span class=n>query</span> <span class=n>a</span><span class=p>,</span> <span class=n>query</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>(</span><span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>^</span> <span class=n>belong</span><span class=p>[</span><span class=n>b</span><span class=p>.</span><span class=n>l</span><span class=p>])</span> <span class=o>?</span>
</span></span><span class=line><span class=cl>	 <span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>belong</span><span class=p>[</span><span class=n>b</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>	  <span class=p>((</span><span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>?</span> <span class=n>a</span><span class=p>.</span><span class=n>r</span> <span class=o>&lt;</span> <span class=n>b</span><span class=p>.</span><span class=nl>r</span> <span class=p>:</span>
</span></span><span class=line><span class=cl>	   <span class=n>a</span><span class=p>.</span><span class=n>r</span> <span class=o>&gt;</span> <span class=n>b</span><span class=p>.</span><span class=n>r</span><span class=p>);</span> <span class=p>}</span>
</span></span></code></pre></div><p>例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#define maxn 1010000
</span></span></span><span class=line><span class=cl><span class=cp>#define maxb 1010
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=n>aa</span><span class=p>[</span><span class=n>maxn</span><span class=p>],</span> <span class=n>cnt</span><span class=p>[</span><span class=n>maxn</span><span class=p>],</span> <span class=n>belong</span><span class=p>[</span><span class=n>maxn</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>bnum</span><span class=p>,</span> <span class=n>now</span><span class=p>,</span> <span class=n>ans</span><span class=p>[</span><span class=n>maxn</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>query</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>q</span><span class=p>[</span><span class=n>maxn</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>cmp</span><span class=p>(</span><span class=n>query</span> <span class=n>a</span><span class=p>,</span> <span class=n>query</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>^</span> <span class=n>belong</span><span class=p>[</span><span class=n>b</span><span class=p>.</span><span class=n>l</span><span class=p>])</span> <span class=o>?</span> <span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>belong</span><span class=p>[</span><span class=n>b</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>:</span> 
</span></span><span class=line><span class=cl><span class=p>((</span><span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>?</span> <span class=n>a</span><span class=p>.</span><span class=n>r</span> <span class=o>&lt;</span> <span class=n>b</span><span class=p>.</span><span class=nl>r</span> <span class=p>:</span> <span class=n>a</span><span class=p>.</span><span class=n>r</span> <span class=o>&gt;</span> <span class=n>b</span><span class=p>.</span><span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#define isdigit(x) ((x) &gt;= &#39;0&#39; &amp;&amp; (x) &lt;= &#39;9&#39;)
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=nf>read</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>res</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>c</span> <span class=o>=</span> <span class=n>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>isdigit</span><span class=p>(</span><span class=n>c</span><span class=p>))</span> <span class=n>c</span> <span class=o>=</span> <span class=n>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>isdigit</span><span class=p>(</span><span class=n>c</span><span class=p>))</span> <span class=n>res</span> <span class=o>=</span> <span class=p>(</span><span class=n>res</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>res</span> <span class=o>&lt;&lt;</span> <span class=mi>3</span><span class=p>)</span> <span class=o>+</span> <span class=n>c</span> <span class=o>-</span> <span class=mi>48</span><span class=p>,</span> <span class=n>c</span> <span class=o>=</span> <span class=n>getchar</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>printi</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>x</span> <span class=o>/</span> <span class=mi>10</span><span class=p>)</span> <span class=n>printi</span><span class=p>(</span><span class=n>x</span> <span class=o>/</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>putchar</span><span class=p>(</span><span class=n>x</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>+</span> <span class=sc>&#39;0&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span> <span class=o>=</span> <span class=n>sqrt</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>bnum</span> <span class=o>=</span> <span class=n>ceil</span><span class=p>((</span><span class=kt>double</span><span class=p>)</span><span class=n>n</span> <span class=o>/</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>bnum</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=p>(</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>size</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;=</span> <span class=n>i</span> <span class=o>*</span> <span class=n>size</span><span class=p>;</span> <span class=o>++</span><span class=n>j</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>belong</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=n>aa</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>read</span><span class=p>();</span> 
</span></span><span class=line><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=n>read</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>l</span> <span class=o>=</span> <span class=n>read</span><span class=p>(),</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>r</span> <span class=o>=</span> <span class=n>read</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>id</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>sort</span><span class=p>(</span><span class=n>q</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>q</span> <span class=o>+</span> <span class=n>m</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>cmp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>l</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>r</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>ql</span> <span class=o>=</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>l</span><span class=p>,</span> <span class=n>qr</span> <span class=o>=</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>l</span> <span class=o>&lt;</span> <span class=n>ql</span><span class=p>)</span> <span class=n>now</span> <span class=o>-=</span> <span class=o>!--</span><span class=n>cnt</span><span class=p>[</span><span class=n>aa</span><span class=p>[</span><span class=n>l</span><span class=o>++</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>l</span> <span class=o>&gt;</span> <span class=n>ql</span><span class=p>)</span> <span class=n>now</span> <span class=o>+=</span> <span class=o>!</span><span class=n>cnt</span><span class=p>[</span><span class=n>aa</span><span class=p>[</span><span class=o>--</span><span class=n>l</span><span class=p>]]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>r</span> <span class=o>&lt;</span> <span class=n>qr</span><span class=p>)</span> <span class=n>now</span> <span class=o>+=</span> <span class=o>!</span><span class=n>cnt</span><span class=p>[</span><span class=n>aa</span><span class=p>[</span><span class=o>++</span><span class=n>r</span><span class=p>]]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>r</span> <span class=o>&gt;</span> <span class=n>qr</span><span class=p>)</span> <span class=n>now</span> <span class=o>-=</span> <span class=o>!--</span><span class=n>cnt</span><span class=p>[</span><span class=n>aa</span><span class=p>[</span><span class=n>r</span><span class=o>--</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span><span class=p>[</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>id</span><span class=p>]</span> <span class=o>=</span> <span class=n>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=n>printi</span><span class=p>(</span><span class=n>ans</span><span class=p>[</span><span class=n>i</span><span class=p>]),</span> <span class=n>putchar</span><span class=p>(</span><span class=sc>&#39;\n&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=带修莫队><a class=header-anchor href=#%e5%b8%a6%e4%bf%ae%e8%8e%ab%e9%98%9f></a>带修莫队</h4><p>莫队算法是离线算法，不支持修改，强制在线需要另寻他法。的确，遇到强制在线的题目莫队基本上萎了，但是对于某些允许离线的带修改区间查询来说，莫队还是能大展拳脚的。做法就是把莫队直接加上一维，变为带修莫队。</p><p>那么加上一维什么呢？具体怎么实现？我们的做法是把修改操作编号，称为"时间戳"，<strong>而查询操作的时间戳沿用之前最近的修改操作的时间戳</strong>。跑主算法时定义当前时间戳为 tt ，对于每个查询操作，如果当前时间戳相对太大了，说明已进行的修改操作比要求的多，就把之前改的改回来，反之往后改。只有当当前区间和查询区间左右端点、时间戳均重合时，才认定区间完全重合，此时的答案才是本次查询的最终答案。</p><h4 id=通俗地讲就是再弄一指针在修改操作上跳来跳去如果当前修改多了就改回来改少了就改过去直到次数恰当为止><a class=header-anchor href=#%e9%80%9a%e4%bf%97%e5%9c%b0%e8%ae%b2%e5%b0%b1%e6%98%af%e5%86%8d%e5%bc%84%e4%b8%80%e6%8c%87%e9%92%88%e5%9c%a8%e4%bf%ae%e6%94%b9%e6%93%8d%e4%bd%9c%e4%b8%8a%e8%b7%b3%e6%9d%a5%e8%b7%b3%e5%8e%bb%e5%a6%82%e6%9e%9c%e5%bd%93%e5%89%8d%e4%bf%ae%e6%94%b9%e5%a4%9a%e4%ba%86%e5%b0%b1%e6%94%b9%e5%9b%9e%e6%9d%a5%e6%94%b9%e5%b0%91%e4%ba%86%e5%b0%b1%e6%94%b9%e8%bf%87%e5%8e%bb%e7%9b%b4%e5%88%b0%e6%ac%a1%e6%95%b0%e6%81%b0%e5%bd%93%e4%b8%ba%e6%ad%a2></a>通俗地讲，就是再弄一指针，在修改操作上跳来跳去，如果当前修改多了就改回来，改少了就改过去，直到次数恰当为止。</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=nf>cmp</span><span class=p>(</span><span class=n>query</span> <span class=n>a</span><span class=p>,</span> <span class=n>query</span> <span class=n>b</span><span class=p>)</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>(</span><span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>^</span> <span class=n>belong</span><span class=p>[</span><span class=n>b</span><span class=p>.</span><span class=n>l</span><span class=p>])</span> <span class=o>?</span>
</span></span><span class=line><span class=cl>	 <span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>belong</span><span class=p>[</span><span class=n>b</span><span class=p>.</span><span class=n>l</span><span class=p>]</span> 
</span></span><span class=line><span class=cl>	 <span class=o>:</span> <span class=p>((</span><span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>r</span><span class=p>]</span> <span class=o>^</span> <span class=n>belong</span><span class=p>[</span><span class=n>b</span><span class=p>.</span><span class=n>r</span><span class=p>])</span> 
</span></span><span class=line><span class=cl>	 <span class=o>?</span> <span class=n>belong</span><span class=p>[</span><span class=n>a</span><span class=p>.</span><span class=n>r</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>belong</span><span class=p>[</span><span class=n>b</span><span class=p>.</span><span class=n>r</span><span class=p>]</span> 
</span></span><span class=line><span class=cl>	 <span class=o>:</span> <span class=n>a</span><span class=p>.</span><span class=n>time</span> <span class=o>&lt;</span> <span class=n>b</span><span class=p>.</span><span class=n>time</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=树上莫队><a class=header-anchor href=#%e6%a0%91%e4%b8%8a%e8%8e%ab%e9%98%9f></a>树上莫队</h4><p>具体做法：欧拉序，设每个点的编号a首次出现的位置first[a]first[a]，最后出现的位置为last[a]，那么对于路径x→y，设first[x]&lt;=first[y]（不满足则<code>swap</code>，这个操作的意义在于，如果x、y在一条链上，则x一定是y的祖先或等于yy），如果lca(x,y)=x，则直接把 [first[x],first[y]] 的区间扯过来用，反之使用[last[x],first[y]]区间（为什么不用[first[x],first[y]]？因为(first[x],last[x])不会在路径上，根据性质，里面的编号都会出现两次，考虑了等于没考虑），但这个区间内不包含x和y的最近公共祖先，查询的时候加上即可。</p><h3 id=lct><a class=header-anchor href=#lct></a>LCT</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;cstdio&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;algorithm&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define Fa(x) (node[x].fa)
</span></span></span><span class=line><span class=cl><span class=cp>#define Ls(x) (node[x].ch[0])
</span></span></span><span class=line><span class=cl><span class=cp>#define Rs(x) (node[x].ch[1])
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>int</span> <span class=n>N</span> <span class=o>=</span> <span class=mf>3e4</span> <span class=o>+</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Splay</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fa</span><span class=p>,</span> <span class=n>ch</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>w</span><span class=p>,</span> <span class=n>sum</span><span class=p>,</span> <span class=n>revFlag</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>node</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>pushup</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>node</span><span class=p>[</span><span class=n>x</span><span class=p>].</span><span class=n>sum</span> <span class=o>=</span> <span class=n>node</span><span class=p>[</span><span class=n>Ls</span><span class=p>(</span><span class=n>x</span><span class=p>)].</span><span class=n>sum</span> <span class=o>+</span> <span class=n>node</span><span class=p>[</span><span class=n>Rs</span><span class=p>(</span><span class=n>x</span><span class=p>)].</span><span class=n>sum</span> <span class=o>+</span> <span class=n>node</span><span class=p>[</span><span class=n>x</span><span class=p>].</span><span class=n>w</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>reverse</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>swap</span><span class=p>(</span><span class=n>Ls</span><span class=p>(</span><span class=n>x</span><span class=p>),</span> <span class=n>Rs</span><span class=p>(</span><span class=n>x</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>node</span><span class=p>[</span><span class=n>x</span><span class=p>].</span><span class=n>revFlag</span> <span class=o>^=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>pushdown</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>node</span><span class=p>[</span><span class=n>x</span><span class=p>].</span><span class=n>revFlag</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Ls</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=n>reverse</span><span class=p>(</span><span class=n>Ls</span><span class=p>(</span><span class=n>x</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>Rs</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=n>reverse</span><span class=p>(</span><span class=n>Rs</span><span class=p>(</span><span class=n>x</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>node</span><span class=p>[</span><span class=n>x</span><span class=p>].</span><span class=n>revFlag</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>int</span> <span class=nf>get</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Rs</span><span class=p>(</span><span class=n>Fa</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=o>==</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>int</span> <span class=nf>nRoot</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Rs</span><span class=p>(</span><span class=n>Fa</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=o>==</span> <span class=n>x</span> <span class=o>||</span> <span class=n>Ls</span><span class=p>(</span><span class=n>Fa</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=o>==</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>rotate</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>fa</span> <span class=o>=</span> <span class=n>Fa</span><span class=p>(</span><span class=n>x</span><span class=p>),</span> <span class=n>gf</span> <span class=o>=</span> <span class=n>Fa</span><span class=p>(</span><span class=n>fa</span><span class=p>),</span> <span class=n>d</span> <span class=o>=</span> <span class=n>get</span><span class=p>(</span><span class=n>x</span><span class=p>),</span> <span class=n>dd</span> <span class=o>=</span> <span class=n>get</span><span class=p>(</span><span class=n>fa</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>nRoot</span><span class=p>(</span><span class=n>fa</span><span class=p>))</span> <span class=n>node</span><span class=p>[</span><span class=n>gf</span><span class=p>].</span><span class=n>ch</span><span class=p>[</span><span class=n>dd</span><span class=p>]</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>node</span><span class=p>[</span><span class=n>fa</span><span class=p>].</span><span class=n>ch</span><span class=p>[</span><span class=n>d</span><span class=p>]</span> <span class=o>=</span> <span class=n>node</span><span class=p>[</span><span class=n>x</span><span class=p>].</span><span class=n>ch</span><span class=p>[</span><span class=n>d</span> <span class=o>^</span> <span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>Fa</span><span class=p>(</span><span class=n>node</span><span class=p>[</span><span class=n>x</span><span class=p>].</span><span class=n>ch</span><span class=p>[</span><span class=n>d</span> <span class=o>^</span> <span class=mi>1</span><span class=p>])</span> <span class=o>=</span> <span class=n>fa</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>node</span><span class=p>[</span><span class=n>x</span><span class=p>].</span><span class=n>ch</span><span class=p>[</span><span class=n>d</span> <span class=o>^</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>fa</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Fa</span><span class=p>(</span><span class=n>fa</span><span class=p>)</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Fa</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>gf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>pushup</span><span class=p>(</span><span class=n>fa</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pushup</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>st</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>tp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>splay</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=n>st</span><span class=p>[</span><span class=n>tp</span> <span class=o>=</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>nRoot</span><span class=p>(</span><span class=n>y</span><span class=p>))</span> <span class=n>st</span><span class=p>[</span><span class=o>++</span><span class=n>tp</span><span class=p>]</span> <span class=o>=</span> <span class=n>y</span> <span class=o>=</span> <span class=n>Fa</span><span class=p>(</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>tp</span><span class=p>)</span> <span class=n>pushdown</span><span class=p>(</span><span class=n>st</span><span class=p>[</span><span class=n>tp</span><span class=o>--</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(;</span> <span class=n>nRoot</span><span class=p>(</span><span class=n>x</span><span class=p>);</span> <span class=n>rotate</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=k>if</span> <span class=p>(</span><span class=n>nRoot</span><span class=p>(</span><span class=n>Fa</span><span class=p>(</span><span class=n>x</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>rotate</span><span class=p>(</span><span class=n>get</span><span class=p>(</span><span class=n>Fa</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=o>==</span> <span class=n>get</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>?</span> <span class=n>Fa</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>:</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pushup</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>access</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>splay</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>Rs</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>pushup</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>Fa</span><span class=p>(</span><span class=n>y</span> <span class=o>=</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>makeroot</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>access</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>splay</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>reverse</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>split</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>makeroot</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>access</span><span class=p>(</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>splay</span><span class=p>(</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>link</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>makeroot</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Fa</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>void</span> <span class=nf>cut</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=kt>int</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>split</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Fa</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=o>=</span> <span class=n>Ls</span><span class=p>(</span><span class=n>y</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>inline</span> <span class=kt>int</span> <span class=nf>findRoot</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>access</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>splay</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>Ls</span><span class=p>(</span><span class=n>x</span><span class=p>))</span> <span class=n>x</span> <span class=o>=</span> <span class=n>Ls</span><span class=p>(</span><span class=n>x</span><span class=p>),</span> <span class=n>pushdown</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>splay</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>-   `bridge u v`：询问结点u与结点v是否连通。如果是则输出  `no`；否则输出  `yes`，并且在结点  uu  和结点  vv  之间连一条无向边。
</span></span></span><span class=line><span class=cl><span class=cm>-   `penguins u x`：将结点  uu  对应的权值  wuwu​  修改为  xx。
</span></span></span><span class=line><span class=cl><span class=cm>-   `excursion u v`：如果结点  uu  和结点  vv  不连通，则输出  `impossible`。否则输出结点  uu  到结点  vv  的路径上的点对应的权值的和。
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>s</span><span class=p>[</span><span class=mi>15</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>node</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>w</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%s%d%d&#34;</span><span class=p>,</span> <span class=n>s</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>u</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;e&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>findRoot</span><span class=p>(</span><span class=n>u</span><span class=p>)</span> <span class=o>!=</span> <span class=n>findRoot</span><span class=p>(</span><span class=n>v</span><span class=p>))</span> <span class=n>printf</span><span class=p>(</span><span class=s>&#34;impossible</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=n>split</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>),</span> <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>node</span><span class=p>[</span><span class=n>v</span><span class=p>].</span><span class=n>sum</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;p&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>splay</span><span class=p>(</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>node</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>w</span> <span class=o>=</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>pushup</span><span class=p>(</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>findRoot</span><span class=p>(</span><span class=n>u</span><span class=p>)</span> <span class=o>==</span> <span class=n>findRoot</span><span class=p>(</span><span class=n>v</span><span class=p>))</span> <span class=n>printf</span><span class=p>(</span><span class=s>&#34;no</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=n>printf</span><span class=p>(</span><span class=s>&#34;yes</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>),</span> <span class=n>link</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=珂朵莉树><a class=header-anchor href=#%e7%8f%82%e6%9c%b5%e8%8e%89%e6%a0%91></a>珂朵莉树</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>typedef</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>ll</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>ll</span> <span class=n>MOD</span> <span class=o>=</span> <span class=mi>1000000007</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>ll</span> <span class=n>MAXN</span> <span class=o>=</span> <span class=mi>100005</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>;</span> <span class=c1>// l和r表示这一段的起点和终点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>mutable</span> <span class=n>ll</span> <span class=n>v</span><span class=p>;</span> <span class=c1>// v表示这一段上所有元素相同的值是多少
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>Node</span><span class=p>(</span><span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>ll</span> <span class=n>r</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>ll</span> <span class=n>v</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>:</span> <span class=n>l</span><span class=p>(</span><span class=n>l</span><span class=p>),</span> <span class=n>r</span><span class=p>(</span><span class=n>r</span><span class=p>),</span> <span class=n>v</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=k>operator</span><span class=o>&lt;</span><span class=p>(</span><span class=k>const</span> <span class=n>Node</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>l</span> <span class=o>&lt;</span> <span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>;</span> <span class=c1>// 规定按照每段的左端点排序
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>seed</span><span class=p>,</span> <span class=n>vmax</span><span class=p>,</span> <span class=n>a</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 以pos去做切割，找到一个包含pos的区间，把它分成[l,pos-1],[pos,r]两半
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>split</span><span class=p>(</span><span class=kt>int</span> <span class=n>pos</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>it</span> <span class=o>=</span> <span class=n>s</span><span class=p>.</span><span class=n>lower_bound</span><span class=p>(</span><span class=n>Node</span><span class=p>(</span><span class=n>pos</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>it</span> <span class=o>!=</span> <span class=n>s</span><span class=p>.</span><span class=n>end</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>l</span> <span class=o>==</span> <span class=n>pos</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>it</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>it</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>it</span><span class=o>-&gt;</span><span class=n>r</span> <span class=o>&lt;</span> <span class=n>pos</span><span class=p>)</span> <span class=k>return</span> <span class=n>s</span><span class=p>.</span><span class=n>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>l</span> <span class=o>=</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>l</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>r</span> <span class=o>=</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>v</span> <span class=o>=</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>it</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>Node</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>pos</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>v</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>s</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>Node</span><span class=p>(</span><span class=n>pos</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>v</span><span class=p>)).</span><span class=n>first</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>add</span><span class=p>(</span><span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>ll</span> <span class=n>r</span><span class=p>,</span> <span class=n>ll</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>itr</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>),</span> <span class=n>itl</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>it</span> <span class=o>=</span> <span class=n>itl</span><span class=p>;</span> <span class=n>it</span> <span class=o>!=</span> <span class=n>itr</span><span class=p>;</span> <span class=o>++</span><span class=n>it</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>it</span><span class=o>-&gt;</span><span class=n>v</span> <span class=o>+=</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>assign</span><span class=p>(</span><span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>ll</span> <span class=n>r</span><span class=p>,</span> <span class=n>ll</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>itr</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>),</span> <span class=n>itl</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>itl</span><span class=p>,</span> <span class=n>itr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>Node</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Rank</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>num</span><span class=p>,</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=k>operator</span><span class=o>&lt;</span><span class=p>(</span><span class=k>const</span> <span class=n>Rank</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>num</span> <span class=o>&lt;</span> <span class=n>a</span><span class=p>.</span><span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Rank</span><span class=p>(</span><span class=n>ll</span> <span class=n>num</span><span class=p>,</span> <span class=n>ll</span> <span class=n>cnt</span><span class=p>)</span> <span class=o>:</span> <span class=n>num</span><span class=p>(</span><span class=n>num</span><span class=p>),</span> <span class=n>cnt</span><span class=p>(</span><span class=n>cnt</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=nf>rnk</span><span class=p>(</span><span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>ll</span> <span class=n>r</span><span class=p>,</span> <span class=n>ll</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>itr</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>),</span> <span class=n>itl</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=n>Rank</span><span class=o>&gt;</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>i</span> <span class=o>=</span> <span class=n>itl</span><span class=p>;</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>itr</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>Rank</span><span class=p>(</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>v</span><span class=p>,</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>r</span> <span class=o>-</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>l</span> <span class=o>+</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>sort</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span> <span class=n>v</span><span class=p>.</span><span class=n>end</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>v</span><span class=p>.</span><span class=n>size</span><span class=p>();</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cnt</span> <span class=o>&lt;</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>-=</span> <span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=nf>ksm</span><span class=p>(</span><span class=n>ll</span> <span class=n>x</span><span class=p>,</span> <span class=n>ll</span> <span class=n>y</span><span class=p>,</span> <span class=n>ll</span> <span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>r</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>base</span> <span class=o>=</span> <span class=n>x</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>y</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>=</span> <span class=n>r</span> <span class=o>*</span> <span class=n>base</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>base</span> <span class=o>=</span> <span class=n>base</span> <span class=o>*</span> <span class=n>base</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>&gt;&gt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=nf>calP</span><span class=p>(</span><span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>ll</span> <span class=n>r</span><span class=p>,</span> <span class=n>ll</span> <span class=n>x</span><span class=p>,</span> <span class=n>ll</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>itr</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>),</span> <span class=n>itl</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>ans</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>i</span> <span class=o>=</span> <span class=n>itl</span><span class=p>;</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>itr</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>=</span> <span class=p>(</span><span class=n>ans</span> <span class=o>+</span> <span class=n>ksm</span><span class=p>(</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>v</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>r</span> <span class=o>-</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>l</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=n>y</span><span class=p>)</span> <span class=o>%</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ans</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=nf>rnd</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>seed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>seed</span> <span class=o>=</span> <span class=p>(</span><span class=n>seed</span> <span class=o>*</span> <span class=mi>7</span> <span class=o>+</span> <span class=mi>13</span><span class=p>)</span> <span class=o>%</span> <span class=n>MOD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=n>m</span> <span class=o>&gt;&gt;</span> <span class=n>seed</span> <span class=o>&gt;&gt;</span> <span class=n>vmax</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=n>vmax</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>Node</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ll</span> <span class=n>op</span><span class=p>,</span> <span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>op</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=mi>4</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>l</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=n>n</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=n>n</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>l</span> <span class=o>&gt;</span> <span class=n>r</span><span class=p>)</span> <span class=n>swap</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=p>(</span><span class=n>r</span> <span class=o>-</span> <span class=n>l</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=n>vmax</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=mi>4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=n>vmax</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>add</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>assign</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>rnk</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>calP</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=三维偏序><a class=header-anchor href=#%e4%b8%89%e7%bb%b4%e5%81%8f%e5%ba%8f></a>三维偏序</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>int</span> <span class=n>MAXN</span> <span class=o>=</span> <span class=mf>1e5</span> <span class=o>+</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>constexpr</span> <span class=kt>int</span> <span class=n>MAXK</span> <span class=o>=</span> <span class=mf>2e5</span> <span class=o>+</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Element</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=k>operator</span><span class=o>!=</span><span class=p>(</span><span class=n>Element</span> <span class=n>other</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>!=</span> <span class=n>other</span><span class=p>.</span><span class=n>a</span><span class=p>)</span> <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>b</span> <span class=o>!=</span> <span class=n>other</span><span class=p>.</span><span class=n>b</span><span class=p>)</span> <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>c</span> <span class=o>!=</span> <span class=n>other</span><span class=p>.</span><span class=n>c</span><span class=p>)</span> <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Element</span> <span class=n>e</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>Element</span> <span class=n>ue</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>m</span><span class=p>,</span> <span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>res</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>BinaryIndexedTree</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>node</span><span class=p>[</span><span class=n>MAXK</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=nf>lowbit</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=n>x</span> <span class=o>&amp;</span> <span class=o>-</span><span class=n>x</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>Add</span><span class=p>(</span><span class=kt>int</span> <span class=n>pos</span><span class=p>,</span> <span class=kt>int</span> <span class=n>val</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>pos</span> <span class=o>&lt;=</span> <span class=n>k</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>node</span><span class=p>[</span><span class=n>pos</span><span class=p>]</span> <span class=o>+=</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>pos</span> <span class=o>+=</span> <span class=n>lowbit</span><span class=p>(</span><span class=n>pos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=nf>Ask</span><span class=p>(</span><span class=kt>int</span> <span class=n>pos</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>res</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>pos</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>res</span> <span class=o>+=</span> <span class=n>node</span><span class=p>[</span><span class=n>pos</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=n>pos</span> <span class=o>-=</span> <span class=n>lowbit</span><span class=p>(</span><span class=n>pos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>BIT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>cmpA</span><span class=p>(</span><span class=n>Element</span> <span class=n>x</span><span class=p>,</span> <span class=n>Element</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>a</span> <span class=o>!=</span> <span class=n>y</span><span class=p>.</span><span class=n>a</span><span class=p>)</span> <span class=k>return</span> <span class=n>x</span><span class=p>.</span><span class=n>a</span> <span class=o>&lt;</span> <span class=n>y</span><span class=p>.</span><span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>b</span> <span class=o>!=</span> <span class=n>y</span><span class=p>.</span><span class=n>b</span><span class=p>)</span> <span class=k>return</span> <span class=n>x</span><span class=p>.</span><span class=n>b</span> <span class=o>&lt;</span> <span class=n>y</span><span class=p>.</span><span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span><span class=p>.</span><span class=n>c</span> <span class=o>&lt;</span> <span class=n>y</span><span class=p>.</span><span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=nf>cmpB</span><span class=p>(</span><span class=n>Element</span> <span class=n>x</span><span class=p>,</span> <span class=n>Element</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>x</span><span class=p>.</span><span class=n>b</span> <span class=o>!=</span> <span class=n>y</span><span class=p>.</span><span class=n>b</span><span class=p>)</span> <span class=k>return</span> <span class=n>x</span><span class=p>.</span><span class=n>b</span> <span class=o>&lt;</span> <span class=n>y</span><span class=p>.</span><span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span><span class=p>.</span><span class=n>c</span> <span class=o>&lt;</span> <span class=n>y</span><span class=p>.</span><span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>CDQ</span><span class=p>(</span><span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=kt>int</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>l</span> <span class=o>==</span> <span class=n>r</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>mid</span> <span class=o>=</span> <span class=p>(</span><span class=n>l</span> <span class=o>+</span> <span class=n>r</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>CDQ</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>mid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>CDQ</span><span class=p>(</span><span class=n>mid</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>sort</span><span class=p>(</span><span class=n>ue</span> <span class=o>+</span> <span class=n>l</span><span class=p>,</span> <span class=n>ue</span> <span class=o>+</span> <span class=n>mid</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>cmpB</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>sort</span><span class=p>(</span><span class=n>ue</span> <span class=o>+</span> <span class=n>mid</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>ue</span> <span class=o>+</span> <span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>cmpB</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>l</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=n>mid</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>j</span> <span class=o>&lt;=</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>i</span> <span class=o>&lt;=</span> <span class=n>mid</span> <span class=o>&amp;&amp;</span> <span class=n>ue</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>b</span> <span class=o>&lt;=</span> <span class=n>ue</span><span class=p>[</span><span class=n>j</span><span class=p>].</span><span class=n>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>BIT</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>ue</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>c</span><span class=p>,</span> <span class=n>ue</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>ue</span><span class=p>[</span><span class=n>j</span><span class=p>].</span><span class=n>res</span> <span class=o>+=</span> <span class=n>BIT</span><span class=p>.</span><span class=n>Ask</span><span class=p>(</span><span class=n>ue</span><span class=p>[</span><span class=n>j</span><span class=p>].</span><span class=n>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>j</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=n>l</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>i</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=n>BIT</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>ue</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>c</span><span class=p>,</span> <span class=o>-</span><span class=n>ue</span><span class=p>[</span><span class=n>k</span><span class=p>].</span><span class=n>cnt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=n>std</span><span class=o>::</span><span class=n>cin</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span><span class=p>.</span><span class=n>tie</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>sync_with_stdio</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=n>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>a</span> <span class=o>&gt;&gt;</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>b</span> <span class=o>&gt;&gt;</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>sort</span><span class=p>(</span><span class=n>e</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>e</span> <span class=o>+</span> <span class=n>n</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>cmpA</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>==</span> <span class=n>n</span> <span class=o>||</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>m</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>ue</span><span class=p>[</span><span class=n>m</span><span class=p>].</span><span class=n>a</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>ue</span><span class=p>[</span><span class=n>m</span><span class=p>].</span><span class=n>b</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>ue</span><span class=p>[</span><span class=n>m</span><span class=p>].</span><span class=n>c</span> <span class=o>=</span> <span class=n>e</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>ue</span><span class=p>[</span><span class=n>m</span><span class=p>].</span><span class=n>cnt</span> <span class=o>=</span> <span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>t</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>CDQ</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=n>res</span><span class=p>[</span><span class=n>ue</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>res</span> <span class=o>+</span> <span class=n>ue</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cnt</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>+=</span> <span class=n>ue</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>res</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;&lt;</span> <span class=sc>&#39;\n&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=cdq><a class=header-anchor href=#cdq></a>CDQ</h3><h4 id=cdq分治优化1d1d动态规划的转移><a class=header-anchor href=#cdq%e5%88%86%e6%b2%bb%e4%bc%98%e5%8c%961d1d%e5%8a%a8%e6%80%81%e8%a7%84%e5%88%92%e7%9a%84%e8%bd%ac%e7%a7%bb></a>CDQ分治优化1D/1D动态规划的转移</h4><p>1D/1D动态规划指的是一类特定的DP问题，该类题目的特征是DP数组是一维的，转移是 $O(n)$ 的。如果条件良好的话，有时可以通过CDQ分治来把它们的时间复杂度由 $O(n^2)$ 降至 $O(n\log^2n)$。</p><p>例如，给定一个序列，每个元素有两个属性 $a, b_i$，我们希望计算一个 DP式子的值，它的转移方程如下：</p>$$dp_i = 1 + \max_{j=1}^{i-1} dp_j [a_j < a_i][b_j < b_i]$$<p>这是一个二维最长上升子序列的DP方程，即只有 $j < i, a_j < a_i, b_j < b_i$ 的点 j 可以更新点 i 的 DP值。</p><p>直接转移显然是 $O(n^2)$ 的。以下是使用 CDQ分治优化转移过程的讲解。</p><p>我们发现 $dp_j$ 转移到 $dp_i$ 这种转移关系也是一种点对间的关系，所以我们用类似 CDQ分治处理点对关系的方式来处理它。</p><p>这个转移过程相对来讲比较套路。假设现在正在处理的区间是 $(l, r)$，算法流程大致如下：</p><ol><li>如果 $l = r$，说明 $dp_r$ 值已经被计算好了。直接令 $dp_r++$ 然后返回即可；</li><li>递归使用 solve(l, mid)；</li><li>处理所有 $l \leq j \leq mid$，mid + 1 $\leq i \leq r$ 的转移关系；</li><li>递归使用 solve(mid+1, r)。</li></ol><p>第三步的做法与CDQ分治求三维偏序差不多。处理 $l \leq j \leq m$ id，mid + 1 $\leq i \leq r$ 的转移关系的时候，我们会发现已经不用管 $j < i$ 这个限制条件了。因此，我们依然先将所有的点 i 和点 j 按 a 值进行排序处理，然后用双指针的方式将 j 点插入到树状数组里，最后查一下前缀最大值更新一下 $dp_i$ 就可以了。</p><h4 id=将动态问题转化为静态问题><a class=header-anchor href=#%e5%b0%86%e5%8a%a8%e6%80%81%e9%97%ae%e9%a2%98%e8%bd%ac%e5%8c%96%e4%b8%ba%e9%9d%99%e6%80%81%e9%97%ae%e9%a2%98></a>将动态问题转化为静态问题</h4><p>前两种情况使用CDQ分治的目的是将序列折半之后递归处理点对间的关系，来获得良好的复杂度。不过在本节中，折半的不是一般的序列，而是时间序列。</p><p>它适用于一些「需要支持做xxx修改然后做xxx询问」的数据结构题。该类题目有两个特点:</p><ul><li>如果把询问离线，所有操作会按照时间自然地排成一个序列。</li><li>每一个修改均与之后的询问操作息息相关。而这样的「修改-询问」关系一共会有 $O(n^2)$ 对。</li></ul><p>我们可以使用CDQ分治对于这个操作序列进行分治，处理修改和询问之间的关系。</p><p>与处理点对关系的CDQ分治类似，假设正在分治的序列是 (l,r)，我们先递归地处理 (l,mid) 和 (mid,r) 之间的修改-询问关系，再处理所有 $l \leq i \leq mid, \text{ mid} + 1 \leq j \leq r$ 的修改-询问关系，其中i是一个修改，j是一个询问。(mid,r) 之间的修改-询问关系，再处理所有 $l \leq i \leq mid, \text{ mid} + 1 \leq j \leq r$ 的修改-询问关系，</p><p>注意，如果各个修改之间是独立的话，我们无需处理 $l \leq i \leq mid$ 和 $mid + 1 \leq j \leq r$，以及 <code>solve(l,mid)</code> 和 <code>solve(mid+1,r)</code> 之间的时序关系（比如普通的加减法问题）。但是如果各个修改之间并不独立（比如说赋值操作），做完这个修改后，序列长什么样可能依赖于之前的序列。此时处理所有跨越mid的修改-询问关系的步骤就必须放在 <code>solve(l,mid)</code> 和 <code>solve(mid+1,r)</code> 之间。理由和CDQ分治优化1D/1D动态规划的原因是一样的：按照中序遍历序进行分治才能保证每一个修改都是严格按照时间顺序执行的。</p><p>例：维护一个长为 n 的序列 $a_i$，有 m 次操作。</p><ol><li>将区间 $[l, r]$ 的值修改为 x；</li><li>查询区间 $[l, r]$ 出现了多少种不同的数，也就是说同一个数出现多次只算一个。</li></ol><p>解题思路：</p><p>一句话题意：区间赋值区间数颜色。</p><p>维护一下每个位置左侧第一个同色点的位置，记为 $pre_i$，此时区间数颜色就被转化为了一个经典的二维数点问题。</p><p>通过将连续的一段颜色看成一个点的方式，可以证明 pre 的变化量是 $O(n+m)$ 的，即单次操作仅仅引起 $O(1)$ 的 pre 值变化，那么我们可以用 CDQ 分治来解决动态的单点加矩形求和问题。</p><p>pre 数组的具体变化可以使用 std::set 来进行处理。这个用 set 维护连续的区间的技巧也被称之为 old driver tree。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;algorithm&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;iostream&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;map&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;set&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>ll</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>ll</span> <span class=n>MOD</span> <span class=o>=</span> <span class=mi>1000000007</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>ll</span> <span class=n>MAXN</span> <span class=o>=</span> <span class=mi>100005</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Node</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>;</span> <span class=c1>// l和r表示这一段的起点和终点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>mutable</span> <span class=n>ll</span> <span class=n>v</span><span class=p>;</span> <span class=c1>// v表示这一段上所有元素相同的值是多少
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>Node</span><span class=p>(</span><span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>ll</span> <span class=n>r</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>ll</span> <span class=n>v</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>:</span> <span class=n>l</span><span class=p>(</span><span class=n>l</span><span class=p>),</span> <span class=n>r</span><span class=p>(</span><span class=n>r</span><span class=p>),</span> <span class=n>v</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=k>operator</span><span class=o>&lt;</span><span class=p>(</span><span class=k>const</span> <span class=n>Node</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>l</span> <span class=o>&lt;</span> <span class=n>a</span><span class=p>.</span><span class=n>l</span><span class=p>;</span> <span class=c1>// 规定按照每段的左端点排序
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=n>n</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>seed</span><span class=p>,</span> <span class=n>vmax</span><span class=p>,</span> <span class=n>a</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 以pos去做切割，找到一个包含pos的区间，把它分成[l,pos-1],[pos,r]两半
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>split</span><span class=p>(</span><span class=kt>int</span> <span class=n>pos</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>it</span> <span class=o>=</span> <span class=n>s</span><span class=p>.</span><span class=n>lower_bound</span><span class=p>(</span><span class=n>Node</span><span class=p>(</span><span class=n>pos</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>it</span> <span class=o>!=</span> <span class=n>s</span><span class=p>.</span><span class=n>end</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>l</span> <span class=o>==</span> <span class=n>pos</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>it</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>it</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>it</span><span class=o>-&gt;</span><span class=n>r</span> <span class=o>&lt;</span> <span class=n>pos</span><span class=p>)</span> <span class=k>return</span> <span class=n>s</span><span class=p>.</span><span class=n>end</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>l</span> <span class=o>=</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>l</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>r</span> <span class=o>=</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>v</span> <span class=o>=</span> <span class=n>it</span><span class=o>-&gt;</span><span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>it</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>Node</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>pos</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>v</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>s</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>Node</span><span class=p>(</span><span class=n>pos</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>v</span><span class=p>)).</span><span class=n>first</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>add</span><span class=p>(</span><span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>ll</span> <span class=n>r</span><span class=p>,</span> <span class=n>ll</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>itr</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>),</span> <span class=n>itl</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>it</span> <span class=o>=</span> <span class=n>itl</span><span class=p>;</span> <span class=n>it</span> <span class=o>!=</span> <span class=n>itr</span><span class=p>;</span> <span class=o>++</span><span class=n>it</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>it</span><span class=o>-&gt;</span><span class=n>v</span> <span class=o>+=</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>assign</span><span class=p>(</span><span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>ll</span> <span class=n>r</span><span class=p>,</span> <span class=n>ll</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>itr</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>),</span> <span class=n>itl</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>itl</span><span class=p>,</span> <span class=n>itr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>Node</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Rank</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>num</span><span class=p>,</span> <span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=k>operator</span><span class=o>&lt;</span><span class=p>(</span><span class=k>const</span> <span class=n>Rank</span> <span class=o>&amp;</span><span class=n>a</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>num</span> <span class=o>&lt;</span> <span class=n>a</span><span class=p>.</span><span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Rank</span><span class=p>(</span><span class=n>ll</span> <span class=n>num</span><span class=p>,</span> <span class=n>ll</span> <span class=n>cnt</span><span class=p>)</span> <span class=o>:</span> <span class=n>num</span><span class=p>(</span><span class=n>num</span><span class=p>),</span> <span class=n>cnt</span><span class=p>(</span><span class=n>cnt</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=nf>rnk</span><span class=p>(</span><span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>ll</span> <span class=n>r</span><span class=p>,</span> <span class=n>ll</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>itr</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>),</span> <span class=n>itl</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=n>Rank</span><span class=o>&gt;</span> <span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>i</span> <span class=o>=</span> <span class=n>itl</span><span class=p>;</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>itr</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>Rank</span><span class=p>(</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>v</span><span class=p>,</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>r</span> <span class=o>-</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>l</span> <span class=o>+</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>sort</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span> <span class=n>v</span><span class=p>.</span><span class=n>end</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>v</span><span class=p>.</span><span class=n>size</span><span class=p>();</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cnt</span> <span class=o>&lt;</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>-=</span> <span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>cnt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>v</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=nf>ksm</span><span class=p>(</span><span class=n>ll</span> <span class=n>x</span><span class=p>,</span> <span class=n>ll</span> <span class=n>y</span><span class=p>,</span> <span class=n>ll</span> <span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>r</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>base</span> <span class=o>=</span> <span class=n>x</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>y</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>=</span> <span class=n>r</span> <span class=o>*</span> <span class=n>base</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>base</span> <span class=o>=</span> <span class=n>base</span> <span class=o>*</span> <span class=n>base</span> <span class=o>%</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>y</span> <span class=o>&gt;&gt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=nf>calP</span><span class=p>(</span><span class=n>ll</span> <span class=n>l</span><span class=p>,</span> <span class=n>ll</span> <span class=n>r</span><span class=p>,</span> <span class=n>ll</span> <span class=n>x</span><span class=p>,</span> <span class=n>ll</span> <span class=n>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>itr</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>r</span> <span class=o>+</span> <span class=mi>1</span><span class=p>),</span> <span class=n>itl</span> <span class=o>=</span> <span class=n>split</span><span class=p>(</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>ans</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>set</span><span class=o>&lt;</span><span class=n>Node</span><span class=o>&gt;::</span><span class=n>iterator</span> <span class=n>i</span> <span class=o>=</span> <span class=n>itl</span><span class=p>;</span> <span class=n>i</span> <span class=o>!=</span> <span class=n>itr</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ans</span> <span class=o>=</span> <span class=p>(</span><span class=n>ans</span> <span class=o>+</span> <span class=n>ksm</span><span class=p>(</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>v</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=n>i</span><span class=o>-&gt;</span><span class=n>r</span> <span class=o>-</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>l</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=n>y</span><span class=p>)</span> <span class=o>%</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ans</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=nf>rnd</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ll</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>seed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>seed</span> <span class=o>=</span> <span class=p>(</span><span class=n>seed</span> <span class=o>*</span> <span class=mi>7</span> <span class=o>+</span> <span class=mi>13</span><span class=p>)</span> <span class=o>%</span> <span class=n>MOD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>cin</span> <span class=o>&gt;&gt;</span> <span class=n>n</span> <span class=o>&gt;&gt;</span> <span class=n>m</span> <span class=o>&gt;&gt;</span> <span class=n>seed</span> <span class=o>&gt;&gt;</span> <span class=n>vmax</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=n>vmax</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=n>Node</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ll</span> <span class=n>op</span><span class=p>,</span> <span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>op</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=mi>4</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>l</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=n>n</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>r</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=n>n</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>l</span> <span class=o>&gt;</span> <span class=n>r</span><span class=p>)</span> <span class=n>swap</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=p>(</span><span class=n>r</span> <span class=o>-</span> <span class=n>l</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=n>vmax</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=mi>4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span> <span class=o>=</span> <span class=p>(</span><span class=n>rnd</span><span class=p>()</span> <span class=o>%</span> <span class=n>vmax</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>add</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>assign</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>op</span> <span class=o>==</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>rnk</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>cout</span> <span class=o>&lt;&lt;</span> <span class=n>calP</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=n>endl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=整体二分><a class=header-anchor href=#%e6%95%b4%e4%bd%93%e4%ba%8c%e5%88%86></a>整体二分</h3><p>记 $[l, r]$ 为答案的值域, $[L, R]$ 为答案的定义域。(也就是说求答案时仅考虑下标在区间 $[L, R]$ 内的操作和询问，这其中询问的答案在 $[l, r]$ 内)</p><ul><li>我们首先把所有操作按时间顺序存入数组中, 然后开始分治。</li><li>在每一层分治中, 利用数据结构(常见的是树状数组)统计当前查询的答案和 mid 之间的关系。</li><li>根据查询出来的答案和 mid 间的关系(小于等于 mid 和大于 mid)将当前处理的操作序列分为 q1 和 q2 两份，并分别递归处理。</li></ul><p>当 $l = r$ 时，找到答案，记录答案并返回即可。</p><p>需要注意的是，在整体二分过程中，若当前处理的值域为 $[l, r]$，则此时最终答案范围不在 $[l, r]$ 的询问会在其他时候处理。</p><p>例1：全局第k小</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=nf>check</span><span class=p>(</span><span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=kt>int</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>res</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>l</span> <span class=o>&lt;=</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>r</span><span class=p>)</span> <span class=n>res</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>solve</span><span class=p>(</span><span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=kt>int</span> <span class=n>r</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>Query</span><span class=o>&gt;</span> <span class=n>q</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>l</span> <span class=o>&gt;</span> <span class=n>r</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>m</span> <span class=o>=</span> <span class=p>(</span><span class=n>l</span> <span class=o>+</span> <span class=n>r</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>l</span> <span class=o>==</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>qi</span> <span class=p>:</span> <span class=n>q</span><span class=p>)</span> <span class=n>ans</span><span class=p>[</span><span class=n>qi</span><span class=p>.</span><span class=n>id</span><span class=p>]</span> <span class=o>=</span> <span class=n>l</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=n>Query</span><span class=o>&gt;</span> <span class=n>q1</span><span class=p>,</span> <span class=n>q2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>t</span> <span class=o>=</span> <span class=n>check</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>qi</span> <span class=p>:</span> <span class=n>q</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>qi</span><span class=p>.</span><span class=n>k</span> <span class=o>&lt;=</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>q1</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>qi</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>qi</span><span class=p>.</span><span class=n>k</span> <span class=o>-=</span> <span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>q2</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>qi</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>solve</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>q1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>solve</span><span class=p>(</span><span class=n>m</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>q2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>例2：区间第k小</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Num</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>p</span><span class=p>,</span> <span class=n>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>  <span class=c1>// 位于数列中第 p 项的数的值为 x
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Query</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>k</span><span class=p>,</span> <span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>  <span class=c1>// 一个编号为 id, 询问 [l,r] 中第 k 小数的询问
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>ans</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>add</span><span class=p>(</span><span class=kt>int</span> <span class=n>p</span><span class=p>,</span> <span class=kt>int</span> <span class=n>x</span><span class=p>);</span>  <span class=c1>// 树状数组, 在 p 位置加上 x
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>query</span><span class=p>(</span><span class=kt>int</span> <span class=n>p</span><span class=p>);</span>        <span class=c1>// 树状数组, 求 [1,p] 的和
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>clear</span><span class=p>();</span>            <span class=c1>// 树状数组, 清空
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>solve</span><span class=p>(</span><span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=kt>int</span> <span class=n>r</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>Num</span><span class=o>&gt;</span> <span class=n>a</span><span class=p>,</span> <span class=n>vector</span><span class=o>&lt;</span><span class=n>Query</span><span class=o>&gt;</span> <span class=n>q</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>m</span> <span class=o>=</span> <span class=p>(</span><span class=n>l</span> <span class=o>+</span> <span class=n>r</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>l</span> <span class=o>==</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>qi</span> <span class=p>:</span> <span class=n>q</span><span class=p>)</span> <span class=n>ans</span><span class=p>[</span><span class=n>qi</span><span class=p>.</span><span class=n>id</span><span class=p>]</span> <span class=o>=</span> <span class=n>l</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=n>Num</span><span class=o>&gt;</span> <span class=n>a1</span><span class=p>,</span> <span class=n>a2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>vector</span><span class=o>&lt;</span><span class=n>Query</span><span class=o>&gt;</span> <span class=n>q1</span><span class=p>,</span> <span class=n>q2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>num</span> <span class=p>:</span> <span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>num</span><span class=p>.</span><span class=n>x</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>a1</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>num</span><span class=p>),</span> <span class=n>add</span><span class=p>(</span><span class=n>num</span><span class=p>.</span><span class=n>p</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=n>a2</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>num</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>qi</span> <span class=p>:</span> <span class=n>q</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>t</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span><span class=n>qi</span><span class=p>.</span><span class=n>r</span><span class=p>)</span> <span class=o>-</span> <span class=n>query</span><span class=p>(</span><span class=n>qi</span><span class=p>.</span><span class=n>l</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>qi</span><span class=p>.</span><span class=n>k</span> <span class=o>&lt;=</span> <span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>q1</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>qi</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=n>q2</span><span class=p>.</span><span class=n>push_back</span><span class=p>({</span><span class=n>qi</span><span class=p>.</span><span class=n>l</span><span class=p>,</span> <span class=n>qi</span><span class=p>.</span><span class=n>r</span><span class=p>,</span> <span class=n>qi</span><span class=p>.</span><span class=n>k</span> <span class=o>-</span> <span class=n>t</span><span class=p>,</span> <span class=n>qi</span><span class=p>.</span><span class=n>id</span><span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>solve</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>a1</span><span class=p>,</span> <span class=n>q1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>solve</span><span class=p>(</span><span class=n>m</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>a2</span><span class=p>,</span> <span class=n>q2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>例3：带修区间第k小</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Opt</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>k</span><span class=p>,</span> <span class=n>type</span><span class=p>,</span> <span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 对于询问, type = 1, x, y 表示区间左右边界, k 表示询问第 k 小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 对于修改, type = 0, x 表示修改位置, y 表示修改后的值,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// k 表示当前操作是插入(1)还是擦除(-1), 更新树状数组时使用.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// id 记录每个操作原先的编号, 因二分过程中操作顺序会被打散
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Opt</span> <span class=n>q</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>q1</span><span class=p>[</span><span class=n>N</span><span class=p>],</span> <span class=n>q2</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=c1>// q 为所有操作,
</span></span></span><span class=line><span class=cl><span class=c1>// 二分过程中, 分到左边的操作存到 q1 中, 分到右边的操作存到 q2 中.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>ans</span><span class=p>[</span><span class=n>N</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>add</span><span class=p>(</span><span class=kt>int</span> <span class=n>p</span><span class=p>,</span> <span class=kt>int</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>query</span><span class=p>(</span><span class=kt>int</span> <span class=n>p</span><span class=p>);</span>  <span class=c1>// 树状数组函数, 含义见题3
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>solve</span><span class=p>(</span><span class=kt>int</span> <span class=n>l</span><span class=p>,</span> <span class=kt>int</span> <span class=n>r</span><span class=p>,</span> <span class=kt>int</span> <span class=n>L</span><span class=p>,</span> <span class=kt>int</span> <span class=n>R</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当前的值域范围为 [l,r], 处理的操作的区间为 [L,R]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>l</span> <span class=o>&gt;</span> <span class=n>r</span> <span class=o>||</span> <span class=n>L</span> <span class=o>&gt;</span> <span class=n>R</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>cnt1</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>cnt2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>m</span> <span class=o>=</span> <span class=p>(</span><span class=n>l</span> <span class=o>+</span> <span class=n>r</span><span class=p>)</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// cnt1, cnt2 分别为分到左边, 分到右边的操作数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>l</span> <span class=o>==</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>L</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>R</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>type</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=n>ans</span><span class=p>[</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>id</span><span class=p>]</span> <span class=o>=</span> <span class=n>l</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>L</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>R</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>type</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// 是询问: 进行分类
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=kt>int</span> <span class=n>t</span> <span class=o>=</span> <span class=n>query</span><span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>y</span><span class=p>)</span> <span class=o>-</span> <span class=n>query</span><span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>x</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>k</span> <span class=o>&lt;=</span> <span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>q1</span><span class=p>[</span><span class=o>++</span><span class=n>cnt1</span><span class=p>]</span> <span class=o>=</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>k</span> <span class=o>-=</span> <span class=n>t</span><span class=p>,</span> <span class=n>q2</span><span class=p>[</span><span class=o>++</span><span class=n>cnt2</span><span class=p>]</span> <span class=o>=</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 是修改: 更新树状数组 &amp; 分类
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>y</span> <span class=o>&lt;=</span> <span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>add</span><span class=p>(</span><span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>x</span><span class=p>,</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>k</span><span class=p>),</span> <span class=n>q1</span><span class=p>[</span><span class=o>++</span><span class=n>cnt1</span><span class=p>]</span> <span class=o>=</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=n>q2</span><span class=p>[</span><span class=o>++</span><span class=n>cnt2</span><span class=p>]</span> <span class=o>=</span> <span class=n>q</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>cnt1</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>q1</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>type</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=n>add</span><span class=p>(</span><span class=n>q1</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>x</span><span class=p>,</span> <span class=o>-</span><span class=n>q1</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>k</span><span class=p>);</span>  <span class=c1>// 清空树状数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>cnt1</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=n>q</span><span class=p>[</span><span class=n>L</span> <span class=o>+</span> <span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>q1</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=n>cnt2</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>q</span><span class=p>[</span><span class=n>L</span> <span class=o>+</span> <span class=n>cnt1</span> <span class=o>+</span> <span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>q2</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>  <span class=c1>// 将临时数组中的元素合并回原数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>solve</span><span class=p>(</span><span class=n>l</span><span class=p>,</span> <span class=n>m</span><span class=p>,</span> <span class=n>L</span><span class=p>,</span> <span class=n>L</span> <span class=o>+</span> <span class=n>cnt1</span> <span class=o>-</span> <span class=mi>1</span><span class=p>),</span> <span class=n>solve</span><span class=p>(</span><span class=n>m</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>L</span> <span class=o>+</span> <span class=n>cnt1</span><span class=p>,</span> <span class=n>R</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=附录><a class=header-anchor href=#%e9%99%84%e5%bd%95></a>附录</h2><h3 id=at1219><a class=header-anchor href=#at1219></a>AT1219</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>回滚莫队 
</span></span></span><span class=line><span class=cl><span class=cm>要点：左端点分块，右端点递增，初始两个指针指向块的末端，特判左右断点在同一块内的情况！ 
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=cp>#include&lt;bits/stdc++.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=kt>long</span> <span class=kt>long</span> <span class=n>ll</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#define pb push_back
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>const</span> <span class=kt>int</span> <span class=n>MAXN</span><span class=o>=</span><span class=kt>int</span><span class=p>(</span><span class=mf>1e5</span><span class=o>+</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>int</span> <span class=n>MAXB</span><span class=o>=</span><span class=kt>int</span><span class=p>(</span><span class=mf>1e5</span><span class=o>+</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span><span class=n>m</span><span class=p>,</span><span class=n>bnum</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=n>a</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>col</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>cnt</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>cnt2</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=n>ll</span><span class=o>&gt;</span> <span class=n>alls</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>belong</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>st</span><span class=p>[</span><span class=n>MAXB</span><span class=p>],</span><span class=n>ed</span><span class=p>[</span><span class=n>MAXB</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>l</span><span class=p>,</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>ll</span> <span class=n>ans</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>query</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>l</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>bool</span> <span class=k>operator</span> <span class=o>&lt;</span> <span class=p>(</span><span class=k>const</span> <span class=n>query</span> <span class=o>&amp;</span><span class=n>W</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=p>(</span><span class=n>belong</span><span class=p>[</span><span class=n>l</span><span class=p>]</span><span class=o>^</span><span class=n>belong</span><span class=p>[</span><span class=n>W</span><span class=p>.</span><span class=n>l</span><span class=p>])</span><span class=o>?</span><span class=n>belong</span><span class=p>[</span><span class=n>l</span><span class=p>]</span><span class=o>&lt;</span><span class=n>belong</span><span class=p>[</span><span class=n>W</span><span class=p>.</span><span class=n>l</span><span class=p>]</span><span class=o>:</span><span class=n>r</span><span class=o>&lt;</span><span class=n>W</span><span class=p>.</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=n>Q</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>find</span><span class=p>(</span><span class=n>ll</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>l</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span><span class=n>r</span><span class=o>=</span><span class=n>alls</span><span class=p>.</span><span class=n>size</span><span class=p>()</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span><span class=p>(</span><span class=n>l</span><span class=o>&lt;</span><span class=n>r</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>mid</span><span class=o>=</span><span class=p>(</span><span class=n>l</span><span class=o>+</span><span class=n>r</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>alls</span><span class=p>[</span><span class=n>mid</span><span class=p>]</span><span class=o>&lt;=</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>l</span><span class=o>=</span><span class=n>mid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span>
</span></span><span class=line><span class=cl>			<span class=n>r</span><span class=o>=</span><span class=n>mid</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>l</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Init_col</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>sort</span><span class=p>(</span><span class=n>alls</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=n>alls</span><span class=p>.</span><span class=n>end</span><span class=p>());</span>
</span></span><span class=line><span class=cl>	<span class=n>alls</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>unique</span><span class=p>(</span><span class=n>alls</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=n>alls</span><span class=p>.</span><span class=n>end</span><span class=p>()),</span><span class=n>alls</span><span class=p>.</span><span class=n>end</span><span class=p>());</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>n</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>col</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>find</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Init_belong</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>size</span><span class=o>=</span><span class=n>sqrt</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>bnum</span><span class=o>=</span><span class=n>ceil</span><span class=p>(</span><span class=n>n</span><span class=o>/</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>n</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>st</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=n>size</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=n>ed</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>min</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=n>i</span><span class=o>*</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>j</span><span class=o>=</span><span class=n>st</span><span class=p>[</span><span class=n>i</span><span class=p>];</span><span class=n>j</span><span class=o>&lt;=</span><span class=n>ed</span><span class=p>[</span><span class=n>i</span><span class=p>];</span><span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>belong</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Add</span><span class=p>(</span><span class=kt>int</span> <span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>cnt</span><span class=p>[</span><span class=n>col</span><span class=p>[</span><span class=n>p</span><span class=p>]]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>now</span><span class=o>=</span><span class=n>max</span><span class=p>(</span><span class=n>now</span><span class=p>,</span><span class=mi>1ll</span><span class=o>*</span><span class=n>cnt</span><span class=p>[</span><span class=n>col</span><span class=p>[</span><span class=n>p</span><span class=p>]]</span><span class=o>*</span><span class=n>a</span><span class=p>[</span><span class=n>p</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Del</span><span class=p>(</span><span class=kt>int</span> <span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>cnt</span><span class=p>[</span><span class=n>col</span><span class=p>[</span><span class=n>p</span><span class=p>]]</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>n</span><span class=p>,</span><span class=o>&amp;</span><span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>n</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%lld&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>		<span class=n>alls</span><span class=p>.</span><span class=n>pb</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>Init_col</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>Init_belong</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>m</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>ql</span><span class=p>,</span><span class=n>qr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>ql</span><span class=p>,</span><span class=o>&amp;</span><span class=n>qr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=p>{</span><span class=n>ql</span><span class=p>,</span><span class=n>qr</span><span class=p>,</span><span class=n>i</span><span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>sort</span><span class=p>(</span><span class=n>Q</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=n>Q</span><span class=o>+</span><span class=n>m</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>k</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>k</span><span class=o>&lt;=</span><span class=n>bnum</span><span class=p>;</span><span class=n>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>l</span><span class=o>=</span><span class=n>ed</span><span class=p>[</span><span class=n>k</span><span class=p>],</span><span class=n>r</span><span class=o>=</span><span class=n>ed</span><span class=p>[</span><span class=n>k</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>now</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>memset</span><span class=p>(</span><span class=n>cnt</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=n>cnt</span><span class=p>));</span>
</span></span><span class=line><span class=cl>		<span class=n>Add</span><span class=p>(</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>belong</span><span class=p>[</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>l</span><span class=p>]</span><span class=o>==</span><span class=n>k</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>ql</span><span class=o>=</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>l</span><span class=p>,</span><span class=n>qr</span><span class=o>=</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span><span class=p>(</span><span class=n>belong</span><span class=p>[</span><span class=n>ql</span><span class=p>]</span><span class=o>==</span><span class=n>belong</span><span class=p>[</span><span class=n>qr</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>ll</span> <span class=n>tmp</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>j</span><span class=o>=</span><span class=n>ql</span><span class=p>;</span><span class=n>j</span><span class=o>&lt;=</span><span class=n>qr</span><span class=p>;</span><span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=n>cnt2</span><span class=p>[</span><span class=n>col</span><span class=p>[</span><span class=n>j</span><span class=p>]]</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>j</span><span class=o>=</span><span class=n>ql</span><span class=p>;</span><span class=n>j</span><span class=o>&lt;=</span><span class=n>qr</span><span class=p>;</span><span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=n>cnt2</span><span class=p>[</span><span class=n>col</span><span class=p>[</span><span class=n>j</span><span class=p>]]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>					<span class=n>tmp</span><span class=o>=</span><span class=n>max</span><span class=p>(</span><span class=n>tmp</span><span class=p>,</span><span class=n>a</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>*</span><span class=p>(</span><span class=mi>1ll</span><span class=o>*</span><span class=n>cnt2</span><span class=p>[</span><span class=n>col</span><span class=p>[</span><span class=n>j</span><span class=p>]]));</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=n>ans</span><span class=p>[</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>id</span><span class=p>]</span><span class=o>=</span><span class=n>tmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=n>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>while</span><span class=p>(</span><span class=n>r</span><span class=o>&lt;</span><span class=n>qr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=n>Add</span><span class=p>(</span><span class=o>++</span><span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>ll</span> <span class=n>tmp</span><span class=o>=</span><span class=n>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>while</span><span class=p>(</span><span class=n>l</span><span class=o>&gt;</span><span class=n>ql</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=n>Add</span><span class=p>(</span><span class=o>--</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>ans</span><span class=p>[</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>id</span><span class=p>]</span><span class=o>=</span><span class=n>now</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>while</span><span class=p>(</span><span class=n>l</span><span class=o>&lt;</span><span class=n>ed</span><span class=p>[</span><span class=n>k</span><span class=p>]</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=n>Del</span><span class=p>(</span><span class=n>l</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>now</span><span class=o>=</span><span class=n>tmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>m</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%lld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>ans</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=luogu_1903><a class=header-anchor href=#luogu_1903></a>luogu_1903</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// 带修莫队 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include&lt;bits/stdc++.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>int</span> <span class=n>MAXN</span><span class=o>=</span><span class=kt>int</span><span class=p>(</span><span class=mf>1e6</span><span class=o>+</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span><span class=n>m</span><span class=p>,</span><span class=n>qm</span><span class=p>,</span><span class=n>cm</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>a</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>ans</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>belong</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>cnt</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>l</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>tag</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>query</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>l</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>t</span><span class=p>,</span><span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>bool</span> <span class=k>operator</span> <span class=o>&lt;</span> <span class=p>(</span><span class=k>const</span> <span class=n>query</span> <span class=o>&amp;</span><span class=n>w</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=p>(</span><span class=n>belong</span><span class=p>[</span><span class=n>l</span><span class=p>]</span><span class=o>^</span><span class=n>belong</span><span class=p>[</span><span class=n>w</span><span class=p>.</span><span class=n>l</span><span class=p>])</span><span class=o>?</span><span class=p>(</span><span class=n>belong</span><span class=p>[</span><span class=n>l</span><span class=p>]</span><span class=o>&lt;</span><span class=n>belong</span><span class=p>[</span><span class=n>w</span><span class=p>.</span><span class=n>l</span><span class=p>])</span><span class=o>:</span><span class=p>((</span><span class=n>belong</span><span class=p>[</span><span class=n>r</span><span class=p>]</span><span class=o>^</span><span class=n>belong</span><span class=p>[</span><span class=n>w</span><span class=p>.</span><span class=n>r</span><span class=p>])</span><span class=o>?</span><span class=p>((</span><span class=n>belong</span><span class=p>[</span><span class=n>l</span><span class=p>]</span><span class=o>&amp;</span><span class=mi>1</span><span class=p>)</span><span class=o>?</span><span class=n>belong</span><span class=p>[</span><span class=n>r</span><span class=p>]</span><span class=o>&lt;</span><span class=n>belong</span><span class=p>[</span><span class=n>w</span><span class=p>.</span><span class=n>r</span><span class=p>]</span><span class=o>:</span><span class=n>belong</span><span class=p>[</span><span class=n>r</span><span class=p>]</span><span class=o>&gt;</span><span class=n>belong</span><span class=p>[</span><span class=n>w</span><span class=p>.</span><span class=n>r</span><span class=p>])</span><span class=o>:</span><span class=n>t</span><span class=o>&lt;</span><span class=n>w</span><span class=p>.</span><span class=n>t</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=n>Q</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Init_belong</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>size</span><span class=o>=</span><span class=n>pow</span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=mf>2.0</span><span class=o>/</span><span class=mf>3.0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>bnum</span><span class=o>=</span><span class=n>ceil</span><span class=p>(</span><span class=n>n</span><span class=o>/</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>bnum</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>j</span><span class=o>=</span><span class=n>size</span><span class=o>*</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span><span class=n>j</span><span class=o>&lt;=</span><span class=n>size</span><span class=o>*</span><span class=n>i</span><span class=o>&amp;&amp;</span><span class=n>j</span><span class=o>&lt;</span><span class=n>MAXN</span><span class=p>;</span><span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>belong</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>modify</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>p</span><span class=p>,</span><span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=n>C</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Add</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>sum</span><span class=o>+=</span><span class=p>(</span><span class=o>!</span><span class=n>cnt</span><span class=p>[</span><span class=n>a</span><span class=p>[</span><span class=n>x</span><span class=p>]]);</span>
</span></span><span class=line><span class=cl>	<span class=n>cnt</span><span class=p>[</span><span class=n>a</span><span class=p>[</span><span class=n>x</span><span class=p>]]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Del</span><span class=p>(</span><span class=kt>int</span> <span class=n>x</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>cnt</span><span class=p>[</span><span class=n>a</span><span class=p>[</span><span class=n>x</span><span class=p>]]</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>sum</span><span class=o>-=</span><span class=p>(</span><span class=o>!</span><span class=n>cnt</span><span class=p>[</span><span class=n>a</span><span class=p>[</span><span class=n>x</span><span class=p>]]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Modify</span><span class=p>(</span><span class=kt>int</span> <span class=n>p</span><span class=p>,</span><span class=kt>int</span> <span class=n>c</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>l</span><span class=o>&lt;=</span><span class=n>p</span><span class=o>&amp;&amp;</span><span class=n>p</span><span class=o>&lt;=</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>Del</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>l</span><span class=o>&lt;=</span><span class=n>p</span><span class=o>&amp;&amp;</span><span class=n>p</span><span class=o>&lt;=</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>Add</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Do_change</span><span class=p>(</span><span class=kt>int</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>p</span><span class=o>=</span><span class=n>C</span><span class=p>[</span><span class=n>t</span><span class=p>].</span><span class=n>p</span><span class=p>,</span><span class=o>&amp;</span><span class=n>c</span><span class=o>=</span><span class=n>C</span><span class=p>[</span><span class=n>t</span><span class=p>].</span><span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>l</span><span class=o>&lt;=</span><span class=n>p</span><span class=o>&amp;&amp;</span><span class=n>p</span><span class=o>&lt;=</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>Del</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>swap</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=n>a</span><span class=p>[</span><span class=n>p</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>l</span><span class=o>&lt;=</span><span class=n>p</span><span class=o>&amp;&amp;</span><span class=n>p</span><span class=o>&lt;=</span><span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>Add</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>n</span><span class=p>,</span><span class=o>&amp;</span><span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>Init_belong</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>n</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=n>qm</span><span class=o>=</span><span class=n>cm</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span><span class=p>(</span><span class=n>m</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>char</span> <span class=n>op</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span><span class=n>op</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>op</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>==</span><span class=sc>&#39;Q&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>l</span><span class=p>,</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>l</span><span class=p>,</span><span class=o>&amp;</span><span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>Q</span><span class=p>[</span><span class=o>++</span><span class=n>qm</span><span class=p>]</span><span class=o>=</span><span class=p>{</span><span class=n>l</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>cm</span><span class=p>,</span><span class=n>qm</span><span class=p>};</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kt>int</span> <span class=n>p</span><span class=p>,</span><span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>p</span><span class=p>,</span><span class=o>&amp;</span><span class=n>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=n>C</span><span class=p>[</span><span class=o>++</span><span class=n>cm</span><span class=p>]</span><span class=o>=</span><span class=p>{</span><span class=n>p</span><span class=p>,</span><span class=n>c</span><span class=p>};</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span><span class=n>l</span><span class=o>=</span><span class=n>r</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span><span class=n>tag</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>sort</span><span class=p>(</span><span class=n>Q</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=n>Q</span><span class=o>+</span><span class=n>qm</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>qm</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>ql</span><span class=o>=</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>l</span><span class=p>,</span><span class=n>qr</span><span class=o>=</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>r</span><span class=p>,</span><span class=n>qt</span><span class=o>=</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>ql</span><span class=o>&lt;</span><span class=n>l</span><span class=p>)</span> <span class=n>Add</span><span class=p>(</span><span class=o>--</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>ql</span><span class=o>&gt;</span><span class=n>l</span><span class=p>)</span> <span class=n>Del</span><span class=p>(</span><span class=n>l</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>qr</span><span class=o>&lt;</span><span class=n>r</span><span class=p>)</span> <span class=n>Del</span><span class=p>(</span><span class=n>r</span><span class=o>--</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>qr</span><span class=o>&gt;</span><span class=n>r</span><span class=p>)</span> <span class=n>Add</span><span class=p>(</span><span class=o>++</span><span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>qt</span><span class=o>&gt;</span><span class=n>tag</span><span class=p>)</span> <span class=n>Do_change</span><span class=p>(</span><span class=o>++</span><span class=n>tag</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>qt</span><span class=o>&lt;</span><span class=n>tag</span><span class=p>)</span> <span class=n>Do_change</span><span class=p>(</span><span class=n>tag</span><span class=o>--</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>ans</span><span class=p>[</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>id</span><span class=p>]</span><span class=o>=</span><span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>qm</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>ans</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=luogu_sp10707><a class=header-anchor href=#luogu_sp10707></a>luogu_sp10707</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// 树上莫队 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include&lt;bits/stdc++.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>int</span> <span class=n>MAXN</span><span class=o>=</span><span class=kt>int</span><span class=p>(</span><span class=mf>4e4</span><span class=o>+</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>int</span> <span class=n>MAXM</span><span class=o>=</span><span class=kt>int</span><span class=p>(</span><span class=mf>1e5</span><span class=o>+</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#define pb push_back
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>int</span> <span class=n>n</span><span class=p>,</span><span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span> <span class=n>G</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>dep</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>p</span><span class=p>[</span><span class=n>MAXN</span><span class=p>][</span><span class=mi>22</span><span class=p>],</span><span class=n>lg</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>col</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>cnt</span><span class=p>[</span><span class=n>MAXM</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>bool</span> <span class=n>vis</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>st</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>ed</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>name</span><span class=p>[</span><span class=mi>2</span><span class=o>*</span><span class=n>MAXN</span><span class=p>],</span><span class=n>idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>l</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>belong</span><span class=p>[</span><span class=n>MAXN</span><span class=o>*</span><span class=mi>2</span><span class=p>],</span><span class=n>ans</span><span class=p>[</span><span class=n>MAXM</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>query</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>l</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>lca</span><span class=p>,</span><span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>bool</span> <span class=k>operator</span> <span class=o>&lt;</span> <span class=p>(</span><span class=k>const</span> <span class=n>query</span> <span class=o>&amp;</span><span class=n>W</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=p>(</span><span class=n>belong</span><span class=p>[</span><span class=n>l</span><span class=p>]</span><span class=o>^</span><span class=n>belong</span><span class=p>[</span><span class=n>W</span><span class=p>.</span><span class=n>l</span><span class=p>])</span><span class=o>?</span><span class=n>belong</span><span class=p>[</span><span class=n>l</span><span class=p>]</span><span class=o>&lt;</span><span class=n>belong</span><span class=p>[</span><span class=n>W</span><span class=p>.</span><span class=n>l</span><span class=p>]</span><span class=o>:</span><span class=p>((</span><span class=n>belong</span><span class=p>[</span><span class=n>l</span><span class=p>]</span><span class=o>&amp;</span><span class=mi>1</span><span class=p>)</span><span class=o>?</span><span class=n>belong</span><span class=p>[</span><span class=n>r</span><span class=p>]</span><span class=o>&lt;</span><span class=n>belong</span><span class=p>[</span><span class=n>W</span><span class=p>.</span><span class=n>r</span><span class=p>]</span><span class=o>:</span><span class=n>belong</span><span class=p>[</span><span class=n>r</span><span class=p>]</span><span class=o>&gt;</span><span class=n>belong</span><span class=p>[</span><span class=n>W</span><span class=p>.</span><span class=n>r</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=n>Q</span><span class=p>[</span><span class=n>MAXM</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=cp>#define Add(p) sum+=(!cnt[col[name[p]]]++)
</span></span></span><span class=line><span class=cl><span class=cp>#define Del(p) sum-=(!--cnt[col[name[p]]])
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=kt>void</span> <span class=nf>Init_lg</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>n</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>lg</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>lg</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>+</span><span class=p>(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>lg</span><span class=p>[</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>==</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Init_belong</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>size</span><span class=o>=</span><span class=n>pow</span><span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=n>n</span><span class=p>,</span><span class=mf>2.0</span><span class=o>/</span><span class=mf>3.0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>bnum</span><span class=o>=</span><span class=n>ceil</span><span class=p>(</span><span class=mi>2</span><span class=o>*</span><span class=n>n</span><span class=o>/</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>bnum</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>j</span><span class=o>=</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=n>bnum</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span><span class=n>j</span><span class=o>&lt;=</span><span class=n>i</span><span class=o>*</span><span class=n>bnum</span><span class=o>&amp;&amp;</span><span class=n>j</span><span class=o>&lt;=</span><span class=mi>2</span><span class=o>*</span><span class=n>n</span><span class=p>;</span><span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>belong</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Change</span><span class=p>(</span><span class=kt>int</span> <span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>vis</span><span class=p>[</span><span class=n>p</span><span class=p>])</span> <span class=n>Del</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>else</span> <span class=n>Add</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>vis</span><span class=p>[</span><span class=n>p</span><span class=p>]</span><span class=o>^=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Dfs0</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>,</span><span class=kt>int</span> <span class=n>fa</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>st</span><span class=p>[</span><span class=n>u</span><span class=p>]</span><span class=o>=++</span><span class=n>idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>name</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span><span class=o>=</span><span class=n>u</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>dep</span><span class=p>[</span><span class=n>u</span><span class=p>]</span><span class=o>=</span><span class=n>dep</span><span class=p>[</span><span class=n>fa</span><span class=p>]</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>p</span><span class=p>[</span><span class=n>u</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span><span class=o>=</span><span class=n>fa</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;(</span><span class=mi>1</span><span class=o>&lt;&lt;</span><span class=n>i</span><span class=p>)</span><span class=o>&lt;=</span><span class=n>dep</span><span class=p>[</span><span class=n>u</span><span class=p>];</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>p</span><span class=p>[</span><span class=n>u</span><span class=p>][</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>p</span><span class=p>[</span><span class=n>p</span><span class=p>[</span><span class=n>u</span><span class=p>][</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>]][</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=k>auto</span> <span class=nl>v</span><span class=p>:</span><span class=n>G</span><span class=p>[</span><span class=n>u</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>v</span><span class=o>!=</span><span class=n>fa</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>Dfs0</span><span class=p>(</span><span class=n>v</span><span class=p>,</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>ed</span><span class=p>[</span><span class=n>u</span><span class=p>]</span><span class=o>=++</span><span class=n>idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>name</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span><span class=o>=</span><span class=n>u</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>lca</span><span class=p>(</span><span class=kt>int</span> <span class=n>u</span><span class=p>,</span><span class=kt>int</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>dep</span><span class=p>[</span><span class=n>u</span><span class=p>]</span><span class=o>&lt;</span><span class=n>dep</span><span class=p>[</span><span class=n>v</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=n>swap</span><span class=p>(</span><span class=n>u</span><span class=p>,</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span><span class=p>(</span><span class=n>dep</span><span class=p>[</span><span class=n>u</span><span class=p>]</span><span class=o>&gt;</span><span class=n>dep</span><span class=p>[</span><span class=n>v</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=n>u</span><span class=o>=</span><span class=n>p</span><span class=p>[</span><span class=n>u</span><span class=p>][</span><span class=n>lg</span><span class=p>[</span><span class=n>dep</span><span class=p>[</span><span class=n>u</span><span class=p>]</span><span class=o>-</span><span class=n>dep</span><span class=p>[</span><span class=n>v</span><span class=p>]]</span><span class=o>-</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=n>u</span><span class=o>==</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>u</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>k</span><span class=o>=</span><span class=n>lg</span><span class=p>[</span><span class=n>dep</span><span class=p>[</span><span class=n>u</span><span class=p>]];</span><span class=n>k</span><span class=o>&gt;=</span><span class=mi>0</span><span class=p>;</span><span class=n>k</span><span class=o>--</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>p</span><span class=p>[</span><span class=n>u</span><span class=p>][</span><span class=n>k</span><span class=p>]</span><span class=o>!=</span><span class=n>p</span><span class=p>[</span><span class=n>v</span><span class=p>][</span><span class=n>k</span><span class=p>])</span>
</span></span><span class=line><span class=cl>			<span class=n>u</span><span class=o>=</span><span class=n>p</span><span class=p>[</span><span class=n>u</span><span class=p>][</span><span class=n>k</span><span class=p>],</span><span class=n>v</span><span class=o>=</span><span class=n>p</span><span class=p>[</span><span class=n>v</span><span class=p>][</span><span class=n>k</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>p</span><span class=p>[</span><span class=n>u</span><span class=p>][</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>n</span><span class=p>,</span><span class=o>&amp;</span><span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>Init_lg</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=n>Init_belong</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>n</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>col</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>n</span><span class=o>-</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>u</span><span class=p>,</span><span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>u</span><span class=p>,</span><span class=o>&amp;</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>G</span><span class=p>[</span><span class=n>u</span><span class=p>].</span><span class=n>pb</span><span class=p>(</span><span class=n>v</span><span class=p>),</span><span class=n>G</span><span class=p>[</span><span class=n>v</span><span class=p>].</span><span class=n>pb</span><span class=p>(</span><span class=n>u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>Dfs0</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>m</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>u</span><span class=p>,</span><span class=n>v</span><span class=p>,</span><span class=n>ql</span><span class=p>,</span><span class=n>qr</span><span class=p>,</span><span class=n>id_lca</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>u</span><span class=p>,</span><span class=o>&amp;</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>st</span><span class=p>[</span><span class=n>u</span><span class=p>]</span><span class=o>&gt;</span><span class=n>st</span><span class=p>[</span><span class=n>v</span><span class=p>])</span> <span class=n>swap</span><span class=p>(</span><span class=n>st</span><span class=p>[</span><span class=n>u</span><span class=p>],</span><span class=n>st</span><span class=p>[</span><span class=n>v</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>fa</span><span class=o>=</span><span class=n>lca</span><span class=p>(</span><span class=n>u</span><span class=p>,</span><span class=n>v</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>fa</span><span class=o>==</span><span class=n>u</span><span class=p>)</span> <span class=n>ql</span><span class=o>=</span><span class=n>st</span><span class=p>[</span><span class=n>u</span><span class=p>],</span><span class=n>qr</span><span class=o>=</span><span class=n>st</span><span class=p>[</span><span class=n>v</span><span class=p>];</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=n>ql</span><span class=o>=</span><span class=n>ed</span><span class=p>[</span><span class=n>u</span><span class=p>],</span><span class=n>qr</span><span class=o>=</span><span class=n>st</span><span class=p>[</span><span class=n>v</span><span class=p>],</span><span class=n>id_lca</span><span class=o>=</span><span class=n>st</span><span class=p>[</span><span class=n>fa</span><span class=p>];</span> <span class=c1>// 注意这里lca传的编号 
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=p>{</span><span class=n>ql</span><span class=p>,</span><span class=n>qr</span><span class=p>,</span><span class=n>id_lca</span><span class=p>,</span><span class=n>i</span><span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span><span class=n>l</span><span class=o>=</span><span class=n>r</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>sort</span><span class=p>(</span><span class=n>Q</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=n>Q</span><span class=o>+</span><span class=n>m</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>m</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>ql</span><span class=o>=</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>l</span><span class=p>,</span><span class=n>qr</span><span class=o>=</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>ql</span><span class=o>&gt;</span><span class=n>l</span><span class=p>)</span> <span class=n>Change</span><span class=p>(</span><span class=n>l</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>ql</span><span class=o>&lt;</span><span class=n>l</span><span class=p>)</span> <span class=n>Change</span><span class=p>(</span><span class=o>--</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>qr</span><span class=o>&gt;</span><span class=n>r</span><span class=p>)</span> <span class=n>Change</span><span class=p>(</span><span class=o>++</span><span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>qr</span><span class=o>&lt;</span><span class=n>r</span><span class=p>)</span> <span class=n>Change</span><span class=p>(</span><span class=n>r</span><span class=o>--</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>lca</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>Change</span><span class=p>(</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>lca</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>ans</span><span class=p>[</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>id</span><span class=p>]</span><span class=o>=</span><span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>lca</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>Change</span><span class=p>(</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>lca</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>m</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>ans</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=莫队基础板子><a class=header-anchor href=#%e8%8e%ab%e9%98%9f%e5%9f%ba%e7%a1%80%e6%9d%bf%e5%ad%90></a>莫队基础板子</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#include&lt;bits/stdc++.h&gt;
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>std</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=kt>int</span> <span class=n>MAXN</span><span class=o>=</span><span class=kt>int</span><span class=p>(</span><span class=mf>1e6</span><span class=o>+</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>n</span><span class=p>,</span><span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>a</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>cnt</span><span class=p>[</span><span class=n>MAXN</span><span class=p>],</span><span class=n>ans</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>l</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>belong</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=nc>query</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>l</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	bool operator &lt; (const query &amp;w) const {
</span></span></span><span class=line><span class=cl><span class=cm>		return (l!=w.l)?l&lt;w.l:r&lt;w.r;
</span></span></span><span class=line><span class=cl><span class=cm>	}
</span></span></span><span class=line><span class=cl><span class=cm>	*/</span>
</span></span><span class=line><span class=cl>	<span class=kt>bool</span> <span class=k>operator</span> <span class=o>&lt;</span> <span class=p>(</span><span class=k>const</span> <span class=n>query</span> <span class=o>&amp;</span><span class=n>w</span><span class=p>)</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=p>(</span><span class=n>l</span><span class=o>^</span><span class=n>w</span><span class=p>.</span><span class=n>l</span><span class=p>)</span><span class=o>?</span><span class=n>l</span><span class=o>&lt;</span><span class=n>w</span><span class=p>.</span><span class=nl>l</span><span class=p>:(</span><span class=n>l</span><span class=o>&amp;</span><span class=mi>1</span><span class=p>)</span><span class=o>?</span><span class=n>r</span><span class=o>&lt;</span><span class=n>w</span><span class=p>.</span><span class=nl>r</span><span class=p>:</span><span class=n>r</span><span class=o>&gt;</span><span class=n>w</span><span class=p>.</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=n>Q</span><span class=p>[</span><span class=n>MAXN</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Init_belong</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>size</span><span class=o>=</span><span class=n>sqrt</span><span class=p>(</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>bnum</span><span class=o>=</span><span class=n>ceil</span><span class=p>((</span><span class=kt>double</span><span class=p>)</span><span class=n>n</span><span class=o>/</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>bnum</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>j</span><span class=o>=</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=n>size</span><span class=o>+</span><span class=mi>1</span><span class=p>;</span><span class=n>j</span><span class=o>&lt;=</span><span class=n>i</span><span class=o>*</span><span class=n>size</span><span class=o>&amp;&amp;</span><span class=n>j</span><span class=o>&lt;</span><span class=n>MAXN</span><span class=p>;</span><span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>belong</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Add</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>sum</span><span class=o>+=</span><span class=p>(</span><span class=o>!</span><span class=n>cnt</span><span class=p>[</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]]);</span>
</span></span><span class=line><span class=cl>	<span class=n>cnt</span><span class=p>[</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Del</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>cnt</span><span class=p>[</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]]</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>sum</span><span class=o>-=</span><span class=p>(</span><span class=o>!</span><span class=n>cnt</span><span class=p>[</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=n>Init_belong</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>n</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>	<span class=n>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span><span class=n>l</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span><span class=n>r</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>m</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>ql</span><span class=p>,</span><span class=n>qr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=n>scanf</span><span class=p>(</span><span class=s>&#34;%d%d&#34;</span><span class=p>,</span><span class=o>&amp;</span><span class=n>ql</span><span class=p>,</span><span class=o>&amp;</span><span class=n>qr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=p>{</span><span class=n>ql</span><span class=p>,</span><span class=n>qr</span><span class=p>,</span><span class=n>i</span><span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=n>sort</span><span class=p>(</span><span class=n>Q</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=n>Q</span><span class=o>+</span><span class=n>m</span><span class=o>+</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>m</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>ql</span><span class=o>=</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>l</span><span class=p>,</span><span class=n>qr</span><span class=o>=</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>ql</span><span class=o>&gt;</span><span class=n>l</span><span class=p>)</span> <span class=n>Del</span><span class=p>(</span><span class=n>l</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>ql</span><span class=o>&lt;</span><span class=n>l</span><span class=p>)</span> <span class=n>Add</span><span class=p>(</span><span class=o>--</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>qr</span><span class=o>&gt;</span><span class=n>r</span><span class=p>)</span> <span class=n>Add</span><span class=p>(</span><span class=o>++</span><span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=n>qr</span><span class=o>&lt;</span><span class=n>r</span><span class=p>)</span> <span class=n>Del</span><span class=p>(</span><span class=n>r</span><span class=o>--</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=n>ans</span><span class=p>[</span><span class=n>Q</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>id</span><span class=p>]</span><span class=o>=</span><span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=n>i</span><span class=o>&lt;=</span><span class=n>m</span><span class=p>;</span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>printf</span><span class=p>(</span><span class=s>&#34;%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>ans</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><footer class=article-footer><ul class=article-tag-list itemprop=keywords><li class=article-tag-list-item data-aos=zoom-in><a class=article-tag-list-link href=/tags/acm rel=tag>ACM</a></li><li class=article-tag-list-item data-aos=zoom-in><a class=article-tag-list-link href=/tags/%e6%a8%a1%e6%9d%bf rel=tag>模板</a></li></ul></footer></div><nav id=article-nav aria-label="Article navigation" data-aos=fade-up><div class="article-nav-link-wrap left"><img data-src=https://jsd.hidict.cn/gh/Satori5ama/graygoo-picture@master/webp/00029.webp data-sizes=auto alt="重生之我学操作系统——第31章 信号量" class=lazyload><a href=/post/note-os-31-semaphore/ aria-label="Prev:重生之我学操作系统——第31章 信号量" title="Prev:重生之我学操作系统——第31章 信号量"></a><div class=article-nav-caption>Prev</div><h3 class=article-nav-title>重生之我学操作系统——第31章 信号量</h3></div><div class="article-nav-link-wrap right"><img data-src=https://jsd.hidict.cn/gh/Satori5ama/graygoo-picture@master/webp/00014.webp data-sizes=auto alt=END class=lazyload><a href=/post/end/ aria-label=Next:END title=Next:END></a><div class=article-nav-caption>Next</div><h3 class=article-nav-title>END</h3></div></nav></article><section id=comments data-aos=fade-up><div class=comment-header><h2 class=comment-title>Leave a comment</h2><div class=comment-selector><div class=comment-selector-wrap><div class=selector-item data-selector=giscus><span>giscus</span></div></div></div></div><div class=comment-content><div class="comment giscus-comment" data-aos=fade-up></div></div></section></section></div><footer id=footer aria-label="Site footer"><div style=width:100%;overflow:hidden><div class=footer-line></div></div><div id=footer-info><div><span class=icon-copyright></span>2023-2025<span class="footer-info-sep rotate"></span>
Satori5ama</div><div>Powered by&nbsp;<a href=https://gohugo.io/ target=_blank rel="noopener nofollow noreferrer">Hugo</a>&nbsp; Theme.<a href=https://github.com/D-Sketon/hugo-theme-reimu target=_blank rel="noopener nofollow noreferrer">Reimu</a></div><div><span class=icon-brush>&nbsp;137.4k</span>
&nbsp;|&nbsp;
<span class=icon-coffee>&nbsp;05:17</span></div><div class=footer-beian><img style=object-fit:contain;margin-right:2px src=https://icp.gov.moe/images/ico64.png alt width=24 height=24>
<a target=_blank rel="noopener nofollow noreferrer" href="https://icp.gov.moe/?keyword=20239514">萌ICP备20239514号</a></div><div><span class=icon-eye></span>
<span id=busuanzi_container_site_pv>Number of visits&nbsp;<span id=busuanzi_value_site_pv></span></span>
&nbsp;|&nbsp;
<span class=icon-user></span>
<span id=busuanzi_container_site_uv>Number of visitors&nbsp;<span id=busuanzi_value_site_uv></span></span></div></div></footer><div class=sidebar-top><div class="sidebar-top-taichi rotate"></div><div class=arrow-up></div></div><div id=mask class=hide></div></div><nav id=mobile-nav aria-label="Mobile navigation"><div class=sidebar-wrap><div class=sidebar-toc-sidebar><h3 class=toc-title>Contents</h3><div class="sidebar-toc-wrapper toc-div-class"><nav id=TableOfContents><ul><li><a href=#计算几何>计算几何</a><ul><li><a href=#线段平行>线段平行</a></li><li><a href=#线段共线>线段共线</a></li><li><a href=#判断一个点在线段的哪边>判断一个点在线段的哪边</a></li><li><a href=#线段相交>线段相交</a></li><li><a href=#线段交点>线段交点</a></li><li><a href=#向量旋转>向量旋转</a></li><li><a href=#三角剖分求面积>三角剖分求面积</a></li><li><a href=#凸包>凸包</a></li><li><a href=#eps误差处理>eps误差处理</a></li><li><a href=#旋转卡壳>旋转卡壳</a></li><li><a href=#自适应辛普森法>自适应辛普森法</a></li></ul></li><li><a href=#图论>图论</a><ul><li><a href=#最大流>最大流</a></li><li><a href=#费用流>费用流</a></li><li><a href=#二分图匹配>二分图匹配</a></li><li><a href=#2-sat>2-SAT</a></li><li><a href=#缩点>缩点</a></li><li><a href=#普通环计数>普通环计数</a></li><li><a href=#三元环计数>三元环计数</a></li><li><a href=#四元环计数>四元环计数</a></li><li><a href=#lca>LCA</a></li><li><a href=#树的直径>树的直径</a></li><li><a href=#树的中心>树的中心</a></li><li><a href=#树的重心>树的重心</a></li><li><a href=#树链剖分>树链剖分</a></li><li><a href=#dsu-on-tree>dsu on tree</a></li></ul></li><li><a href=#数论>数论</a><ul><li><a href=#线性筛>线性筛</a></li><li><a href=#数论分块>数论分块</a></li><li><a href=#extgcd>extgcd</a></li><li><a href=#crt>CRT</a></li><li><a href=#miller-rabin>Miller Rabin</a></li><li><a href=#pollard_rho>Pollard_Rho</a></li><li><a href=#威尔逊定理>威尔逊定理</a></li><li><a href=#lucas定理>Lucas定理</a></li><li><a href=#exbsgs>exBSGS</a></li><li><a href=#线性基>线性基</a></li><li><a href=#高斯消元>高斯消元</a></li><li><a href=#博弈论>博弈论</a></li></ul></li><li><a href=#字符串>字符串</a><ul><li><a href=#双值hash>双值hash</a></li><li><a href=#kmp>KMP</a></li><li><a href=#ac自动机>AC自动机</a></li><li><a href=#最小表示法>最小表示法</a></li><li><a href=#manacher>Manacher</a></li></ul></li><li><a href=#misc>Misc</a><ul><li><a href=#线段树分治>线段树分治</a></li><li><a href=#莫队>莫队</a></li><li><a href=#lct>LCT</a></li><li><a href=#珂朵莉树>珂朵莉树</a></li><li><a href=#三维偏序>三维偏序</a></li><li><a href=#cdq>CDQ</a></li><li><a href=#整体二分>整体二分</a></li></ul></li><li><a href=#附录>附录</a><ul><li><a href=#at1219>AT1219</a></li><li><a href=#luogu_1903>luogu_1903</a></li><li><a href=#luogu_sp10707>luogu_sp10707</a></li><li><a href=#莫队基础板子>莫队基础板子</a></li></ul></li></ul></nav></div></div><div class="sidebar-common-sidebar hidden"><div class=sidebar-author><img data-src=/avatar/avatar.webp data-sizes=auto alt=Satori5ama class=lazyload><div class=sidebar-author-name>Satori5ama</div><div class=sidebar-description>我们称之为路的，其实不过是彷徨。</div></div><div class=sidebar-state><div class=sidebar-state-article><div>Posts</div><div class=sidebar-state-number>80</div></div><a class=sidebar-state-category href=/categories/ aria-label=sidebar-state-category-link><div>Categories</div><div class=sidebar-state-number>7</div></a><a class=sidebar-state-tag href=/tags/ aria-label=sidebar-state-tag-link><div>Tags</div><div class=sidebar-state-number>26</div></a></div><div class=sidebar-social><div class="icon-github sidebar-social-icon"><a href=https://github.com/Satori5ama itemprop=url target=_blank aria-label=github rel="noopener nofollow noreferrer"></a></div></div><div class=sidebar-menu><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/ aria-label=Home></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>Home</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/archives aria-label=Archives></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>Archives</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/about aria-label=About></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>About</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/friend aria-label=Friend></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>Friend</div></div></div></div></div><div class=sidebar-btn-wrapper><div class="sidebar-toc-btn current"></div><div class=sidebar-common-btn></div></div></nav></div><script src=https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js integrity=sha384-3gT/vsepWkfz/ff7PpWNUeMzeWoH3cDhm/A8jM7ouoAK0/fP/9bcHHR5kHq2nf+e crossorigin=anonymous></script><script src=https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js integrity=sha384-J08i8An/QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q crossorigin=anonymous></script><script src=/js/main.js integrity crossorigin=anonymous></script><script src=/js/aos.js integrity crossorigin=anonymous></script><script>var aosInit=()=>{AOS.init({duration:1e3,easing:"ease",once:!0,offset:50})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",aosInit):aosInit()</script><script src=/js/pjax_main.js integrity crossorigin=anonymous data-pjax></script><script src=https://npm.webcache.cn/mouse-firework@0.1.1/dist/index.umd.js integrity=sha384-8LyaidD9GPxQQgLJO/WRw/O2h3BoNq/ApI/ecpvM6RsrCz2qP2ppBXUKihP4V/2d crossorigin=anonymous></script><script>if((!!1||!window.matchMedia("(max-width: 768px)").matches)&&window.firework){const e=JSON.parse('{"excludeelements":["a","button"],"particles":[{"colors":["var(--red-1)","var(--red-2)","var(--red-3)","var(--red-4)"],"duration":[1200,1800],"easing":"easeOutExpo","move":["emit"],"number":20,"shape":"circle","shapeOptions":{"alpha":[0.3,0.5],"radius":[16,32]}},{"colors":["var(--red-0)"],"duration":[1200,1800],"easing":"easeOutExpo","move":["diffuse"],"number":1,"shape":"circle","shapeOptions":{"alpha":[0.2,0.5],"lineWidth":6,"radius":20}}]}');e.excludeElements=e.excludeelements,delete e.excludeelements,window.firework(e)}</script><div id=lazy-script><div><script data-pjax>window.REIMU_POST={author:"Satori5ama",title:"板子合集（自用）",url:"https://username.github.io/post/template-collection/",description:` 计算几何 线段平行 设线段端点分别为$P_1,P_2$和$P_3,P_4$
则
$$\\overrightarrow{P_1 P_2} \\times \\overrightarrow{P_3 P_4} = 0$$ 线段共线 设线段端点分别为$P_1,P_2$和$P_3,P_4$
`,cover:"https://username.github.io/images/ST.webp"}</script><script src=/js/insert_highlight.js integrity crossorigin=anonymous data-pjax></script><script type=module data-pjax>const PhotoSwipeLightbox = (await safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe-lightbox.esm.min.js", "sha384-DiL6M\/gG\u002bwmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF\/N6lrZi\/")).default;const initPswp = (gallery, children) => {
          if (_$$(`${gallery} ${children}`).length > 0) {
            new PhotoSwipeLightbox({
              gallery,
              children,pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")}).init();
          }
        }
        const pswp = () => {
          initPswp('.article-entry', 'a.article-gallery-item');
          initPswp('.article-gallery', 'a.article-gallery-item');
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script><script data-pjax>var defaultComment,savedCommentType,configDefault,loadScript=(e,t)=>{const n=document.createElement("script");return n.src=e,t&&(n.integrity=t),n.crossOrigin="anonymous",n},commentConfigKeys=["valine","waline","twikoo","gitalk","giscus"],commentConfig={giscus:{enable:!0,load:()=>{const t=document.querySelector(".giscus-comment");if(!t)return;t.style.display="block";const s=t.querySelector('script[src*="giscus.app/client.js"]');s&&s.remove();const o=document.querySelector("iframe.giscus-frame");o&&o.remove();const e=document.createElement("script"),r=document.documentElement.getAttribute("data-theme"),n=document.documentElement.lang||"en",i=n.split("-")[0],a=["ar","be","bg","ca","cs","da","de","en","eo","es","eu","fa","fr","gr","hbs","he","hu","id","it","ja","kh","ko","nl","pl","pt","ro","ru","th","tr","uk","uz","vi","zh-CN","zh-HK","zh-TW"],c=a.includes(n)?n:a.includes(i)?i:"en";e.src="https://giscus.app/client.js",e.setAttribute("data-repo","Satori5ama/Blog-Comment"),e.setAttribute("data-repo-id","R_kgDOKkUUoQ"),e.setAttribute("data-category","Announcements"),e.setAttribute("data-category-id","DIC_kwDOKkUUoc4CaZMl"),e.setAttribute("data-mapping","0"),e.setAttribute("data-strict","0"),e.setAttribute("data-reactions-enabled","1"),e.setAttribute("data-emit-metadata","0"),e.setAttribute("data-input-position","bottom"),e.setAttribute("data-theme",r==="dark"?"dark":"light"),e.setAttribute("data-lang",c),e.setAttribute("crossorigin","anonymous"),e.async=!0,t.appendChild(e),document.body.addEventListener("light-theme-set",()=>{const e=document.querySelector("iframe.giscus-frame");if(!e)return;e.contentWindow.postMessage({giscus:{setConfig:{theme:"light"}}},"https://giscus.app")}),document.body.addEventListener("dark-theme-set",()=>{const e=document.querySelector("iframe.giscus-frame");if(!e)return;e.contentWindow.postMessage({giscus:{setConfig:{theme:"dark"}}},"https://giscus.app")})}}};commentConfig.enable=commentConfigKeys.some(e=>commentConfig?.[e]?.enable),defaultComment="",commentConfig.enable&&(savedCommentType=localStorage.getItem("commentType"),savedCommentType&&commentConfig[savedCommentType]?.enable&&(defaultComment=savedCommentType),defaultComment||(configDefault="waline",commentConfig[configDefault]?.enable&&(defaultComment=configDefault)),defaultComment||(defaultComment=commentConfigKeys.find(e=>commentConfig?.[e]?.enable)||""));function loadComments(){if(!commentConfig.enable)return;const e={valine:!1,waline:!1,twikoo:!1,gitalk:!1,giscus:!1},s=()=>{const e=document.querySelectorAll(".comment");e.forEach(e=>{e.style.display="none"})},t=t=>{if(e[t]){document.querySelector(`.${t}-comment`).style.display="block";return}commentConfig[t]?.load(),e[t]=!0},o=e=>{const n=document.querySelectorAll(".selector-item");for(let e=0;e<n.length;e++)n[e].classList.remove("active");e.classList.add("active");const o=e.getAttribute("data-selector");s(),t(o)},n=()=>{const e=document.querySelectorAll(".selector-item");for(let t of e)t.addEventListener("click",()=>{const e=t.getAttribute("data-selector");window.localStorage.setItem("commentType",e),o(t)});if(defaultComment){const e=document.querySelector(`[data-selector="${defaultComment}"]`);if(!e)return;e.style.display="block",e.classList.add("active"),t(defaultComment)}};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",n):n()}loadComments()</script><script data-pjax>window.MathJax=JSON.parse('[{"loader":{"load":["input/asciimath","[tex]/noerrors"]},"options":{"ignoreHtmlClass":"tex2jax_ignore","processHtmlClass":"tex2jax_process","skipHtmlTags":["script","noscript","style","textarea","pre","code"]},"tex":{"autoload":{"color":[],"colorv2":["color"]},"displayMath":[["$$","$$"],["\\\\\\\\[","\\\\\\\\]"]],"inlineMath":[["$","$"],["\\\\\\\\(","\\\\\\\\)"]],"packages":{"[+]":["noerrors"]},"processEnvironments":true,"processEscapes":true,"tags":"ams","useLabelIds":true}}]')[0]</script><script src=https://npm.webcache.cn/mathjax@3.2.2/es5/tex-mml-chtml.js deferdata-pjaxintegrity=sha384-Wuix6BuhrWbjDBs24bXrjf4ZQ5aFeFWBuKkFekO2t8xFU0iNaLQfp2K6/1Nxveei crossorigin=anonymous></script></div></div><script src=https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js asyncintegrity=sha384-0M75wtSkhjIInv4coYlaJU83+OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id+S crossorigin=anonymous></script><script>"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(e=>{for(let t of e)t.unregister()})</script><script>const reimuCopyright=String.raw`
   ______     ______     __     __    __     __  __    
  /\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
  \ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
   \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
    \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                    
  `;console.log(String.raw`%c ${reimuCopyright}`,"color: #ff5252;"),console.log("%c Theme.Reimu %c https://github.com/D-Sketon/hugo-theme-reimu ","color: white; background: #ff5252; padding:5px 0;","padding:4px;border:1px solid #ff5252;")</script></body></html>